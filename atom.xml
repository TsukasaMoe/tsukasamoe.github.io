<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Tsukasa の 部屋</title>
  
  <subtitle>本当に萌え萌えだぜ</subtitle>
  <link href="http://blog.tsukasa.moe/atom.xml" rel="self"/>
  
  <link href="http://blog.tsukasa.moe/"/>
  <updated>2023-11-15T12:51:24.031Z</updated>
  <id>http://blog.tsukasa.moe/</id>
  
  <author>
    <name>Tsukasa</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Spring项目的HTTP客户端工具RestTemplate</title>
    <link href="http://blog.tsukasa.moe/2023/11/10/RestTemplate-learning/"/>
    <id>http://blog.tsukasa.moe/2023/11/10/RestTemplate-learning/</id>
    <published>2023-11-10T10:31:03.000Z</published>
    <updated>2023-11-15T12:51:24.031Z</updated>
    
    <content type="html"><![CDATA[<!-- excerpt --><!-- toc --><p>文章详细内容</p><p>1, java 9+ 自带 httpclient(我比较喜欢这种链式调用的,但是 java8 没有)</p><p>2, apache 原生 httpclient</p><p>3, 封装过的 apache httpclient</p><p>4, OkHttp</p><p>5, Feign</p><p>6, RestTemplate</p><p>7, Retrofit</p><p>jsoup<br>webclient<br>RxJava<br>EasyOKHttp<br>Unirest<br>okhttp+retrofit+rxjava </p><p>请求和资源的转发是指在一个过滤器中，通过调用 RequestDispatcher 的 forward 方法将请求和响应传递给其他资源（例如，另一个 Servlet 或 JSP 页面）。这个转发的过程可能导致过滤器链的其他过滤器再次被调用，从而可能引起一些逻辑的多次执行。继承 OncePerRequestFilter 主要是为了应对过滤器链中的多次调用问题</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExampleFilter</span> <span class="keyword">extends</span> <span class="title class_">OncePerRequestFilter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doFilterInternal</span><span class="params">(</span></span><br><span class="line"><span class="params">            HttpServletRequest request,</span></span><br><span class="line"><span class="params">            HttpServletResponse response,</span></span><br><span class="line"><span class="params">            FilterChain filterChain)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 在这里添加你的自定义逻辑</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 执行请求和资源的转发</span></span><br><span class="line">        <span class="type">RequestDispatcher</span> <span class="variable">dispatcher</span> <span class="operator">=</span> request.getRequestDispatcher(<span class="string">&quot;/someResource&quot;</span>);</span><br><span class="line">        dispatcher.forward(request, response);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 这里的逻辑将不会被重复执行</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>OpenSSL生成自签名证书</p><h1 id="1、生成自签名CA（Self-signed-CA）来签发证书"><a href="#1、生成自签名CA（Self-signed-CA）来签发证书" class="headerlink" title="1、生成自签名CA（Self-signed CA）来签发证书"></a>1、生成自签名CA（Self-signed CA）来签发证书</h1><blockquote><p>更新了openssh，安装Java环境（确保JDK中的keytool可用）后，使用这个虚拟机作为自签名CA来签发Cert </p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl req -x509 -sha256 -days 3650 -newkey rsa:4096 -keyout rootCA.key -out rootCA.crt</span><br></pre></td></tr></table></figure><h1 id="2、生成凭证签发请求CSR（Certificate-Signing-Request）"><a href="#2、生成凭证签发请求CSR（Certificate-Signing-Request）" class="headerlink" title="2、生成凭证签发请求CSR（Certificate Signing Request）"></a>2、生成凭证签发请求CSR（Certificate Signing Request）</h1><blockquote><p>站点在向全文机构申请证书前准备的自己的资料（包含公钥但不应当包含私钥）。CA基于CSR签发证书（Cert） 。</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl req -new -newkey rsa:4096 -keyout localhost.key -out localhost.csr</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202311141709768.png" alt=""></p><h1 id="4、使用Self-signed-CA签发localhost证书"><a href="#4、使用Self-signed-CA签发localhost证书" class="headerlink" title="4、使用Self-signed CA签发localhost证书"></a>4、使用Self-signed CA签发localhost证书</h1><h2 id="（1）获得-Cert-所需的其它信息"><a href="#（1）获得-Cert-所需的其它信息" class="headerlink" title="（1）获得 Cert 所需的其它信息"></a>（1）获得 Cert 所需的其它信息</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; localhost.ext &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">authorityKeyIdentifier=keyid,issuer</span></span><br><span class="line"><span class="string">basicConstraints=CA:FALSE</span></span><br><span class="line"><span class="string">subjectAltName = @alt_names</span></span><br><span class="line"><span class="string">[alt_names]</span></span><br><span class="line"><span class="string">IP.1 = 192.168.2.99</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><h2 id="（2）使用-Self-signed-CA-签发-localhost-证书"><a href="#（2）使用-Self-signed-CA-签发-localhost-证书" class="headerlink" title="（2）使用 Self-signed CA 签发 localhost 证书"></a>（2）使用 Self-signed CA 签发 localhost 证书</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">openssl x509 -req -CA rootCA.crt -CAkey rootCA.key -in localhost.csr -out localhost.crt -days 365 -CAcreateserial -extfile localhost.ext</span><br><span class="line"></span><br></pre></td></tr></table></figure><h1 id="SSL-TLS证书相关的一些概念"><a href="#SSL-TLS证书相关的一些概念" class="headerlink" title="SSL/TLS证书相关的一些概念"></a>SSL/TLS证书相关的一些概念</h1><p>KeyManager：管理本地密钥库中的密钥（私钥），用于配置SSL/TLS握手中的客户端证书，使其能够进行双向SSL/TLS认证。<br>keyPassword：访问客户端证书的私钥的密码。通常通过非对称加密算法生成密钥对，为了保护私钥，通常会设置一个密码。<br>KeyStore：用于存储密钥和证书的容器，既可以包含客户端证书和私钥（由KeyManager使用），也可以包含信任的服务器证书（由TrustManager使用）。<br>TrustManager：配置信任的证书，用于验证服务器的身份。<br>TrustStrategy：一个策略接口，用于定义是否信任远程服务器的证书。可以自定义信任策略，例如接受所有证书、仅接受特定颁发机构的证书等</p><blockquote><p>声明：本站所有文章均为原创或翻译，遵循<a href="https://creativecommons.org/licenses/by-nc-nd/4.0/deed.en">署名 - 非商业性使用 - 禁止演绎 4.0 国际许可协议</a>，如需转载请确保您对该协议有足够了解，并附上作者名 (Tsukasa) 及原文地址</p></blockquote>]]></content>
    
    
    <summary type="html">&lt;script src=&quot;&#92;assets&#92;js&#92;APlayer.min.js&quot;&gt; &lt;/script&gt;&lt;p&gt;文章摘要&lt;/p&gt;</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>Spring项目统一响应格式设计和全局异常处理</title>
    <link href="http://blog.tsukasa.moe/2023/10/31/Spring-global-exception-handling-and-error-code-design/"/>
    <id>http://blog.tsukasa.moe/2023/10/31/Spring-global-exception-handling-and-error-code-design/</id>
    <published>2023-10-31T09:35:26.000Z</published>
    <updated>2023-11-10T10:17:34.067Z</updated>
    
    <content type="html"><![CDATA[<!-- excerpt --><!-- toc --><p>写一个Spring项目统一响应格式设计和全局异常处理的best-practice，便于后续查阅。</p><h1 id="设计目标"><a href="#设计目标" class="headerlink" title="设计目标"></a>设计目标</h1><p>现在一个良好的web项目，基本采用前后端分离的格式，本次设计目标：</p><ul><li>统一响应格式，可以极大方便前后端研发之间的沟通，简化和统一双方的代码处理。</li><li>全局统一异常处理的好处是消除分散在代码逻辑中异常处理，if分支和try-catch代码块。</li><li>考虑响应码描述的国际化处理，参数替换，支持灵活的配置。</li><li>调用方API层级的报错给出友好、结构化的提示。</li><li>考虑服务端后台依赖的三方业务返回的响应码映射。</li><li>研发使用起来简单，不易犯错。</li></ul><h1 id="实现思路"><a href="#实现思路" class="headerlink" title="实现思路"></a>实现思路</h1><h2 id="统一响应格式"><a href="#统一响应格式" class="headerlink" title="统一响应格式"></a>统一响应格式</h2><p>结合工作经验和借鉴大厂的API定义，设计如下几个类：</p><ul><li>BaseResult：基本响应基类，只包含结果码code, 结果码描述msg，一般地所有的响应子类继承该类型。</li><li>Response：统一响应类，继承自BaseResult（必选），自身包含业务数据data（必选，没有内容时为null），额外数据payload（可选），API层级报错列表errors（可选），Response通过建造者模式构建。</li><li>ResponseCodeInterface：响应码接口，提供三个方法code(), message(), i18nKey()，所有响应码枚举类均实现该接口并重写三个方法，确保新增响应码枚举类型时提供统一的访问入口，面向接口编程。</li><li>ResponseEnum：响应码集合。自身为全局结果码集合，包含所有类型（全局，Internal, External, Business, Client）的响应码列表，三个字段分别为响应码code, 默认响应描述（允许带占位符）msg，响应码描述的国际化配置键i18nKey</li></ul><h2 id="统一异常处理"><a href="#统一异常处理" class="headerlink" title="统一异常处理"></a>统一异常处理</h2><p>将所有异常处理抽出，放到@ControllerAdvice类中的@ExceptionHandler注解的方法中处理，针对不同异常执行不同的处理逻辑。</p><p>代码逻辑可能根据需要会抛出以下异常</p><ul><li>业务异常：ServiceException继承自RuntimeException，业务处理过程中，可以抛出ServiceException退出接下来的业务处理进入到统一异常处理，返回响应给客户端。</li><li>受检异常：业务自身捕获处理，可以封装成ServiceException抛出。</li><li>除业务异常外的非受检异常：仅处理Hiberante validator等可识别的异常，封装到List<Response.Error>列表中。</li><li>其他未知异常：Throwable统一设置业务内部异常。</li></ul><p>附Java异常体系，忘记时可以查阅。<br><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202311090200033.png" alt=""></p><p>国际化：</p><ul><li>封装Spring I18N的messageSource到MessageUtils，提供国际化处理方法。</li><li>针对API层级的报错，通过Hibernate Validator组件实现国际化。</li><li>异常流程：创建ServiceException时执行错误描述信息国际化。</li><li>正常处理：Response.ResponseBuilder构造方法执行结果码描述国际化。</li></ul><h1 id="响应示例"><a href="#响应示例" class="headerlink" title="响应示例"></a>响应示例</h1><p>code和message</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 正常响应1：</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;msg&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Success&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;data&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;orderId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ALIPAY0001000000000001&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="string">&quot;COMPLETED&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;amount&quot;</span><span class="punctuation">:</span> <span class="string">&quot;100.00&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;payload&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;external_ext&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;10001&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;test&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 正常响应2</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span><span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;msg&quot;</span><span class="punctuation">:</span><span class="string">&quot;Success&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;data&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">null</span></span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 报错响应1</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span><span class="number">4001</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;msg&quot;</span><span class="punctuation">:</span><span class="string">&quot;Failed&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;data&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;errors&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;bankNo&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span><span class="string">&quot;银行卡号不符合规范&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h1 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h1><p>结果码枚举增删改：ResponseEnum负责管理，所有返回给调用方的响应码均要在这里定义。</p><ul><li>业务流程处理成功：<ul><li>Controller层可以直接返回Response.success(data)等封装好的常用响应，也可以通过Response.ResponseBuilder建造者生成响应返回。</li></ul></li><li>业务流程处理失败：<ul><li>直接创建并抛出ServiceException，并把需要传递的数据放入ServiceException的</li><li>非主动抛出的异常，交由@ControllerAdvice处理</li></ul></li></ul><p>扩展点：</p><ul><li>如果需要新增异常类型和处理，可以继承ServiceException，然后在@ControllerAdvice中新增一个@ExceptionHandler注解的方法处理即可，适合细分不同业务子异常处理</li><li>如果需要在返回响应前做一些公共的操作，可以实现ResponseBodyAdvice接口或者继承AbstractMappingJacksonResponseBodyAdvice抽象类来达成。</li><li>对于数据库异常，可以通过AOP切面针对dao层进行处理</li><li>Filter过滤链的异常假如也希望捕获并处理，可以通过实现Filter接口重写doFilter，在catchException中捕获后封装成统一响应格式。</li><li>HandlerExceptionResolver接口 ===&gt; Spring Web MVC</li></ul><h1 id="核心代码实现"><a href="#核心代码实现" class="headerlink" title="核心代码实现"></a>核心代码实现</h1><p>ResponseCodeInterface接口：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ResponseCodeInterface</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 返回响应码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 响应码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">code</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 返回具体的详细错误描述（非国际化信息，可能含有占位符）</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 响应码描述</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">message</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * i18n资源文件的key，value为国际化响应码描述, 详见messages.properties文件</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> key</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">i18nKey</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ResponseCodeEnum响应码集合枚举：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">ResponseCodeEnum</span> <span class="keyword">implements</span> <span class="title class_">ResponseCodeInterface</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 错误码集合</span></span><br><span class="line"><span class="comment">     * ******以下是旧的设计****</span></span><br><span class="line"><span class="comment">     * 1~9999 为保留错误码 或者 常用错误码</span></span><br><span class="line"><span class="comment">     * 10000~19999 为内部错误码</span></span><br><span class="line"><span class="comment">     * 20000~29999 客户端错误码 （客户端异常调用之类的错误）</span></span><br><span class="line"><span class="comment">     * 30000~39999 为第三方错误码 （代码正常，但是第三方异常）</span></span><br><span class="line"><span class="comment">     * 40000~49999 为业务逻辑 错误码 （无异常，代码正常流转，并返回提示给用户）</span></span><br><span class="line"><span class="comment">     * 由于系统内的错误码都是独一无二的，所以错误码应该放在common包集中管理</span></span><br><span class="line"><span class="comment">     * ---------------------------</span></span><br><span class="line"><span class="comment">     * 错误码不一定位数一定要相同。比如腾讯的微信接口错误码的位数就并不相同。按照常理错误码的数量大小应该是：</span></span><br><span class="line"><span class="comment">     * 内部错误码 &lt; 客户端错误码 &lt; 第三方错误码 &lt; 业务错误码</span></span><br><span class="line"><span class="comment">     * 所以我们应该尽可能的把错误码的数量留给业务错误码</span></span><br><span class="line"><span class="comment">     * ---------------------------</span></span><br><span class="line"><span class="comment">     * *******新的设计**********</span></span><br><span class="line"><span class="comment">     * 1~99 为内部错误码（框架本身的错误）</span></span><br><span class="line"><span class="comment">     * 100~999 客户端错误码 （客户端异常调用之类的错误）</span></span><br><span class="line"><span class="comment">     * 1000~9999为第三方错误码 （代码正常，但是第三方异常）</span></span><br><span class="line"><span class="comment">     * 10000~99999 为业务逻辑 错误码 （无异常，代码正常流转，并返回提示给用户）</span></span><br><span class="line"><span class="comment">     * 由于系统内的错误码都是独一无二的，所以错误码应该放在common包集中管理</span></span><br><span class="line"><span class="comment">     * ---------------------------</span></span><br><span class="line"><span class="comment">     * 总体设计就是值越小  错误严重性越高</span></span><br><span class="line"><span class="comment">     * 目前10000~19999是初始系统内嵌功能使用的错误码，后续开发者可以直接使用20000以上的错误码作为业务错误码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    SUCCESS(<span class="number">0</span>, <span class="string">&quot;Success&quot;</span>, <span class="string">&quot;COMMON.SUCCESS&quot;</span>),</span><br><span class="line">    PENDING(<span class="number">1</span>, <span class="string">&quot;In-progress&quot;</span>, <span class="string">&quot;COMMON.PENDING&quot;</span>),</span><br><span class="line">    FAILED(<span class="number">99999</span>, <span class="string">&quot;Failed&quot;</span>, <span class="string">&quot;COMMON.FAILED&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> code;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String message;</span><br><span class="line">    <span class="comment">// 国际化描述的key，value为错误描述（可能含有占位符，占位符由程序上下文传入参数填充）</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String i18nKey;</span><br><span class="line"></span><br><span class="line">    ResponseCodeEnum(<span class="type">int</span> code, String message, String i18nKey) &#123;</span><br><span class="line">        <span class="built_in">this</span>.code = code;</span><br><span class="line">        <span class="built_in">this</span>.message = message;</span><br><span class="line">        <span class="built_in">this</span>.i18nKey = i18nKey;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">code</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">message</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.message;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">i18nKey</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.i18nKey;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 10000~99999 为业务逻辑 错误码 （无代码异常，代码正常流转，并返回提示给用户）</span></span><br><span class="line"><span class="comment">     * 1XX01   XX是代表模块的意思 比如10101   01是Permission模块</span></span><br><span class="line"><span class="comment">     * 错误码的命名最好以模块为开头  比如  NOT_ALLOWED_TO_OPERATE前面加上PERMISSION = PERMISSION_NOT_ALLOWED_TO_OPERATE</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">Business</span> <span class="keyword">implements</span> <span class="title class_">ResponseCodeInterface</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ----------------------------- COMMON --------------------------------------</span></span><br><span class="line"></span><br><span class="line">        COMMON_OBJECT_NOT_FOUND(<span class="number">10001</span>, <span class="string">&quot;找不到ID为 &#123;&#125; 的 &#123;&#125;&quot;</span>, <span class="string">&quot;Business.OBJECT_NOT_FOUND&quot;</span>),</span><br><span class="line"></span><br><span class="line">        COMMON_UNSUPPORTED_OPERATION(<span class="number">10002</span>, <span class="string">&quot;不支持的操作&quot;</span>, <span class="string">&quot;Business.UNSUPPORTED_OPERATION&quot;</span>),</span><br><span class="line"></span><br><span class="line">        COMMON_FILE_NOT_ALLOWED_TO_DOWNLOAD(<span class="number">10003</span>, <span class="string">&quot;文件名称(&#123;&#125;)非法，不允许下载&quot;</span>, <span class="string">&quot;Business.FILE_NOT_ALLOWED_TO_DOWNLOAD&quot;</span>),</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ----------------------------- PERMISSION -----------------------------------</span></span><br><span class="line"></span><br><span class="line">        PERMISSION_FORBIDDEN_TO_MODIFY_ADMIN(<span class="number">10101</span>, <span class="string">&quot;不允许修改管理员的信息&quot;</span>, <span class="string">&quot;Business.FORBIDDEN_TO_MODIFY_ADMIN&quot;</span>),</span><br><span class="line"></span><br><span class="line">        PERMISSION_NOT_ALLOWED_TO_OPERATE(<span class="number">10202</span>, <span class="string">&quot;没有权限进行此操作，请联系管理员&quot;</span>, <span class="string">&quot;Business.NO_PERMISSION_TO_OPERATE&quot;</span>),</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ----------------------------- LOGIN -----------------------------------------</span></span><br><span class="line"></span><br><span class="line">        LOGIN_WRONG_USER_PASSWORD(<span class="number">10201</span>, <span class="string">&quot;用户密码错误，请重新输入&quot;</span>, <span class="string">&quot;Business.LOGIN_WRONG_USER_PASSWORD&quot;</span>),</span><br><span class="line"></span><br><span class="line">        LOGIN_ERROR(<span class="number">10202</span>, <span class="string">&quot;登录失败：&#123;&#125;&quot;</span>, <span class="string">&quot;Business.LOGIN_ERROR&quot;</span>),</span><br><span class="line"></span><br><span class="line">        LOGIN_CAPTCHA_CODE_WRONG(<span class="number">10203</span>, <span class="string">&quot;验证码错误&quot;</span>, <span class="string">&quot;Business.LOGIN_CAPTCHA_CODE_WRONG&quot;</span>),</span><br><span class="line"></span><br><span class="line">        LOGIN_CAPTCHA_CODE_EXPIRE(<span class="number">10204</span>, <span class="string">&quot;验证码过期&quot;</span>, <span class="string">&quot;Business.LOGIN_CAPTCHA_CODE_EXPIRE&quot;</span>),</span><br><span class="line"></span><br><span class="line">        LOGIN_CAPTCHA_CODE_NULL(<span class="number">10205</span>, <span class="string">&quot;验证码为空&quot;</span>, <span class="string">&quot;Business.LOGIN_CAPTCHA_CODE_NULL&quot;</span>),</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ----------------------------- UPLOAD -----------------------------------------</span></span><br><span class="line"></span><br><span class="line">        UPLOAD_FILE_TYPE_NOT_ALLOWED(<span class="number">10401</span>, <span class="string">&quot;不允许上传的文件类型，仅允许：&#123;&#125;&quot;</span>, <span class="string">&quot;Business.UPLOAD_FILE_TYPE_NOT_ALLOWED&quot;</span>),</span><br><span class="line"></span><br><span class="line">        UPLOAD_FILE_NAME_EXCEED_MAX_LENGTH(<span class="number">10402</span>, <span class="string">&quot;文件名长度超过：&#123;&#125; &quot;</span>, <span class="string">&quot;Business.UPLOAD_FILE_NAME_EXCEED_MAX_LENGTH&quot;</span>),</span><br><span class="line"></span><br><span class="line">        UPLOAD_FILE_SIZE_EXCEED_MAX_SIZE(<span class="number">10403</span>, <span class="string">&quot;文件名大小超过：&#123;&#125; MB&quot;</span>, <span class="string">&quot;Business.UPLOAD_FILE_SIZE_EXCEED_MAX_SIZE&quot;</span>),</span><br><span class="line"></span><br><span class="line">        UPLOAD_IMPORT_EXCEL_FAILED(<span class="number">10404</span>, <span class="string">&quot;导入excel失败：&#123;&#125;&quot;</span>, <span class="string">&quot;Business.UPLOAD_IMPORT_EXCEL_FAILED&quot;</span>),</span><br><span class="line"></span><br><span class="line">        UPLOAD_FILE_IS_EMPTY(<span class="number">10405</span>, <span class="string">&quot;上传文件为空&quot;</span>, <span class="string">&quot;Business.UPLOAD_FILE_IS_EMPTY&quot;</span>),</span><br><span class="line"></span><br><span class="line">        UPLOAD_FILE_FAILED(<span class="number">10406</span>, <span class="string">&quot;上传文件失败：&#123;&#125;&quot;</span>, <span class="string">&quot;Business.UPLOAD_FILE_FAILED&quot;</span>),</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ---------------------------------- USER -----------------------------------------------</span></span><br><span class="line"></span><br><span class="line">        USER_NON_EXIST(<span class="number">10501</span>, <span class="string">&quot;登录用户：&#123;&#125; 不存在&quot;</span>, <span class="string">&quot;Business.USER_NON_EXIST&quot;</span>),</span><br><span class="line"></span><br><span class="line">        ;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> code;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String message;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String i18nKey;</span><br><span class="line"></span><br><span class="line">        Business(<span class="type">int</span> code, String message, String i18nKey) &#123;</span><br><span class="line">            Assert.isTrue(code &gt; <span class="number">10000</span> &amp;&amp; code &lt; <span class="number">99999</span>,</span><br><span class="line">                <span class="string">&quot;错误码code值定义失败，Business错误码code值范围在10000~99099之间，请查看ErrorCode.Business类，当前错误码码为&quot;</span> + name());</span><br><span class="line"></span><br><span class="line">            <span class="type">String</span> <span class="variable">errorTypeName</span> <span class="operator">=</span> <span class="built_in">this</span>.getClass().getSimpleName();</span><br><span class="line">            Assert.isTrue(i18nKey != <span class="literal">null</span> &amp;&amp; i18nKey.startsWith(errorTypeName),</span><br><span class="line">                String.format(<span class="string">&quot;错误码i18nKey值定义失败，%s错误码i18nKey值必须以%s开头，当前错误码为%s&quot;</span>, errorTypeName, errorTypeName, name()));</span><br><span class="line">            <span class="built_in">this</span>.code = code;</span><br><span class="line">            <span class="built_in">this</span>.message = message;</span><br><span class="line">            <span class="built_in">this</span>.i18nKey = i18nKey;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">code</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.code;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">message</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.message;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">i18nKey</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> i18nKey;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 1000~9999是外部错误码  比如调用支付失败</span></span><br><span class="line"><span class="comment">     * 需要确认是否要透传三方错误给客户端</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">External</span> <span class="keyword">implements</span> <span class="title class_">ResponseCodeInterface</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 支付宝调用失败</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        FAIL_TO_PAY_ON_ALIPAY(<span class="number">1001</span>, <span class="string">&quot;支付宝调用失败&quot;</span>, <span class="string">&quot;External.FAIL_TO_PAY_ON_ALIPAY&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> code;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String message;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String i18nKey;</span><br><span class="line"></span><br><span class="line">        External(<span class="type">int</span> code, String message, String i18nKey) &#123;</span><br><span class="line">            Assert.isTrue(code &gt; <span class="number">1000</span> &amp;&amp; code &lt; <span class="number">9999</span>,</span><br><span class="line">                <span class="string">&quot;错误码code值定义失败，External错误码code值范围在1000~9999之间，请查看ErrorCode.External类，当前错误码码为&quot;</span> + name());</span><br><span class="line"></span><br><span class="line">            <span class="type">String</span> <span class="variable">errorTypeName</span> <span class="operator">=</span> <span class="built_in">this</span>.getClass().getSimpleName();</span><br><span class="line">            Assert.isTrue(i18nKey != <span class="literal">null</span> &amp;&amp; i18nKey.startsWith(errorTypeName),</span><br><span class="line">                String.format(<span class="string">&quot;错误码i18nKey值定义失败，%s错误码i18nKey值必须以%s开头，当前错误码为%s&quot;</span>, errorTypeName, errorTypeName, name()));</span><br><span class="line">            <span class="built_in">this</span>.code = code;</span><br><span class="line">            <span class="built_in">this</span>.message = message;</span><br><span class="line">            <span class="built_in">this</span>.i18nKey = i18nKey;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">code</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.code;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">message</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.message;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">i18nKey</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.i18nKey;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 100~999是客户端错误码</span></span><br><span class="line"><span class="comment">     * 客户端如 Web+小程序+手机端  调用出错</span></span><br><span class="line"><span class="comment">     * 可能由于参数问题或者授权问题或者调用过去频繁</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">Client</span> <span class="keyword">implements</span> <span class="title class_">ResponseCodeInterface</span> &#123;</span><br><span class="line"></span><br><span class="line">        COMMON_FORBIDDEN_TO_CALL(<span class="number">101</span>, <span class="string">&quot;禁止调用&quot;</span>, <span class="string">&quot;Client.COMMON_FORBIDDEN_TO_CALL&quot;</span>),</span><br><span class="line"></span><br><span class="line">        COMMON_REQUEST_TOO_OFTEN(<span class="number">102</span>, <span class="string">&quot;调用太过频繁&quot;</span>, <span class="string">&quot;Client.COMMON_REQUEST_TOO_OFTEN&quot;</span>),</span><br><span class="line"></span><br><span class="line">        COMMON_REQUEST_PARAMETERS_INVALID(<span class="number">103</span>, <span class="string">&quot;请求参数异常，&#123;0&#125;&quot;</span>, <span class="string">&quot;Client.COMMON_REQUEST_PARAMETERS_INVALID&quot;</span>),</span><br><span class="line"></span><br><span class="line">        COMMON_REQUEST_METHOD_INVALID(<span class="number">104</span>, <span class="string">&quot;请求方式: &#123;&#125; 不支持&quot;</span>, <span class="string">&quot;Client.COMMON_REQUEST_METHOD_INVALID&quot;</span>),</span><br><span class="line"></span><br><span class="line">        COMMON_HTTP_MEDIA_TYPE_NOT_SUPPORTED_ERROR(<span class="number">109</span>, <span class="string">&quot;请求类型：&#123;&#125; 不支持&quot;</span>, <span class="string">&quot;Client.COMMON_HTTP_MEDIA_TYPE_NOT_SUPPORTED_ERROR&quot;</span>),</span><br><span class="line"></span><br><span class="line">        COMMON_REQUEST_RESUBMIT(<span class="number">105</span>, <span class="string">&quot;请求重复提交&quot;</span>, <span class="string">&quot;Client.COMMON_REQUEST_RESUBMIT&quot;</span>),</span><br><span class="line"></span><br><span class="line">        COMMON_NO_AUTHORIZATION(<span class="number">106</span>, <span class="string">&quot;请求接口：&#123;&#125; 失败，用户未授权&quot;</span>, <span class="string">&quot;Client.COMMON_NO_AUTHORIZATION&quot;</span>),</span><br><span class="line"></span><br><span class="line">        INVALID_TOKEN(<span class="number">107</span>, <span class="string">&quot;token异常&quot;</span>, <span class="string">&quot;Client.INVALID_TOKEN&quot;</span>),</span><br><span class="line"></span><br><span class="line">        TOKEN_PROCESS_FAILED(<span class="number">108</span>, <span class="string">&quot;token处理失败：&#123;&#125;&quot;</span>, <span class="string">&quot;Client.TOKEN_PROCESS_FAILED&quot;</span>),</span><br><span class="line"></span><br><span class="line">        ;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> code;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String message;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String i18nKey;</span><br><span class="line"></span><br><span class="line">        Client(<span class="type">int</span> code, String message, String i18nKey) &#123;</span><br><span class="line">            Assert.isTrue(code &gt; <span class="number">100</span> &amp;&amp; code &lt; <span class="number">999</span>,</span><br><span class="line">                <span class="string">&quot;错误码code值定义失败，Client错误码code值范围在100~999之间，请查看ErrorCode.Client类，当前错误码码为&quot;</span> + name());</span><br><span class="line"></span><br><span class="line">            <span class="type">String</span> <span class="variable">errorTypeName</span> <span class="operator">=</span> <span class="built_in">this</span>.getClass().getSimpleName();</span><br><span class="line">            Assert.isTrue(i18nKey != <span class="literal">null</span> &amp;&amp; i18nKey.startsWith(errorTypeName),</span><br><span class="line">                String.format(<span class="string">&quot;错误码i18nKey值定义失败，%s错误码i18nKey值必须以%s开头，当前错误码为%s&quot;</span>, errorTypeName, errorTypeName, name()));</span><br><span class="line">            <span class="built_in">this</span>.code = code;</span><br><span class="line">            <span class="built_in">this</span>.message = message;</span><br><span class="line">            <span class="built_in">this</span>.i18nKey = i18nKey;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">code</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.code;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">message</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.message;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">i18nKey</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.i18nKey;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 0~99是内部错误码  例如 框架内部问题之类的</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">Internal</span> <span class="keyword">implements</span> <span class="title class_">ResponseCodeInterface</span> &#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 内部错误码</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        INVALID_PARAMETER(<span class="number">1</span>, <span class="string">&quot;参数异常：&#123;&#125;&quot;</span>, <span class="string">&quot;Internal.INVALID_PARAMETER&quot;</span>),</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 该错误主要用于返回  未知的异常（大部分是RuntimeException） 程序未能捕获 未能预料的错误</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        INTERNAL_ERROR(<span class="number">2</span>, <span class="string">&quot;系统内部错误：&#123;&#125;&quot;</span>, <span class="string">&quot;Internal.INTERNAL_ERROR&quot;</span>),</span><br><span class="line"></span><br><span class="line">        GET_ENUM_FAILED(<span class="number">3</span>, <span class="string">&quot;获取枚举类型失败, 枚举类：&#123;&#125;&quot;</span>, <span class="string">&quot;Internal.GET_ENUM_FAILED&quot;</span>),</span><br><span class="line"></span><br><span class="line">        GET_CACHE_FAILED(<span class="number">4</span>, <span class="string">&quot;获取缓存失败&quot;</span>, <span class="string">&quot;Internal.GET_CACHE_FAILED&quot;</span>),</span><br><span class="line"></span><br><span class="line">        DB_INTERNAL_ERROR(<span class="number">5</span>, <span class="string">&quot;数据库异常&quot;</span>, <span class="string">&quot;Internal.DB_INTERNAL_ERROR&quot;</span>),</span><br><span class="line"></span><br><span class="line">        LOGIN_CAPTCHA_GENERATE_FAIL(<span class="number">7</span>, <span class="string">&quot;验证码生成失败&quot;</span>, <span class="string">&quot;Internal.LOGIN_CAPTCHA_GENERATE_FAIL&quot;</span>),</span><br><span class="line"></span><br><span class="line">        EXCEL_PROCESS_ERROR(<span class="number">8</span>, <span class="string">&quot;excel处理失败：&#123;&#125;&quot;</span>, <span class="string">&quot;Internal.EXCEL_PROCESS_ERROR&quot;</span>),</span><br><span class="line"></span><br><span class="line">        ;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> code;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String message;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String i18nKey;</span><br><span class="line"></span><br><span class="line">        Internal(<span class="type">int</span> code, String message, String i18nKey) &#123;</span><br><span class="line">            Assert.isTrue(code &lt; <span class="number">100</span>,</span><br><span class="line">                <span class="string">&quot;错误码code值定义失败，Internal错误码code值范围在100~999之间，请查看ErrorCode.Internal类，当前错误码码为&quot;</span> + name());</span><br><span class="line"></span><br><span class="line">            <span class="type">String</span> <span class="variable">errorTypeName</span> <span class="operator">=</span> <span class="built_in">this</span>.getClass().getSimpleName();</span><br><span class="line">            Assert.isTrue(i18nKey != <span class="literal">null</span> &amp;&amp; i18nKey.startsWith(errorTypeName),</span><br><span class="line">                String.format(<span class="string">&quot;错误码i18nKey值定义失败，%s错误码i18nKey值必须以%s开头，当前错误码为%s&quot;</span>, errorTypeName, errorTypeName, name()));</span><br><span class="line">            <span class="built_in">this</span>.code = code;</span><br><span class="line">            <span class="built_in">this</span>.message = message;</span><br><span class="line">            <span class="built_in">this</span>.i18nKey = i18nKey;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">code</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.code;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">message</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.message;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">i18nKey</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.i18nKey;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>业务异常基类ServiceException</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EqualsAndHashCode(callSuper = true)</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@ApiModel(value = &quot;服务基本异常类型&quot;, description = &quot;服务基本异常类型&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ServiceException</span> <span class="keyword">extends</span> <span class="title class_">RuntimeException</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 业务异常的结果码枚举</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Getter</span></span><br><span class="line">    <span class="keyword">protected</span> ResponseCodeInterface responseCode;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 下面2个message，在ServiceException实例化后，都表示替换了占位符的错误描述，一般地，通过getMessage()方法获取最终的错误描述</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> String message;</span><br><span class="line">    <span class="keyword">protected</span> String i18nMessage;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 额外数据，支持扩展</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * 如果某个接口由一些额外的数据，有一些特殊的数据  可以放在这个payload里面</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> Map&lt;String, Object&gt; payload;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * code =&gt; 传入的枚举类的code</span></span><br><span class="line"><span class="comment">     * message =&gt; 传入的枚举类的message，不涉及参数替换，通常为一段无需替换占位符的错误描述</span></span><br><span class="line"><span class="comment">     * i18nMessage =&gt; 传入枚举类的i18nKey字段的国际化信息，在对应的message_$&#123;language&#125;_$&#123;country&#125;.properties中查找该key对应的value</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> responseCode</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ServiceException</span><span class="params">(ResponseCodeInterface responseCode)</span> &#123;</span><br><span class="line">        fillPayload(<span class="literal">null</span>);</span><br><span class="line">        fillResponseCode(responseCode);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * code =&gt; 传入的枚举类的code</span></span><br><span class="line"><span class="comment">     * message =&gt; 替换了参数后的message，枚举类中该字段含有占位符的错误描述</span></span><br><span class="line"><span class="comment">     * i18nMessage =&gt; 替换了参数后的i18nMessage，i18nKey字段的国际化信息含有占位符（也可以不含），会被args参数列表进行替换</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> responseCode</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> args</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ServiceException</span><span class="params">(ResponseCodeInterface responseCode, Object... args)</span> &#123;</span><br><span class="line">        fillPayload(<span class="literal">null</span>);</span><br><span class="line">        fillResponseCode(responseCode, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通常用于包装其他异常为ServiceException的场景</span></span><br><span class="line"><span class="comment">     * 注意：如果是try catch的情况下捕获异常并转为ServiceException的话，一定要填入Throwable e，不然会丢失堆栈信息</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * code =&gt; 传入的枚举类的code</span></span><br><span class="line"><span class="comment">     * message =&gt; 替换了参数后的message，枚举类中该字段含有占位符的错误描述</span></span><br><span class="line"><span class="comment">     * i18nMessage =&gt; 替换了参数后的i18nMessage，i18nKey字段的国际化信息含有占位符（也可以不含），会被args参数列表进行替换</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> e            捕获到的原始异常</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> responseCode 错误码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> args         错误详细信息参数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ServiceException</span><span class="params">(ResponseCodeInterface responseCode, Throwable e, Object... args)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(e);</span><br><span class="line">        fillPayload(<span class="literal">null</span>);</span><br><span class="line">        fillResponseCode(responseCode, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ServiceException</span><span class="params">(ResponseCodeInterface responseCode, Map&lt;String, Object&gt; payload, Object... args)</span> &#123;</span><br><span class="line">        fillPayload(payload);</span><br><span class="line">        fillResponseCode(responseCode, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ServiceException</span><span class="params">(ResponseCodeInterface responseCode, Throwable e, Map&lt;String, Object&gt; payload, Object... args)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(e);</span><br><span class="line">        fillPayload(payload);</span><br><span class="line">        fillResponseCode(responseCode, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">fillPayload</span><span class="params">(Map&lt;String, Object&gt; payload)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.payload = payload;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">fillResponseCode</span><span class="params">(ResponseCodeInterface responseCode, Object... args)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.responseCode = responseCode;</span><br><span class="line">        <span class="comment">// 替换占位符后的默认错误描述</span></span><br><span class="line">        <span class="built_in">this</span>.message = MessageFormatter.arrayFormat(responseCode.message(), args).getMessage();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 替换占位符后的国际化错误描述</span></span><br><span class="line">            <span class="built_in">this</span>.i18nMessage = MessageUtils.message(responseCode.i18nKey(), args);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (BeansException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;MessageUtils not ready, depends on messageSource&quot;</span>, e);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;could not found i18nMessage entry for key: &quot;</span> + responseCode.i18nKey(), e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 下面2个方法均来自Throwable，写法都一样，意味着ServiceException对象返回的都是经过参数替换后的国际化错误描述信息（无占位符可不替换，但如有配置国际化信息仍然展示国际化信息）</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getMessage</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> i18nMessage != <span class="literal">null</span> ? i18nMessage : message;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getLocalizedMessage</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> i18nMessage != <span class="literal">null</span> ? i18nMessage : message;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>全局统一异常处理ExceptionHandlerAdvice类：通过@RestControllerAdvice和@ExceptionHandler实现</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestControllerAdvice</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExceptionHandlerAdvice</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 权限校验异常</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ExceptionHandler(AccessDeniedException.class)</span></span><br><span class="line">    <span class="meta">@ResponseStatus(HttpStatus.UNAUTHORIZED)</span></span><br><span class="line">    <span class="keyword">public</span> Response&lt;?&gt; handleAccessDeniedException(AccessDeniedException e, HttpServletRequest request) &#123;</span><br><span class="line">        log.error(MessageFormat.format(<span class="string">&quot;请求地址 [&#123;0&#125;], 权限校验失败 [&#123;1&#125;]&quot;</span>, request.getRequestURI(), e.getMessage()), e);</span><br><span class="line">        <span class="keyword">return</span> Response.fail(<span class="keyword">new</span> <span class="title class_">ServiceException</span>(ResponseCodeEnum.Business.PERMISSION_NOT_ALLOWED_TO_OPERATE));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 请求方式不支持</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ExceptionHandler(HttpRequestMethodNotSupportedException.class)</span></span><br><span class="line">    <span class="meta">@ResponseStatus(HttpStatus.METHOD_NOT_ALLOWED)</span></span><br><span class="line">    <span class="keyword">public</span> Response&lt;?&gt; handleHttpRequestMethodNotSupported(HttpRequestMethodNotSupportedException e,</span><br><span class="line">                                                           HttpServletRequest request) &#123;</span><br><span class="line"></span><br><span class="line">        log.error(MessageFormat.format(<span class="string">&quot;请求地址 [&#123;0&#125;], 不支持 [&#123;1&#125;] 请求&quot;</span>, request.getRequestURI(), e.getMethod()), e);</span><br><span class="line">        <span class="keyword">return</span> Response.fail(<span class="keyword">new</span> <span class="title class_">ServiceException</span>(ResponseCodeEnum.Client.COMMON_REQUEST_METHOD_INVALID, e.getMethod()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 捕获缓存类当中的错误</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * 需要确认是否要进行捕获</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ExceptionHandler(UncheckedExecutionException.class)</span></span><br><span class="line">    <span class="meta">@ResponseStatus(HttpStatus.INTERNAL_SERVER_ERROR)</span></span><br><span class="line">    <span class="keyword">public</span> Response&lt;?&gt; handleServiceException(UncheckedExecutionException e) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;获取Guava缓存出现异常!&quot;</span>, e);</span><br><span class="line">        <span class="keyword">return</span> Response.fail(<span class="keyword">new</span> <span class="title class_">ServiceException</span>(ResponseCodeEnum.Internal.GET_CACHE_FAILED));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 业务异常（相关错误码枚举、数据等已经完成封装）</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * 由开发者主动抛出该异常，因此异常e包含了ErrorCodeInterface对象（结果码code，结果描述message，国际化描述信息i18nMessage）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ExceptionHandler(ServiceException.class)</span></span><br><span class="line">    <span class="meta">@ResponseStatus(HttpStatus.INTERNAL_SERVER_ERROR)</span></span><br><span class="line">    <span class="keyword">public</span> Response&lt;?&gt; handleServiceException(ServiceException e, HttpServletRequest request) <span class="keyword">throws</span> BindException &#123;</span><br><span class="line">        log.warn(<span class="string">&quot;请求发生了预期异常，出错的 url [&#123;&#125;]，出错的描述为 [&#123;&#125;]&quot;</span>,</span><br><span class="line">                request.getRequestURL().toString(), e.getMessage());</span><br><span class="line">        log.warn(<span class="string">&quot;发生了业务异常：&quot;</span>, e);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Response.fail(e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * BindException、MethodArgumentNotValidException异常处理</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ExceptionHandler(&#123;BindException.class, MethodArgumentNotValidException.class&#125;)</span></span><br><span class="line">    <span class="meta">@ResponseStatus(HttpStatus.BAD_REQUEST)</span></span><br><span class="line">    <span class="keyword">public</span> Response&lt;?&gt; handleBindException(BindException e, HttpServletRequest request) &#123;</span><br><span class="line">        log.error(MessageFormat.format(<span class="string">&quot;请求发生了参数校验异常，出错的 url [&#123;0&#125;]，出错的描述为 [&#123;1&#125;]&quot;</span>,</span><br><span class="line">                request.getRequestURL().toString(), e.getMessage()), e);</span><br><span class="line"></span><br><span class="line">        Response.<span class="type">ResponseBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Response</span>.ResponseBuilder(ResponseCodeEnum.Client.COMMON_REQUEST_PARAMETERS_INVALID);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 对象级别的验证错误，自定义注解校验一个类多个字段的场景</span></span><br><span class="line">        <span class="keyword">for</span> (ObjectError objectError : e.getGlobalErrors()) &#123;</span><br><span class="line">            builder.addError(<span class="keyword">new</span> <span class="title class_">Response</span>.Error(objectError.getObjectName(), objectError.getDefaultMessage()));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 字段级别的验证错误</span></span><br><span class="line">        <span class="keyword">for</span> (FieldError fieldError : e.getBindingResult().getFieldErrors()) &#123;</span><br><span class="line">            builder.addError(<span class="keyword">new</span> <span class="title class_">Response</span>.Error(fieldError.getField(), fieldError.getDefaultMessage()));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> builder.build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ---------------------------方式二-------------------------</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 针对参数校验失败异常的处理</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> e       参数校验异常</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request http request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 异常处理结果</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ExceptionHandler(value = ConstraintViolationException.class)</span></span><br><span class="line">    <span class="meta">@ResponseStatus(HttpStatus.BAD_REQUEST)</span></span><br><span class="line">    <span class="keyword">public</span> Response&lt;?&gt; handleDatabindException(ConstraintViolationException e, HttpServletRequest request) &#123;</span><br><span class="line">        log.error(MessageFormat.format(<span class="string">&quot;请求发生了非预期异常，出错的 url [&#123;0&#125;]，出错的描述为 [&#123;1&#125;]&quot;</span>,</span><br><span class="line">                request.getRequestURL().toString(), e.getMessage()), e);</span><br><span class="line"></span><br><span class="line">        List&lt;Response.Error&gt; errorList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (ConstraintViolation cv : e.getConstraintViolations()) &#123;</span><br><span class="line">            errorList.add(<span class="keyword">new</span> <span class="title class_">Response</span>.Error(cv.getPropertyPath().toString(), cv.getMessage()));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Response</span>.ResponseBuilder&lt;&gt;(ResponseCodeEnum.Client.COMMON_REQUEST_PARAMETERS_INVALID, JsonUtil.toJson(errorList))</span><br><span class="line">                .errors(errorList)</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 针对spring web 中的异常的处理</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> e        Spring Web 异常</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request  http request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> response http response</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 异常处理结果</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ExceptionHandler(value = &#123;</span></span><br><span class="line"><span class="meta">            NoHandlerFoundException.class</span></span><br><span class="line"><span class="meta">    &#125;)</span></span><br><span class="line">    <span class="meta">@ResponseStatus(HttpStatus.NOT_FOUND)</span></span><br><span class="line">    <span class="keyword">public</span> Response&lt;?&gt; handleSpringWebExceptionHandler(Exception e, HttpServletRequest request, HttpServletResponse response) &#123;</span><br><span class="line">        log.error(MessageFormat.format(<span class="string">&quot;请求发生了非预期异常，出错的 url [&#123;0&#125;]，出错的描述为 [&#123;1&#125;]&quot;</span>,</span><br><span class="line">                request.getRequestURL().toString(), e.getMessage()), e);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Response</span>.ResponseBuilder&lt;&gt;(ResponseCodeEnum.Client.COMMON_REQUEST_METHOD_INVALID).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * HttpMediaTypeNotSupportedException异常</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> e</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ExceptionHandler(HttpMediaTypeNotSupportedException.class)</span></span><br><span class="line">    <span class="meta">@ResponseStatus(HttpStatus.UNSUPPORTED_MEDIA_TYPE)</span></span><br><span class="line">    <span class="keyword">public</span> Response&lt;?&gt; handleHttpMediaTypeNotSupportedException(HttpMediaTypeNotSupportedException e, HttpServletRequest request) &#123;</span><br><span class="line">        log.error(MessageFormat.format(<span class="string">&quot;请求发生了非预期异常，出错的 url [&#123;0&#125;]，出错的描述为 [&#123;1&#125;]&quot;</span>,</span><br><span class="line">                request.getRequestURL().toString(), e.getMessage()), e);</span><br><span class="line">        <span class="keyword">return</span> Response.fail(<span class="keyword">new</span> <span class="title class_">ServiceException</span>(ResponseCodeEnum.Client.COMMON_HTTP_MEDIA_TYPE_NOT_SUPPORTED_ERROR));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExceptionHandler(RuntimeException.class)</span></span><br><span class="line">    <span class="meta">@ResponseStatus(HttpStatus.INTERNAL_SERVER_ERROR)</span></span><br><span class="line">    <span class="keyword">public</span> Response&lt;?&gt; handleRuntimeException(RuntimeException e, HttpServletRequest request) &#123;</span><br><span class="line">        log.error(MessageFormat.format(<span class="string">&quot;请求发生了运行时异常，出错的 url [&#123;0&#125;]，出错的描述为 [&#123;1&#125;]&quot;</span>,</span><br><span class="line">                request.getRequestURL().toString(), e.getMessage()), e);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Response</span>.ResponseBuilder&lt;&gt;(ResponseCodeEnum.Internal.INTERNAL_ERROR).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 针对全局异常的处理</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> e        全局异常</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request  http request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> response http response</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 异常处理结果</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ExceptionHandler(value = Throwable.class)</span></span><br><span class="line">    <span class="meta">@ResponseStatus(HttpStatus.INTERNAL_SERVER_ERROR)</span></span><br><span class="line">    <span class="keyword">public</span> Response&lt;?&gt; throwableHandler(Throwable e, HttpServletRequest request, HttpServletResponse response) &#123;</span><br><span class="line">        log.error(MessageFormat.format(<span class="string">&quot;请求发生了非预期异常，出错的 url [&#123;0&#125;]，出错的描述为 [&#123;1&#125;]&quot;</span>,</span><br><span class="line">                request.getRequestURL().toString(), e.getMessage()), e);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Response</span>.ResponseBuilder&lt;&gt;(ResponseCodeEnum.Internal.INTERNAL_ERROR).build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Filter过滤器，对拦截器的异常进行拦截，封装成Response返回。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GlobalExceptionFilter</span> <span class="keyword">implements</span> <span class="title class_">Filter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            chain.doFilter(request, response);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ServletException ex) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;global filter exceptions&quot;</span>, ex);</span><br><span class="line">            <span class="type">String</span> <span class="variable">resultJson</span> <span class="operator">=</span> JsonUtil.toJson(Response.fail(ex));</span><br><span class="line">            writeToResponse(response, resultJson);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;global filter exceptions, unknown error:&quot;</span>, e);</span><br><span class="line">            <span class="type">Response</span> <span class="variable">resp</span> <span class="operator">=</span> Response.fail(<span class="keyword">new</span> <span class="title class_">ServiceException</span>(ResponseCodeEnum.Internal.INTERNAL_ERROR, e));</span><br><span class="line">            <span class="type">String</span> <span class="variable">resultJson</span> <span class="operator">=</span> JsonUtil.toJson(resp);</span><br><span class="line">            writeToResponse(response, resultJson);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">writeToResponse</span><span class="params">(ServletResponse response, String resultJson)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        response.setContentType(MediaType.APPLICATION_JSON_VALUE);</span><br><span class="line">        response.setCharacterEncoding(<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">        response.getWriter().write(resultJson);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>响应基类BaseResult</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ApiModel(&quot;响应基础返回值&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BaseResult</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(name = &quot;结果码&quot;, notes = &quot;正确响应时该值为XXXX，错误响应时为错误代码&quot;)</span></span><br><span class="line">    <span class="meta">@JsonProperty(value = &quot;code&quot;, required = true)</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">int</span> code;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(name = &quot;结果码的消息描述&quot;, notes = &quot;人工可读的消息&quot;)</span></span><br><span class="line">    <span class="keyword">protected</span> String msg;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>统一响应格式Response</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EqualsAndHashCode(callSuper = true)</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ApiModel(&quot;统一Response返回值&quot;)</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Response</span>&lt;T&gt; <span class="keyword">extends</span> <span class="title class_">BaseResult</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 请求方传入的额外参数，响应中通过key=externalExt的形式返回，放到payload Map结构中返回</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXTERNAL_EXT</span> <span class="operator">=</span> <span class="string">&quot;externalExt&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 业务数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@JsonProperty(&quot;data&quot;)</span></span><br><span class="line">    <span class="meta">@JsonInclude</span></span><br><span class="line">    <span class="meta">@ApiModelProperty(name = &quot;响应体&quot;, notes = &quot;正确响应时该值会被使用&quot;)</span></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="keyword">private</span> T data;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 当验证错误时，各项具体的错误信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@JsonProperty(value = &quot;errors&quot;, required = false)</span></span><br><span class="line">    <span class="meta">@JsonInclude(JsonInclude.Include.NON_NULL)</span></span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;错误信息&quot;)</span></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;Error&gt; errors;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 额外数据，默认将客户端传来的数据返回去</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@JsonProperty(value = &quot;payload&quot;, required = false)</span></span><br><span class="line">    <span class="meta">@JsonInclude(JsonInclude.Include.NON_NULL)</span></span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;额外数据&quot;)</span></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Object&gt; payload;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">Response</span><span class="params">(ResponseBuilder&lt;T&gt; builder)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(builder.getCode(), builder.getMsg());</span><br><span class="line">        <span class="built_in">this</span>.data = builder.getData();</span><br><span class="line">        <span class="built_in">this</span>.errors = builder.getErrors();</span><br><span class="line">        <span class="built_in">this</span>.payload = builder.getPayload();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 提供一些常用的静态方法通过ResponseBuilder构建各种类型的响应，如果不合适则可以通过Builder定制</span></span><br><span class="line">    <span class="comment">// 成功</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Response <span class="title function_">success</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ResponseBuilder</span>(ResponseCodeEnum.SUCCESS).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; Response&lt;T&gt; <span class="title function_">success</span><span class="params">(T data)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ResponseBuilder</span>&lt;T&gt;(ResponseCodeEnum.SUCCESS)</span><br><span class="line">                .data(data)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 中间状态</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Response <span class="title function_">pending</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ResponseBuilder</span>&lt;&gt;(ResponseCodeEnum.PENDING).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; Response&lt;T&gt; <span class="title function_">pending</span><span class="params">(T data)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ResponseBuilder</span>&lt;T&gt;(ResponseCodeEnum.PENDING)</span><br><span class="line">                .data(data)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 失败</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; Response&lt;T&gt; <span class="title function_">fail</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ResponseBuilder</span>&lt;T&gt;(ResponseCodeEnum.FAILED).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; Response&lt;T&gt; <span class="title function_">fail</span><span class="params">(T data)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ResponseBuilder</span>&lt;T&gt;(ResponseCodeEnum.FAILED)</span><br><span class="line">                .data(data)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; Response&lt;T&gt; <span class="title function_">fail</span><span class="params">(ServiceException e)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ResponseBuilder</span>&lt;T&gt;(e.getResponseCode())</span><br><span class="line">                .payload(e.getPayload())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; Response&lt;T&gt; <span class="title function_">fail</span><span class="params">(ServiceException e, T data)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ResponseBuilder</span>&lt;T&gt;(e.getResponseCode())</span><br><span class="line">                .payload(e.getPayload())</span><br><span class="line">                .data(data)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 统一响应类Response建造者</span></span><br><span class="line"><span class="comment">     * 依赖于Spring Context，支持响应结果码描述国际化，参数替换。</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">ResponseBuilder</span>&lt;T&gt; &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> ResponseCodeInterface responseCode;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 国际化的结果码信息内容</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String msg;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> code;</span><br><span class="line">        <span class="keyword">private</span> T data;</span><br><span class="line">        <span class="keyword">private</span> List&lt;Error&gt; errors;</span><br><span class="line">        <span class="keyword">private</span> Map&lt;String, Object&gt; payload;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> Response&lt;T&gt; <span class="title function_">build</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Response</span>&lt;&gt;(<span class="built_in">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">ResponseBuilder</span><span class="params">(ResponseCodeInterface responseCode, Object... args)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.responseCode = responseCode;</span><br><span class="line">            <span class="built_in">this</span>.code = responseCode.code();</span><br><span class="line">            <span class="comment">// 替换默认描述占位符后的默认错误描述</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">defaultMsg</span> <span class="operator">=</span> MessageFormatter.arrayFormat(responseCode.message(), args).getMessage();</span><br><span class="line">            <span class="type">String</span> <span class="variable">i18nMessage</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 获取国际化的信息描述，如果配置responseCode.i18nKey()对应的key-value则支持国际化。也可以临时对默认的错误描述进行覆盖。</span></span><br><span class="line">                i18nMessage = MessageUtils.message(responseCode.i18nKey(), args);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (BeansException e) &#123;</span><br><span class="line">                log.error(<span class="string">&quot;MessageUtils not ready, depends on messageSource&quot;</span>, e);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                log.error(<span class="string">&quot;could not found i18nMessage entry for key: &quot;</span> + responseCode.i18nKey(), e);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">this</span>.msg = StringUtils.isNotBlank(i18nMessage) ? i18nMessage : defaultMsg;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 通过ServiceException业务异常创建Builder</span></span><br><span class="line"><span class="comment">         * 注：在ServiceException中已经进行错误描述的国际化处理</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> e</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">ResponseBuilder</span><span class="params">(ServiceException e)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.responseCode = e.getResponseCode();</span><br><span class="line">            <span class="built_in">this</span>.code = e.getResponseCode().code();</span><br><span class="line">            <span class="built_in">this</span>.msg = e.getMessage();</span><br><span class="line">            <span class="built_in">this</span>.payload = e.getPayload();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getCode</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.code;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">getMsg</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.msg;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> ResponseCodeInterface <span class="title function_">getResponseCode</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> responseCode;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> ResponseBuilder&lt;T&gt; <span class="title function_">data</span><span class="params">(T data)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.data = data;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> T <span class="title function_">getData</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> data;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> ResponseBuilder&lt;T&gt; <span class="title function_">errors</span><span class="params">(List&lt;Error&gt; errors)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.errors = errors;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> List&lt;Error&gt; <span class="title function_">getErrors</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> errors;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> ResponseBuilder&lt;T&gt; <span class="title function_">addError</span><span class="params">(Error error)</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.errors == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="built_in">this</span>.errors = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">this</span>.errors.add(error);</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> ResponseBuilder&lt;T&gt; <span class="title function_">addPayloadAttr</span><span class="params">(String key, String value)</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.payload == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="built_in">this</span>.payload = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">this</span>.payload.put(key, value);</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title function_">getPayload</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> payload;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> ResponseBuilder&lt;T&gt; <span class="title function_">payload</span><span class="params">(Map&lt;String, Object&gt; payload)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.payload = payload;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> ResponseBuilder&lt;T&gt; <span class="title function_">clientExt</span><span class="params">(Map&lt;String, Object&gt; clientExt)</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.payload == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="built_in">this</span>.payload = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">this</span>.payload.put(EXTERNAL_EXT, clientExt);</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Data</span></span><br><span class="line">    <span class="meta">@AllArgsConstructor</span></span><br><span class="line">    <span class="meta">@ApiModel(&quot;统一Response返回值中错误信息的模型&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Error</span> &#123;</span><br><span class="line">        <span class="meta">@ApiModelProperty(name = &quot;错误项&quot;, notes = &quot;错误的具体项&quot;)</span></span><br><span class="line">        <span class="keyword">private</span> String name;</span><br><span class="line">        <span class="meta">@ApiModelProperty(name = &quot;错误项说明&quot;, notes = &quot;错误的具体项说明&quot;)</span></span><br><span class="line">        <span class="keyword">private</span> String message;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h1><h2 id="响应码映射"><a href="#响应码映射" class="headerlink" title="响应码映射"></a>响应码映射</h2><p>通常一个后端服务还会去调用第三方，比如一个聚合支付平台后面（南向）有各种支付渠道，系统层面也会依赖分布式缓存（Redis），配置中心，消息队列等内部服务，因此针对这些调用报错，后端不会直接透传，而是会进行包装，第三方错误码映射后才会返回给调用方。这部分设计暂时没有纳入进来，如果要做，下面是一些考虑的点：</p><p>todo:<br>1.依赖方的响应码（南向）到调用方（北向）响应码的映射计划通过国际化的响应码配置文件中定义。key的组成为&lt;被调用方ID&gt;.&lt;服务类型Type&gt;.&lt;南向响应码resultCode&gt;=&lt;北向响应码code&gt;，需要提供code到枚举的解析方法，如果考虑合理存放响应码映射信息，可以通过一个resultCode.properties来存放。示例：Alipay.[Charge.]E0001=10601<br>2.通过数据库，适合支持运营配置的场景。<br>3.通过代码逻辑+枚举类映射的方式（变更的代价较大，一般不建议）</p><p>响应码映射的管理，如果需要支持运营配置，可以考虑将响应码映射的维护放在数据库，应该支持以下功能：</p><ul><li>定制化南向响应码对应的北向映射code，message</li><li>支持添加北向响应码和响应码描述定义</li><li>支持配置南向到北向的映射</li></ul><h2 id="HTTP状态码"><a href="#HTTP状态码" class="headerlink" title="HTTP状态码"></a>HTTP状态码</h2><p>Rest风格的API设计后，httpcode充当什么角色？主流的都是服务器内部异常时500，客户端错误400，请求到达服务端后代码流程正常（异常分支处理也属于代码正常流程）则统一返回200。几点思考：</p><ul><li>根据处理异常类型设置httpcode？</li><li>结合nginx健康检查？到后端之后统一200？—- 划分为内部资源，通常只要流程处理正常，就返回2XX，重定向则3XX，客户端问题就4XX，服务端资源不足了那就5XX，外部资源可以返回2XX然后通过下面的业务结果告知客户端具体错误</li></ul><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>统一响应格式，主要方便前后端沟通，规范化后端研发人员的编码；全局异常处理是优雅的处理各种报错，从业务逻辑中分离开来，使得研发更关注业务；国际化是特殊处理，如果要提供全球化的服务，那么是值得做的。</p><blockquote><p>代码：todo待整理上传github</p></blockquote><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p>HTTP：</p><p><a href="https://www.iana.org/assignments/http-status-codes/http-status-codes.xhtml">Hypertext Transfer Protocol (HTTP) Status Code Registry</a><br><a href="https://datatracker.ietf.org/doc/html/rfc2616#section-10">Hypertext Transfer Protocol – HTTP/1.1</a><br><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP">火狐官方HTTP定义</a><br><a href="https://docs.github.com/zh/rest?apiVersion=2022-11-28">GitHub REST API 文档</a></p><p>API文档：</p><p><a href="https://developer.twitter.com/en/docs/twitter-ads-api">Twitter Ads API</a><br><a href="https://developer.paypal.com/docs/api/orders/v2/#orders_create">Paypal API</a></p><blockquote><p>声明：本站所有文章均为原创或翻译，遵循<a href="https://creativecommons.org/licenses/by-nc-nd/4.0/deed.en">署名 - 非商业性使用 - 禁止演绎 4.0 国际许可协议</a>，如需转载请确保您对该协议有足够了解，并附上作者名 (Tsukasa) 及原文地址</p></blockquote>]]></content>
    
    
    <summary type="html">&lt;script src=&quot;&#92;assets&#92;js&#92;APlayer.min.js&quot;&gt; &lt;/script&gt;&lt;p&gt;写一个Spring项目统一响应格式设计和全局异常处理的best-practice，便于后续查阅。&lt;/p&gt;</summary>
    
    
    
    <category term="编程开发" scheme="http://blog.tsukasa.moe/categories/%E7%BC%96%E7%A8%8B%E5%BC%80%E5%8F%91/"/>
    
    
    <category term="Spring" scheme="http://blog.tsukasa.moe/tags/Spring/"/>
    
    <category term="Hibernate Validator" scheme="http://blog.tsukasa.moe/tags/Hibernate-Validator/"/>
    
    <category term="Best practice" scheme="http://blog.tsukasa.moe/tags/Best-practice/"/>
    
  </entry>
  
  <entry>
    <title>Mybatis源码学习总结</title>
    <link href="http://blog.tsukasa.moe/2023/10/27/Mybatis-Source-Code-Learning/"/>
    <id>http://blog.tsukasa.moe/2023/10/27/Mybatis-Source-Code-Learning/</id>
    <published>2023-10-27T09:19:46.000Z</published>
    <updated>2023-10-27T16:50:21.611Z</updated>
    
    <content type="html"><![CDATA[<!-- excerpt --><!-- toc --><h1 id="Mybatis包结构"><a href="#Mybatis包结构" class="headerlink" title="Mybatis包结构"></a>Mybatis包结构</h1><p><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202310271820787.png" alt=""></p><h1 id="Mybatis使用流程"><a href="#Mybatis使用流程" class="headerlink" title="Mybatis使用流程"></a>Mybatis使用流程</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyBatisBootStrap</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 1. 读取配置</span></span><br><span class="line">            <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> Resources.getResourceAsStream(<span class="string">&quot;mybatis-config.xml&quot;</span>);</span><br><span class="line">            <span class="comment">// 2. 创建SqlSessionFactory工厂</span></span><br><span class="line">            <span class="type">SqlSessionFactory</span> <span class="variable">sqlSessionFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SqlSessionFactoryBuilder</span>().build(inputStream);</span><br><span class="line">            <span class="comment">// 3. 获取sqlSession</span></span><br><span class="line">            <span class="type">SqlSession</span> <span class="variable">sqlSession</span> <span class="operator">=</span> sqlSessionFactory.openSession();</span><br><span class="line">            <span class="comment">// 4. 获取Mapper</span></span><br><span class="line">            <span class="type">CategoryMapper</span> <span class="variable">categoryMapper</span> <span class="operator">=</span> sqlSession.getMapper(CategoryMapper.class);</span><br><span class="line">            <span class="comment">// 5. 执行接口方法</span></span><br><span class="line">            <span class="type">Category</span> <span class="variable">category</span> <span class="operator">=</span> categoryMapper.queryCategoryByCategoryId(<span class="number">1</span>);</span><br><span class="line">            log.info(<span class="string">&quot;category = &quot;</span> + JsonUtil.toJson(category));</span><br><span class="line">            <span class="comment">// 6. 提交事物</span></span><br><span class="line">            sqlSession.commit();</span><br><span class="line">            <span class="comment">// 7. 关闭资源</span></span><br><span class="line">            sqlSession.close();</span><br><span class="line">            inputStream.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(e.getMessage(), e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果对于Mybatis启动不清晰，可以通过上面这段代码找到入口，阅读源码。</p><h1 id="一些关键逻辑和亮点"><a href="#一些关键逻辑和亮点" class="headerlink" title="一些关键逻辑和亮点"></a>一些关键逻辑和亮点</h1><h2 id="通过SqlSessionFactory工厂获取SqlSession"><a href="#通过SqlSessionFactory工厂获取SqlSession" class="headerlink" title="通过SqlSessionFactory工厂获取SqlSession"></a>通过SqlSessionFactory工厂获取SqlSession</h2><p>工厂方法模式+建造者设计模式的应用</p><p>SqlSessionFactory通过工厂方法openSession创建SqlSession实例，具体的工厂类实现了工厂接口，负责创建特定类型的对象，使SqlSession的实例化延迟到SqlSessionFactory子类。客户端通过SqlSessionFactory接口和工厂子类来获取SqlSession，而不需要知道具体的对象创建过程。而工厂本身是一个复杂的对象，因此可以通过建造者模式SqlSessionFactoryBuilder来构建。</p><p>源码位置：<br><code>org.apache.ibatis.session.SqlSessionFactory</code></p><p>两个子类：<br><code>org.apache.ibatis.session.defaults.DefaultSqlSessionFactory</code><br><code>org.apache.ibatis.session.SqlSessionManager</code></p><p>建造者类SqlSessionFactoryBuilder<br><code>org.apache.ibatis.session.SqlSessionFactoryBuilder#build(java.io.InputStream, java.lang.String, java.util.Properties)</code></p><h2 id="加载Mybatis配置文件"><a href="#加载Mybatis配置文件" class="headerlink" title="加载Mybatis配置文件"></a>加载Mybatis配置文件</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 2. 创建SqlSessionFactory工厂</span></span><br><span class="line"><span class="type">SqlSessionFactory</span> <span class="variable">sqlSessionFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SqlSessionFactoryBuilder</span>().build(inputStream);</span><br></pre></td></tr></table></figure><p>上面这段代码，XMLConfigBuilder会解析inputStream，根据得到Configuration默认实例化一个工厂子类DefaultSqlSessionFactory。</p><p>源码位置：<br><code>org.apache.ibatis.builder.xml.XMLConfigBuilder#parseConfiguration</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">parseConfiguration</span><span class="params">(XNode root)</span> &#123;</span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">     <span class="comment">// issue #117 read properties first</span></span><br><span class="line">     propertiesElement(root.evalNode(<span class="string">&quot;properties&quot;</span>));</span><br><span class="line">     <span class="type">Properties</span> <span class="variable">settings</span> <span class="operator">=</span> settingsAsProperties(root.evalNode(<span class="string">&quot;settings&quot;</span>));</span><br><span class="line">     loadCustomVfs(settings);</span><br><span class="line">     loadCustomLogImpl(settings);</span><br><span class="line">     typeAliasesElement(root.evalNode(<span class="string">&quot;typeAliases&quot;</span>));</span><br><span class="line">     pluginElement(root.evalNode(<span class="string">&quot;plugins&quot;</span>));</span><br><span class="line">     objectFactoryElement(root.evalNode(<span class="string">&quot;objectFactory&quot;</span>));</span><br><span class="line">     objectWrapperFactoryElement(root.evalNode(<span class="string">&quot;objectWrapperFactory&quot;</span>));</span><br><span class="line">     reflectorFactoryElement(root.evalNode(<span class="string">&quot;reflectorFactory&quot;</span>));</span><br><span class="line">     settingsElement(settings);</span><br><span class="line">     <span class="comment">// read it after objectFactory and objectWrapperFactory issue #631</span></span><br><span class="line">     environmentsElement(root.evalNode(<span class="string">&quot;environments&quot;</span>));</span><br><span class="line">     databaseIdProviderElement(root.evalNode(<span class="string">&quot;databaseIdProvider&quot;</span>));</span><br><span class="line">     typeHandlerElement(root.evalNode(<span class="string">&quot;typeHandlers&quot;</span>));</span><br><span class="line">     mapperElement(root.evalNode(<span class="string">&quot;mappers&quot;</span>));</span><br><span class="line">   &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">     <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BuilderException</span>(<span class="string">&quot;Error parsing SQL Mapper Configuration. Cause: &quot;</span> + e, e);</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><h3 id="配置项的默认值"><a href="#配置项的默认值" class="headerlink" title="配置项的默认值"></a>配置项的默认值</h3><p><code>org.apache.ibatis.builder.xml.XMLConfigBuilder#settingsElement</code></p><h2 id="SqlSession接口"><a href="#SqlSession接口" class="headerlink" title="SqlSession接口"></a>SqlSession接口</h2><p>sqlSession是操作数据库的高级接口，获取sqlSession有两种方式：<br>一种是从数据源中获取的，还有一种是从连接中获取。获取到的都是DefaultSqlSession对象，也就是sqlSession的默认实现。</p><p>SqlSession接口源码，下面是其主要方法，已过滤一些重载方法。<br><code>org.apache.ibatis.session.SqlSession</code></p><ul><li>statement：Mybatis语句ID，Mapper接口的方法名称</li><li>RowBounds：分页对象，主要拼接sql中的start，limit条件。</li><li></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">SqlSession</span> <span class="keyword">extends</span> <span class="title class_">Closeable</span> &#123;</span><br><span class="line"></span><br><span class="line">  &lt;T&gt; T <span class="title function_">selectOne</span><span class="params">(String statement, Object parameter)</span>;</span><br><span class="line"></span><br><span class="line">  &lt;E&gt; List&lt;E&gt; <span class="title function_">selectList</span><span class="params">(String statement, Object parameter, RowBounds rowBounds)</span>;</span><br><span class="line"></span><br><span class="line">  &lt;K, V&gt; Map&lt;K, V&gt; <span class="title function_">selectMap</span><span class="params">(String statement, Object parameter, String mapKey, RowBounds rowBounds)</span>;</span><br><span class="line"></span><br><span class="line">  &lt;T&gt; Cursor&lt;T&gt; <span class="title function_">selectCursor</span><span class="params">(String statement, Object parameter, RowBounds rowBounds)</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> <span class="title function_">select</span><span class="params">(String statement, Object parameter, RowBounds rowBounds, ResultHandler handler)</span>;</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> <span class="title function_">insert</span><span class="params">(String statement, Object parameter)</span>;</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> <span class="title function_">update</span><span class="params">(String statement, Object parameter)</span>;</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> <span class="title function_">delete</span><span class="params">(String statement, Object parameter)</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> <span class="title function_">commit</span><span class="params">(<span class="type">boolean</span> force)</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> <span class="title function_">rollback</span><span class="params">(<span class="type">boolean</span> force)</span>;</span><br><span class="line"></span><br><span class="line">  List&lt;BatchResult&gt; <span class="title function_">flushStatements</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">void</span> <span class="title function_">close</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> <span class="title function_">clearCache</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">  Configuration <span class="title function_">getConfiguration</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">  &lt;T&gt; T <span class="title function_">getMapper</span><span class="params">(Class&lt;T&gt; type)</span>;</span><br><span class="line"></span><br><span class="line">  Connection <span class="title function_">getConnection</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>获取sqlSession源码位置：<br><code>org.apache.ibatis.session.defaults.DefaultSqlSessionFactory#openSessionFromDataSource</code><br><code>org.apache.ibatis.session.defaults.DefaultSqlSessionFactory#openSessionFromConnection</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 方式1：从数据源中获取的</span></span><br><span class="line"> <span class="keyword">private</span> SqlSession <span class="title function_">openSessionFromDataSource</span><span class="params">(ExecutorType execType, TransactionIsolationLevel level, <span class="type">boolean</span> autoCommit)</span> &#123;</span><br><span class="line">    <span class="type">Transaction</span> <span class="variable">tx</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">final</span> <span class="type">Environment</span> <span class="variable">environment</span> <span class="operator">=</span> configuration.getEnvironment();</span><br><span class="line">      <span class="keyword">final</span> <span class="type">TransactionFactory</span> <span class="variable">transactionFactory</span> <span class="operator">=</span> getTransactionFactoryFromEnvironment(environment);</span><br><span class="line">      tx = transactionFactory.newTransaction(environment.getDataSource(), level, autoCommit);</span><br><span class="line">      <span class="keyword">final</span> <span class="type">Executor</span> <span class="variable">executor</span> <span class="operator">=</span> configuration.newExecutor(tx, execType);</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DefaultSqlSession</span>(configuration, executor, autoCommit);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      closeTransaction(tx); <span class="comment">// may have fetched a connection so lets call close()</span></span><br><span class="line">      <span class="keyword">throw</span> ExceptionFactory.wrapException(<span class="string">&quot;Error opening session.  Cause: &quot;</span> + e, e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      ErrorContext.instance().reset();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 方式2：从连接中获取</span></span><br><span class="line">  <span class="keyword">private</span> SqlSession <span class="title function_">openSessionFromConnection</span><span class="params">(ExecutorType execType, Connection connection)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="type">boolean</span> autoCommit;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        autoCommit = connection.getAutoCommit();</span><br><span class="line">      &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">        <span class="comment">// Failover to true, as most poor drivers</span></span><br><span class="line">        <span class="comment">// or databases won&#x27;t support transactions</span></span><br><span class="line">        autoCommit = <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">final</span> <span class="type">Environment</span> <span class="variable">environment</span> <span class="operator">=</span> configuration.getEnvironment();</span><br><span class="line">      <span class="keyword">final</span> <span class="type">TransactionFactory</span> <span class="variable">transactionFactory</span> <span class="operator">=</span> getTransactionFactoryFromEnvironment(environment);</span><br><span class="line">      <span class="keyword">final</span> <span class="type">Transaction</span> <span class="variable">tx</span> <span class="operator">=</span> transactionFactory.newTransaction(connection);</span><br><span class="line">      <span class="keyword">final</span> <span class="type">Executor</span> <span class="variable">executor</span> <span class="operator">=</span> configuration.newExecutor(tx, execType);</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DefaultSqlSession</span>(configuration, executor, autoCommit);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> ExceptionFactory.wrapException(<span class="string">&quot;Error opening session.  Cause: &quot;</span> + e, e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      ErrorContext.instance().reset();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><h2 id="获取Mapper代理类"><a href="#获取Mapper代理类" class="headerlink" title="获取Mapper代理类"></a>获取Mapper代理类</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 4. 获取Mapper</span></span><br><span class="line"><span class="type">CategoryMapper</span> <span class="variable">categoryMapper</span> <span class="operator">=</span> sqlSession.getMapper(CategoryMapper.class);</span><br></pre></td></tr></table></figure><p>因为默认的SqlSession实现是DefaultSqlSession，进入源码可以得知，CategoryMapper是通过代理工厂MapperProxyFactory反射得到Mapper代理类。这段代码逻辑可以通过顺藤摸瓜，找到Mapper代理是通过<code>Map&lt;Class&lt;?&gt;, MapperProxyFactory&lt;?&gt;&gt; knownMappers</code>获取的。</p><p>源码入口：<br><code>org.apache.ibatis.session.defaults.DefaultSqlSession#getMapper</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T&gt; T <span class="title function_">getMapper</span><span class="params">(Class&lt;T&gt; type)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.configuration.getMapper(type, <span class="built_in">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>org.apache.ibatis.session.Configuration#getMapper</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T&gt; T <span class="title function_">getMapper</span><span class="params">(Class&lt;T&gt; type, SqlSession sqlSession)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.mapperRegistry.getMapper(type, sqlSession);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><code>org.apache.ibatis.binding.MapperRegistry#getMapper</code>找到这段代码可以得知：<br>1、代理工厂来自knownMappers<br>2、mapperProxyFactory.newInstance(sqlSession)，Mapper每次都通过Mapper代理工厂生成，是一个代理类。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T&gt; T <span class="title function_">getMapper</span><span class="params">(Class&lt;T&gt; type, SqlSession sqlSession)</span> &#123;</span><br><span class="line">  <span class="keyword">final</span> MapperProxyFactory&lt;T&gt; mapperProxyFactory = (MapperProxyFactory&lt;T&gt;) knownMappers.get(type);</span><br><span class="line">  <span class="keyword">if</span> (mapperProxyFactory == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BindingException</span>(<span class="string">&quot;Type &quot;</span> + type + <span class="string">&quot; is not known to the MapperRegistry.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> mapperProxyFactory.newInstance(sqlSession);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BindingException</span>(<span class="string">&quot;Error getting mapper instance. Cause: &quot;</span> + e, e);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>knownMappers是如何初始化？</p><p><code>org.apache.ibatis.binding.MapperRegistry#addMapper</code> ==&gt; <code>org.apache.ibatis.builder.xml.XMLConfigBuilder#mapperElement</code></p><p>可以发现是在XMLConfigBuilder解析mybatis-config.xml时通过parseConfiguration方法进行的。仔细观察下图，还提供了一个Spring下的FacotryBean实现进行配置。</p><p><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202310272317221.png" alt=""></p><h2 id="执行Mapper代理方法"><a href="#执行Mapper代理方法" class="headerlink" title="执行Mapper代理方法"></a>执行Mapper代理方法</h2><p>从上面分析得知，获取得到的Mapper是通过MapperProxyFactory工厂类创建的MapperProxy代理类。因此，在执行Mapper接口的方法时，会调用MapperProxy的invoke方法。<br>通过Debug也可以得到Mapper的执行逻辑。</p><p><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202310272344693.png" alt=""></p><p>源码入口：<br><code>org.apache.ibatis.binding.MapperProxy#invoke</code></p><p><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202310272345844.png" alt=""></p><p><code>cachedInvoker(method)</code>返回MapperMethodInvoker对象，执行invoke方法（具体通过哪个实现可以实际debug，这里是MapperMethodInvoker的子类PlainMethodInvoker的invoke方法）<br><code>org.apache.ibatis.binding.MapperMethod#execute</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">execute</span><span class="params">(SqlSession sqlSession, Object[] args)</span> &#123;</span><br><span class="line">  Object result;</span><br><span class="line">  <span class="keyword">switch</span> (command.getType()) &#123;</span><br><span class="line">    <span class="keyword">case</span> INSERT: &#123;</span><br><span class="line">      <span class="type">Object</span> <span class="variable">param</span> <span class="operator">=</span> method.convertArgsToSqlCommandParam(args);</span><br><span class="line">      result = rowCountResult(sqlSession.insert(command.getName(), param));</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> UPDATE: &#123;</span><br><span class="line">      <span class="type">Object</span> <span class="variable">param</span> <span class="operator">=</span> method.convertArgsToSqlCommandParam(args);</span><br><span class="line">      result = rowCountResult(sqlSession.update(command.getName(), param));</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> DELETE: &#123;</span><br><span class="line">      <span class="type">Object</span> <span class="variable">param</span> <span class="operator">=</span> method.convertArgsToSqlCommandParam(args);</span><br><span class="line">      result = rowCountResult(sqlSession.delete(command.getName(), param));</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> SELECT:</span><br><span class="line">      <span class="keyword">if</span> (method.returnsVoid() &amp;&amp; method.hasResultHandler()) &#123;</span><br><span class="line">        executeWithResultHandler(sqlSession, args);</span><br><span class="line">        result = <span class="literal">null</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.returnsMany()) &#123;</span><br><span class="line">        result = executeForMany(sqlSession, args);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.returnsMap()) &#123;</span><br><span class="line">        result = executeForMap(sqlSession, args);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.returnsCursor()) &#123;</span><br><span class="line">        result = executeForCursor(sqlSession, args);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">param</span> <span class="operator">=</span> method.convertArgsToSqlCommandParam(args);</span><br><span class="line">        result = sqlSession.selectOne(command.getName(), param);</span><br><span class="line">        <span class="keyword">if</span> (method.returnsOptional()</span><br><span class="line">            &amp;&amp; (result == <span class="literal">null</span> || !method.getReturnType().equals(result.getClass()))) &#123;</span><br><span class="line">          result = Optional.ofNullable(result);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> FLUSH:</span><br><span class="line">      result = sqlSession.flushStatements();</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BindingException</span>(<span class="string">&quot;Unknown execution method for: &quot;</span> + command.getName());</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (result == <span class="literal">null</span> &amp;&amp; method.getReturnType().isPrimitive() &amp;&amp; !method.returnsVoid()) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BindingException</span>(<span class="string">&quot;Mapper method &#x27;&quot;</span> + command.getName()</span><br><span class="line">        + <span class="string">&quot; attempted to return null from a method with a primitive return type (&quot;</span> + method.getReturnType() + <span class="string">&quot;).&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="SqlSession-SqlSessionFactory-SqlSessionFactoryBuilder的关系"><a href="#SqlSession-SqlSessionFactory-SqlSessionFactoryBuilder的关系" class="headerlink" title="SqlSession, SqlSessionFactory, SqlSessionFactoryBuilder的关系"></a>SqlSession, SqlSessionFactory, SqlSessionFactoryBuilder的关系</h1><h2 id="SqlSession的使用"><a href="#SqlSession的使用" class="headerlink" title="SqlSession的使用"></a>SqlSession的使用</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSelectOne</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 1. 读取配置</span></span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> Resources.getResourceAsStream(<span class="string">&quot;mybatis-config.xml&quot;</span>);</span><br><span class="line">        <span class="comment">// 2. 获取SqlSessionFactory对象</span></span><br><span class="line">        <span class="type">SqlSessionFactory</span> <span class="variable">sqlSessionFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SqlSessionFactoryBuilder</span>().build(inputStream);</span><br><span class="line">        <span class="comment">// 3. 获取SqlSession对象</span></span><br><span class="line">        <span class="type">SqlSession</span> <span class="variable">sqlSession</span> <span class="operator">=</span> sqlSessionFactory.openSession();</span><br><span class="line">        <span class="comment">// 4. 执行sql，下面2种写法结果一致</span></span><br><span class="line">        <span class="type">Category</span> <span class="variable">category</span> <span class="operator">=</span> sqlSession.selectOne(<span class="string">&quot;moe.tsukasa.demo.dao.CategoryMapper.queryCategoryByCategoryId&quot;</span>, <span class="number">1</span>);</span><br><span class="line">        log.info(<span class="string">&quot;category = [&#123;&#125;]&quot;</span>, JsonUtil.toJson(category));</span><br><span class="line">        <span class="type">Category</span> <span class="variable">category2</span> <span class="operator">=</span> sqlSession.selectOne(<span class="string">&quot;queryCategoryByCategoryId&quot;</span>, <span class="number">1</span>);</span><br><span class="line">        log.info(<span class="string">&quot;category2 = [&#123;&#125;]&quot;</span>, JsonUtil.toJson(category2));</span><br><span class="line">        <span class="comment">// 5. 关闭连接</span></span><br><span class="line">        sqlSession.close();</span><br><span class="line">        inputStream.close();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">        log.error(<span class="string">&quot;errMsg = [&#123;&#125;]&quot;</span>, e.getMessage(), e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="SqlSession的执行原理"><a href="#SqlSession的执行原理" class="headerlink" title="SqlSession的执行原理"></a>SqlSession的执行原理</h2><h1 id="Excutor"><a href="#Excutor" class="headerlink" title="Excutor"></a>Excutor</h1><p>Excutor是MyBatis持久层框架中的一个关键组件，负责SQL语句的执行，缓存的处理，事务管理，参数处理。</p><p>Executor接口有两个实现，一个是BaseExecutor抽象类，一个是CachingExecutor实现类。BaseExecutor抽象类有四个实现SimpleExecutor，BathExecutor, ReuseExecutor, ClosedExecutor。</p><p>Executor继承关系：</p><p><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202310280026898.png" alt=""></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Executor</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="type">ResultHandler</span> <span class="variable">NO_RESULT_HANDLER</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> <span class="title function_">update</span><span class="params">(MappedStatement ms, Object parameter)</span> <span class="keyword">throws</span> SQLException;</span><br><span class="line"></span><br><span class="line">  &lt;E&gt; List&lt;E&gt; <span class="title function_">query</span><span class="params">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, CacheKey cacheKey, BoundSql boundSql)</span> <span class="keyword">throws</span> SQLException;</span><br><span class="line"></span><br><span class="line">  &lt;E&gt; List&lt;E&gt; <span class="title function_">query</span><span class="params">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler)</span> <span class="keyword">throws</span> SQLException;</span><br><span class="line"></span><br><span class="line">  &lt;E&gt; Cursor&lt;E&gt; <span class="title function_">queryCursor</span><span class="params">(MappedStatement ms, Object parameter, RowBounds rowBounds)</span> <span class="keyword">throws</span> SQLException;</span><br><span class="line"></span><br><span class="line">  List&lt;BatchResult&gt; <span class="title function_">flushStatements</span><span class="params">()</span> <span class="keyword">throws</span> SQLException;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> <span class="title function_">commit</span><span class="params">(<span class="type">boolean</span> required)</span> <span class="keyword">throws</span> SQLException;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> <span class="title function_">rollback</span><span class="params">(<span class="type">boolean</span> required)</span> <span class="keyword">throws</span> SQLException;</span><br><span class="line"></span><br><span class="line">  CacheKey <span class="title function_">createCacheKey</span><span class="params">(MappedStatement ms, Object parameterObject, RowBounds rowBounds, BoundSql boundSql)</span>;</span><br><span class="line"></span><br><span class="line">  <span class="type">boolean</span> <span class="title function_">isCached</span><span class="params">(MappedStatement ms, CacheKey key)</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> <span class="title function_">clearLocalCache</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> <span class="title function_">deferLoad</span><span class="params">(MappedStatement ms, MetaObject resultObject, String property, CacheKey key, Class&lt;?&gt; targetType)</span>;</span><br><span class="line"></span><br><span class="line">  Transaction <span class="title function_">getTransaction</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> <span class="title function_">close</span><span class="params">(<span class="type">boolean</span> forceRollback)</span>;</span><br><span class="line"></span><br><span class="line">  <span class="type">boolean</span> <span class="title function_">isClosed</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> <span class="title function_">setExecutorWrapper</span><span class="params">(Executor executor)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Excutor是模板方法设计模式的应用，Executor接口有个抽象子类BaseExecutor，定义了一些模板方法，通过子类来实现。</p><p>SimpleExecutor是默认的Executor实现，适用于大多数情况，但不支持高级功能如二级缓存。我们只需要定义好myabtis-config.xml，MyBatis框架会负责调用适当的Executor来执行数据库操作。</p><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><blockquote><p>声明：本站所有文章均为原创或翻译，遵循<a href="https://creativecommons.org/licenses/by-nc-nd/4.0/deed.en">署名 - 非商业性使用 - 禁止演绎 4.0 国际许可协议</a>，如需转载请确保您对该协议有足够了解，并附上作者名 (Tsukasa) 及原文地址</p></blockquote>]]></content>
    
    
    <summary type="html">&lt;script src=&quot;&#92;assets&#92;js&#92;APlayer.min.js&quot;&gt; &lt;/script&gt;&lt;p&gt;学习Mybatis源码&lt;/p&gt;</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>Spring系列-HTTP消息转换器message-converters</title>
    <link href="http://blog.tsukasa.moe/2023/10/20/Spring-message-converter-learning01/"/>
    <id>http://blog.tsukasa.moe/2023/10/20/Spring-message-converter-learning01/</id>
    <published>2023-10-19T16:24:43.000Z</published>
    <updated>2023-10-24T17:55:27.079Z</updated>
    
    <content type="html"><![CDATA[<!-- excerpt --><!-- toc --><p>文章主要讲解下Spring框架中的HTTP消息转换器message-converters的使用，Spring框架的HTTP消息转换器的主要作用是将HTTP请求和响应中的消息内容与Java对象之间进行相互转换（序列化与反序列化），这些消息转换器可以处理JSON、XML、文本、二进制等数据类型。</p><p>数据转换流程：</p><p><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202310200212932.png" alt=""></p><h1 id="Spring默认的内置HTTP消息转换器"><a href="#Spring默认的内置HTTP消息转换器" class="headerlink" title="Spring默认的内置HTTP消息转换器"></a>Spring默认的内置HTTP消息转换器</h1><p>添加的默认HTTP消息转换器源码：<br>org.springframework.web.servlet.config.annotation.WebMvcConfigurationSupport#addDefaultHttpMessageConverters</p><p>Spring MVC中，使用<code>message-converters</code>标签来配置不同的消息转换器。下面是使用中需要注意的地方：</p><p>如果多个消息转换器支持相同的媒体类型时，Spring会选择第一个匹配的消息转换器进行处理请求和响应，因此在message-converter标签中配置时需要注意顺序，当然也可以通过实现WebMvcConfigurer接口的配置类，重写configureMessageConverters方法，自定义转换器的顺序。</p><p>下面是一些默认的HTTP消息转换器（具体实现可以查看<code>org.springframework.web.servlet.config.annotation.WebMvcConfigurationSupport#addDefaultHttpMessageConverters</code>）</p><ul><li><code>org.springframework.http.converter.StringHttpMessageConverter</code>：这是Spring框架内置的消息转换器之一，用于处理文本数据。它能够将HTTP请求中的文本数据（通常是字符串）转换为Java字符串，并反之将Java字符串转换为HTTP响应的文本数据。</li><li><code>ByteArrayHttpMessageConverter</code>：用于处理字节数组。</li><li><code>StringHttpMessageConverter</code>：用于处理文本（字符串）数据。</li><li><code>FormHttpMessageConverter</code>：用于处理表单数据。</li><li><code>Jaxb2RootElementHttpMessageConverter</code>：用于处理XML数据（需要JAXB 2支持）。</li><li><code>MappingJackson2HttpMessageConverter</code>：用于处理JSON数据（需要Jackson 2支持），需要依赖Jackson。</li><li></li><li><code>ResourceHttpMessageConverter</code>：负责读取资源文件和写出资源文件数据；</li><li><code>MappingJacksonHttpMessageConverter</code>：负责读取和写入json格式的数据；(当返回值是对象或者List，就由这个处理)</li><li><code>AtomFeedHttpMessageConverter</code>：负责读取和写入Atom格式的数据；</li><li><code>RssChannelHttpMessageConverter</code>：负责读取和写入RSS格式的数据；</li></ul><h1 id="如何配置HTTP转换器"><a href="#如何配置HTTP转换器" class="headerlink" title="如何配置HTTP转换器"></a>如何配置HTTP转换器</h1><p>HTTP消息转换器在spring-mvc.xml文件中进行下面配置，如果不配置则默认使用内置的HTTP消息转换器。下面了字符串的转换器为StringHttpMessageConverter，Json转换器使用FastJsonHttpMessageConverter。因为使用到了Fastjson三方类库，需要在pom文件中引入依赖。</p><p>1、XML配置方式：</p><p>spring-mvc.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mvc:annotation-driven</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mvc:message-converters</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.http.converter.StringHttpMessageConverter&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;supportedMediaTypes&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">value</span>&gt;</span>text/plain;charset=UTF-8<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;fastJsonHttpMessageConverter&quot;</span></span></span><br><span class="line"><span class="tag">              <span class="attr">class</span>=<span class="string">&quot;com.alibaba.fastjson.support.spring.FastJsonHttpMessageConverter&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;supportedMediaTypes&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">value</span>&gt;</span>application/json;charset=UTF-8<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mvc:message-converters</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mvc:annotation-driven</span>&gt;</span></span><br></pre></td></tr></table></figure><p>pom.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure><p>2、注解配置类方式</p><p>Spring 5以上采用Java 8语法，接口方法提供了default实现，没有必要通过继承适配器类WebMvcConfigurerAdapter重写方法，直接实现WebMvcConfigurer接口重写方法即可。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebMvc</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HttpMessageConverterConfig</span> <span class="keyword">implements</span> <span class="title class_">WebMvcConfigurer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configureMessageConverters</span><span class="params">(List&lt;HttpMessageConverter&lt;?&gt;&gt; converters)</span> &#123;</span><br><span class="line">        converters.add(<span class="keyword">new</span> <span class="title class_">MappingJackson2HttpMessageConverter</span>());</span><br><span class="line">        converters.add(<span class="keyword">new</span> <span class="title class_">MappingJackson2XmlHttpMessageConverter</span>());</span><br><span class="line">        converters.add(<span class="keyword">new</span> <span class="title class_">StringHttpMessageConverter</span>());</span><br><span class="line">        WebMvcConfigurer.<span class="built_in">super</span>.configureMessageConverters(converters);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="源码实现"><a href="#源码实现" class="headerlink" title="源码实现"></a>源码实现</h1><p>HttpMessageConverter<br><code>org.springframework.web.servlet.mvc.method.annotation.RequestResponseBodyMethodProcessor</code>解析请求参数的方法resolveArgument()和处理返回值的方法handleReturnValue()</p><p>在项目启动的时候通过WebMvcConfigurationSupport进行加载，当getMessageConverters()被调用的时候会通过configureMessageConverters()、addDefaultHttpMessageConverters()和extendMessageConverters()三个方法进行初始话消息转换器。生成的消息转换器放在List<HttpMessageConverter<?>&gt; messageConverters集合中</p><p>org.springframework.web.servlet.config.annotation.WebMvcConfigurationSupport</p><p>返回响应时，会通过下面的方法调用http message converter进行转换<br>org.springframework.web.method.support.HandlerMethodReturnValueHandlerComposite#handleReturnValue<br>C:/Users/Tsukasa/.m2/repository/org/springframework/spring-webmvc/5.3.24/spring-webmvc-5.3.24-sources.jar!/org/springframework/web/servlet/mvc/method/annotation/AbstractMessageConverterMethodProcessor.java:275</p><p>假如报<code>No converter for [class java.util.HashMap] with preset Content-Type &#39;null&#39;]</code>之类的错误，证明没有找到合适的Http Message Converter。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2023-10-25 01:13:29.928 [WARN ] [http-nio-8081-exec-2] [org.springframework.web.servlet.handler.AbstractHandlerExceptionResolver] [208] Resolved [org.springframework.http.converter.HttpMessageNotWritableException: No converter for [class java.util.HashMap] with preset Content-Type &#x27;null&#x27;]</span><br></pre></td></tr></table></figure><h1 id="扩展定制"><a href="#扩展定制" class="headerlink" title="扩展定制"></a>扩展定制</h1><p>整体思路分为三步：</p><p>1、继承AbstractHttpMessageConverter类，根据序列化和反序列化规则，重写构造、readInternal、writeInternal、supports等相关方法；<br>2、通过message-converter标签或者继承WebMvcConfigurerAdapter类，配置自定义的HTTP消息转换器；<br>3、编写Controller控制器，修改前端请求格式为自定义格式。</p><p>似乎在执行http message converter的读取和写入操作前后，通过RequestResponseBodyAdviceChain提供了一些切面操作，可以通过实现RequestBodyAdvice或者ResponseBodyAdvice的方法来在执行前后执行一些操作。</p><p>/org/springframework/web/servlet/mvc/method/annotation/AbstractMessageConverterMethodArgumentResolver.java:184</p><h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p><a href="https://juejin.cn/post/6844904020180467725?searchId=202310200110502954BBD54A37ECC284B9">SpringMVC03-HttpMessageConverter(自定义消息转换器)</a><br><a href="https://juejin.cn/post/7169590769789960205?searchId=202310200110502954BBD54A37ECC284B9">Spring Mvc：HttpMessageConverter 消息转换器</a><br><a href="https://juejin.cn/post/7265218003863420982?searchId=20231025011613BEBDA0C7A5C8446735C0">SpringMVC流程分析(七)：HttpMessageConverter——SpringMVC中的消息转换</a></p><blockquote><p>声明：本站所有文章均为原创或翻译，遵循<a href="https://creativecommons.org/licenses/by-nc-nd/4.0/deed.en">署名 - 非商业性使用 - 禁止演绎 4.0 国际许可协议</a>，如需转载请确保您对该协议有足够了解，并附上作者名 (Tsukasa) 及原文地址</p></blockquote>]]></content>
    
    
    <summary type="html">&lt;script src=&quot;&#92;assets&#92;js&#92;APlayer.min.js&quot;&gt; &lt;/script&gt;&lt;p&gt;文章主要讲解下Spring框架中的HTTP消息转换器message-converters的使用，Spring框架的HTTP消息转换器的主要作用是将HTTP请求和响应中的消息内容与Java对象之间进行相互转换（序列化与反序列化），这些消息转换器可以处理JSON、XML、文本、二进制等数据类型。&lt;/p&gt;</summary>
    
    
    
    <category term="编程开发" scheme="http://blog.tsukasa.moe/categories/%E7%BC%96%E7%A8%8B%E5%BC%80%E5%8F%91/"/>
    
    
    <category term="Java Web" scheme="http://blog.tsukasa.moe/tags/Java-Web/"/>
    
    <category term="Spring" scheme="http://blog.tsukasa.moe/tags/Spring/"/>
    
  </entry>
  
  <entry>
    <title>Windows中通过SMB协议共享文件允许局域网设备访问</title>
    <link href="http://blog.tsukasa.moe/2023/10/18/Use-SMB-protocol-to-share-files-in-windows-system/"/>
    <id>http://blog.tsukasa.moe/2023/10/18/Use-SMB-protocol-to-share-files-in-windows-system/</id>
    <published>2023-10-17T16:36:37.000Z</published>
    <updated>2023-10-17T18:08:21.354Z</updated>
    
    <content type="html"><![CDATA[<!-- excerpt --><!-- toc --><h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>家人各自手机拍了很多照片，需要定期归档整理到本地一台PC硬盘中，为了支持各自并行整理，通过Windows的网络文件共享协议，分享共享文件夹的方式，允许其他设备（PC、手机）访问读写，这样就不会出现两个人同时争用同一台电脑整理照片视频资源了。</p><h1 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h1><p>存放照片视频资源的PC开启SMB服务，通过创建一个合理权限的用户，创建一个共享的文件夹，开放给同一个局域网的设备进行连接，通过这个用户整理资源。</p><p>SMB：全名为Server Message Block，是一种网络文件共享协议，最初由IBM开发，后来被Microsoft广泛采用并成为Windows操作系统中文件和打印机共享的基础。SMB协议允许不同计算机上的应用程序之间共享文件和资源，通常用于局域网（LAN）和广域网（WAN）环境中。</p><h1 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h1><h2 id="1、启用SMB-1-0-CIFS文件共享支持功能"><a href="#1、启用SMB-1-0-CIFS文件共享支持功能" class="headerlink" title="1、启用SMB 1.0/CIFS文件共享支持功能"></a>1、启用SMB 1.0/CIFS文件共享支持功能</h2><p><code>控制面板\程序\程序和功能</code>中启用SMB 1.0/CIFS文件共享支持功能后，提示重启计算机后生效。</p><p><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202310180056423.png" alt=""></p><h2 id="2、启用网络发现和文件共享"><a href="#2、启用网络发现和文件共享" class="headerlink" title="2、启用网络发现和文件共享"></a>2、启用网络发现和文件共享</h2><p>PC重启完成后，在<code>控制面板\网络和 Internet\网络和共享中心\高级共享设置</code>启用网络发现和文件共享功能</p><p><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202310180053909.png" alt=""></p><p><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202310180054726.png" alt=""></p><p>这里面选用有密码保护的共享是为了确保安全，不然其他连上你wifi的人就可以随意访问你的照片视频，社死就不好了。<br>当然，如果只是临时分享下非私密资源后关闭，那么可以不设免密保护。</p><p><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202310180055448.png" alt=""></p><h2 id="3、启动FDResPub和fdPHost等相关依赖服务"><a href="#3、启动FDResPub和fdPHost等相关依赖服务" class="headerlink" title="3、启动FDResPub和fdPHost等相关依赖服务"></a>3、启动FDResPub和fdPHost等相关依赖服务</h2><p>按照下图，将<code>Function Discovery Resource Publication</code>和<code>Function Discovery Provider Host</code>这2个服务停止后，修改启动方式为自动后，点击启动。</p><p>注意这两个服务之间可能存在依赖关系，即停止fdPHost可能导致FDResPub服务也停止，因此启动后需再次检查2个服务是否都在运行中。</p><p><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202310180109329.png" alt=""></p><p>假如启动失败，可以检查下这2个服务的依赖列表，把对应依赖的服务也要跑起来。</p><p><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202310180110977.png" alt=""></p><h2 id="4、创建访问用户并分配合理权限"><a href="#4、创建访问用户并分配合理权限" class="headerlink" title="4、创建访问用户并分配合理权限"></a>4、创建访问用户并分配合理权限</h2><p>打开<code>计算机管理</code>，进入<code>本地用户和组</code>的<code>用户</code>标签页下，右键添加用户。</p><p><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202310180114493.png" alt=""></p><p>创建一个访问用户的用户名和密码，后面其他设备访问这台PC就是用的这个帐户。</p><p><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202310180117420.png" alt=""></p><h2 id="5、安全界面内设置共享文件夹的用户访问权限"><a href="#5、安全界面内设置共享文件夹的用户访问权限" class="headerlink" title="5、安全界面内设置共享文件夹的用户访问权限"></a>5、安全界面内设置共享文件夹的用户访问权限</h2><p>在需要共享的照片文件夹上右键，点击<code>安全</code>选项卡，添加新建的用户，并设置合理的访问权限，这里因为是家人使用，权限暂不做限制。</p><p><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202310180124024.png" alt=""></p><h2 id="6、共享界面内设置局域网内共享的文件夹和访问用户"><a href="#6、共享界面内设置局域网内共享的文件夹和访问用户" class="headerlink" title="6、共享界面内设置局域网内共享的文件夹和访问用户"></a>6、共享界面内设置局域网内共享的文件夹和访问用户</h2><p>在需要共享的照片文件夹上右键，点击<code>共享</code>选项卡，进入<code>高级共享设置</code>，选择可以通过SMB协议访问共享文件夹的用户和用户组。<br>如图所示则允许Azuki用户和Administrators用户组的用户通过SMB访问该计算机。</p><p><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202310180122971.png" alt=""></p><p>设置完成后并应用，回到<code>共享</code>选项卡界面，点击共享等待一会即可完成共享。</p><p><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202310180134348.png" alt=""></p><p><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202310180134855.png" alt=""></p><h2 id="7、其他设备访问共享文件夹"><a href="#7、其他设备访问共享文件夹" class="headerlink" title="7、其他设备访问共享文件夹"></a>7、其他设备访问共享文件夹</h2><p>只要设备支持SMB协议，则可以通过SMB访问到上面的PC共享文件夹。</p><h3 id="Windows电脑"><a href="#Windows电脑" class="headerlink" title="Windows电脑"></a>Windows电脑</h3><p><strong>方法1</strong></p><p>其他的Windows PC只要连接到同一个局域网，就可以在<code>网络</code>界面看到该电脑了，双击进去输入用户名和密码后，就和访问自己电脑上的文件夹一样访问共享文件夹了。可以确认下访问的权限是否符合预期。</p><p><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202310180136735.png" alt=""></p><p>也可以在共享文件夹上右键，映射共享文件夹到本地虚拟盘符，如Z盘，这样就和访问本地一个硬盘一样访问共享文件夹了。</p><p><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202310180141983.png" alt=""></p><p><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202310180144442.png" alt=""></p><p><strong>方法2</strong></p><p><code>Win+R</code>打开运行或者直接在文件管理器的地址栏输入<code>\\</code>+局域网下共享PC的IP地址或者计算机名，示例；<code>\\192.168.2.183</code>，在弹出的窗口输入用户名和密码，即可访问。</p><p><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202310180149762.png" alt=""></p><h3 id="手机"><a href="#手机" class="headerlink" title="手机"></a>手机</h3><p>现在很多手机文件管理器都支持SMB，以华为Mate 20 pro为例，打开文件管理器，打开<code>网络邻居</code>就可以看到共享资源的PC了，点击后会弹出窗口，输入用户名和密码就可以访问共享文件夹了。</p><p><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202310180156824.png" alt=""></p><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>虽说这个照片视频资源管理和共享方案并非最佳实践，比如本地与云盘同步问题，当前仅限局域网用户访问，也并非唯一的解决方案，如FTP同样可以实现类似的功能，但是已经满足我目前的需求了，更是没有必要搭建个NAS，后续如果有更进一步的需求再去搞好了，保持简洁易用。</p><blockquote><p>声明：本站所有文章均为原创或翻译，遵循<a href="https://creativecommons.org/licenses/by-nc-nd/4.0/deed.en">署名 - 非商业性使用 - 禁止演绎 4.0 国际许可协议</a>，如需转载请确保您对该协议有足够了解，并附上作者名 (Tsukasa) 及原文地址</p></blockquote>]]></content>
    
    
    <summary type="html">&lt;script src=&quot;&#92;assets&#92;js&#92;APlayer.min.js&quot;&gt; &lt;/script&gt;&lt;p&gt;家人各自手机拍了很多照片，需要定期归档整理到本地一台PC硬盘中，为了支持各自并行整理，通过Windows的网络文件共享协议，分享共享文件夹的方式，允许其他设备（PC、手机）访问读写，这样就不会出现两个人同时争用同一台电脑整理照片视频资源了。&lt;/p&gt;</summary>
    
    
    
    <category term="资源技巧" scheme="http://blog.tsukasa.moe/categories/%E8%B5%84%E6%BA%90%E6%8A%80%E5%B7%A7/"/>
    
    
    <category term="SMB" scheme="http://blog.tsukasa.moe/tags/SMB/"/>
    
  </entry>
  
  <entry>
    <title>校验下载资源的完整性</title>
    <link href="http://blog.tsukasa.moe/2023/10/17/Verify-the-integrity-of-downloaded-resource/"/>
    <id>http://blog.tsukasa.moe/2023/10/17/Verify-the-integrity-of-downloaded-resource/</id>
    <published>2023-10-17T15:43:42.000Z</published>
    <updated>2023-10-17T16:30:36.469Z</updated>
    
    <content type="html"><![CDATA[<!-- excerpt --><!-- toc --><p>网站上一些资源下载页面列表中，通常提供了一些Hash值，但自己没想过有什么用，最近有时间简单研究了下，其实目的是确保资源的完整性，避免下载过程中损坏或者被恶意攻击者替换。</p><h1 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h1><p>哈希算法通常通常用来校验文件的完整性，在密码学中，一般来说，不同的内容生成的Hash值不同（Hash碰撞的概率极低，可以认为），而相同的内容进行哈希后，得到唯一的Hash值。因此通过校验资源传输前后的Hash值，判断资源是否被篡改。</p><p>常见的Hash算法有：md5, sha1, sha256（推荐）, sha512</p><h1 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h1><p>网上资源的Hash值通常会在下载资源网站给出hash校验和，资源下载完全后，根据给定的hash算法计算hash值，与网站提供的hash校验和比对即可，相同则文件完整。<br>下面分别展示在不同操作系统的一些API：</p><p><strong>Windows</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Hash算法可以根据实际替换，支持SHA256、SHA1、MD5</span></span><br><span class="line">Get-FileHash 文件名.exe -Algorithm SHA256</span><br></pre></td></tr></table></figure><p>以下载<a href="https://repo.jellyfin.org/releases/server/windows/stable/">Jellyfin</a>作为示例：</p><p><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202310180006974.png" alt=""></p><p>对比两个Hash值一致，说明下载文件完整。</p><p><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202310180009996.png" alt=""></p><p><strong>Linux/Git bash</strong></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">md5sum</span> 文件名</span><br><span class="line"><span class="built_in">sha1sum</span> 文件名</span><br><span class="line"><span class="built_in">sha256sum</span> 文件名</span><br><span class="line"><span class="built_in">sha512sum</span> 文件名</span><br></pre></td></tr></table></figure><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>这个知识点很简单，平常时我们工作也经常通过hash算法来作消息摘要，密码存储，签名，这些都属于密码学的范畴，而这个校验资源传输前后的完整性也是其中一个应用而已，一些下载软件、压缩软件本身也内置了对文件完整性的校验，思想是相同的，想到某位大佬说的一句话：对于程序员来说，最为重要的知识其实是核心设计原则以及对计算机体系的理解，有了切身体会。</p><blockquote><p>声明：本站所有文章均为原创或翻译，遵循<a href="https://creativecommons.org/licenses/by-nc-nd/4.0/deed.en">署名 - 非商业性使用 - 禁止演绎 4.0 国际许可协议</a>，如需转载请确保您对该协议有足够了解，并附上作者名 (Tsukasa) 及原文地址</p></blockquote>]]></content>
    
    
    <summary type="html">&lt;script src=&quot;&#92;assets&#92;js&#92;APlayer.min.js&quot;&gt; &lt;/script&gt;&lt;p&gt;网站上一些资源下载页面列表中，通常提供了一些Hash值，但自己没想过有什么用，最近有时间简单研究了下，其实目的是确保资源的完整性，避免下载过程中损坏或者被恶意攻击者替换。&lt;/p&gt;</summary>
    
    
    
    <category term="资源技巧" scheme="http://blog.tsukasa.moe/categories/%E8%B5%84%E6%BA%90%E6%8A%80%E5%B7%A7/"/>
    
    
    <category term="哈希算法" scheme="http://blog.tsukasa.moe/tags/%E5%93%88%E5%B8%8C%E7%AE%97%E6%B3%95/"/>
    
  </entry>
  
  <entry>
    <title>JVM调优基础</title>
    <link href="http://blog.tsukasa.moe/2023/10/12/JVM%E8%B0%83%E4%BC%98%E5%9F%BA%E7%A1%80/"/>
    <id>http://blog.tsukasa.moe/2023/10/12/JVM%E8%B0%83%E4%BC%98%E5%9F%BA%E7%A1%80/</id>
    <published>2023-10-11T17:08:21.000Z</published>
    <updated>2023-10-11T19:16:51.688Z</updated>
    
    <content type="html"><![CDATA[<!-- excerpt --><!-- toc --><p>这篇文章讲解下JVM调优基础知识，后面会再单独开一篇文章讲解下JVM调优的思路。</p><p>JVM（Java虚拟机）调优是优化Java应用程序性能和内存使用的过程。调优可以帮助应用程序更有效地利用内存、提高吞吐量和降低延迟。</p><h1 id="JVM调优的参数都有哪些？"><a href="#JVM调优的参数都有哪些？" class="headerlink" title="JVM调优的参数都有哪些？"></a>JVM调优的参数都有哪些？</h1><p>JVM调优的目标是什么？通过JVM的学习，我们知道频繁的GC会导致程序挂起，垃圾回收占用CPU资源，因此性能调优中就包括对内存的优化，减少GC。</p><p>JVM调优主要就是调整年轻代、老年代、元空间的内存空间大小及使用的垃圾回收器类型。</p><h2 id="堆分配参数"><a href="#堆分配参数" class="headerlink" title="堆分配参数"></a>堆分配参数</h2><p>示例：-Xms20M -Xmx20M -Xmn10M -XX:+PrintGCDetails -XX:SurvivorRatio=8</p><table><thead><tr><th style="text-align:center">Params</th><th style="text-align:center">Description</th></tr></thead><tbody><tr><td style="text-align:center">Xms</td><td style="text-align:center">最小堆容量</td></tr><tr><td style="text-align:center">Xmx</td><td style="text-align:center">最大堆容量</td></tr><tr><td style="text-align:center">Xmn</td><td style="text-align:center">新生代容量 &lt;==&gt; Eden + Survivor A + Survivor B</td></tr><tr><td style="text-align:center">PrintGCDetail</td><td style="text-align:center">记录GC日志</td></tr><tr><td style="text-align:center">SurvivorRatio</td><td style="text-align:center">新生代中Eden与Survivor区域的比值，默认值为8</td></tr><tr><td style="text-align:center">PretenureSizeThreshold</td><td style="text-align:center">对象大小大于该值，直接分配至老年代</td></tr><tr><td style="text-align:center">MaxTenuringThreshold</td><td style="text-align:center">大于该阈值时晋升至老年代，默认值为15</td></tr><tr><td style="text-align:center">HandlePromotionFailure</td><td style="text-align:center">是否允许担保失败</td></tr><tr><td style="text-align:center">ParalleGCThreads</td><td style="text-align:center">设置并行GC时进行内存回收的线程数</td></tr></tbody></table><h1 id="JVM调优思路"><a href="#JVM调优思路" class="headerlink" title="JVM调优思路"></a>JVM调优思路</h1><h2 id="1、内存管理"><a href="#1、内存管理" class="headerlink" title="1、内存管理"></a>1、内存管理</h2><p><strong>堆内存设置</strong></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -Xms512m -Xmx2g -jar your-application.jar</span><br></pre></td></tr></table></figure><p><strong>永生代/元数据区大小</strong></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -XX:MaxMetaspaceSize=256m -jar your-application.jar</span><br></pre></td></tr></table></figure><h2 id="2、垃圾回收"><a href="#2、垃圾回收" class="headerlink" title="2、垃圾回收"></a>2、垃圾回收</h2><p><strong>选择合适的垃圾收集器</strong></p><p>根据硬件配置如CPU核数线程数，以及应用程序的特性，不同内存区域的垃圾收集，选择合适的垃圾收集器，如G1、CMS、Parallel等</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">java -XX:+UseG1GC -jar your-application.jar</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>垃圾回收日志： 启用垃圾回收日志以进行性能分析和调优。</strong></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">java -Xloggc:gc.log -XX:+PrintGCDetails -XX:+PrintGCDateStamps -jar your-application.jar</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="3、线程管理"><a href="#3、线程管理" class="headerlink" title="3、线程管理"></a>3、线程管理</h2><p><strong>线程栈大小：根据应用程序的线程需求设置线程栈大小。</strong></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -Xss256k -jar your-application.jar</span><br></pre></td></tr></table></figure><p><strong>并发线程数： 根据硬件配置和应用程序性质设置并发线程数。</strong></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -XX:ParallelGCThreads=4 -jar your-application.jar</span><br></pre></td></tr></table></figure><h2 id="4、代码优化"><a href="#4、代码优化" class="headerlink" title="4、代码优化"></a>4、代码优化</h2><p>性能分析： 使用性能分析工具（如VisualVM、YourKit）来识别和优化性能瓶颈。示例：</p><p>bash<br>Copy code<br>jvisualvm<br>代码检查： 使用静态分析工具（如Checkstyle、FindBugs）检查代码质量，消除潜在的性能问题。</p><h2 id="5、内存泄漏分析"><a href="#5、内存泄漏分析" class="headerlink" title="5、内存泄漏分析"></a>5、内存泄漏分析</h2><h2 id="6、堆转储文件"><a href="#6、堆转储文件" class="headerlink" title="6、堆转储文件"></a>6、堆转储文件</h2><p>在内存溢出（OOM）时生成堆转储文件，以进行分析。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">java -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/path/to/dump.hprof -jar your-application.jar</span><br><span class="line"></span><br></pre></td></tr></table></figure><h1 id="实践"><a href="#实践" class="headerlink" title="实践"></a>实践</h1><h2 id="堆分配参数一"><a href="#堆分配参数一" class="headerlink" title="堆分配参数一"></a>堆分配参数一</h2><table><thead><tr><th style="text-align:center">Command</th><th style="text-align:center">Description</th></tr></thead><tbody><tr><td style="text-align:center">-XX:+PrintGC</td><td style="text-align:center">虚拟机启动后，只要遇到GC就会打印日志</td></tr><tr><td style="text-align:center">-XX:+UseSerialGC</td><td style="text-align:center">配置串行回收器</td></tr><tr><td style="text-align:center">-XX:+PrintCommandLineFlags</td><td style="text-align:center">在控制台输出JVM的配置参数。</td></tr><tr><td style="text-align:center">-XX:+PrintGCDetails</td><td style="text-align:center">可以查看详细信息，包括各个区的情况</td></tr><tr><td style="text-align:center">-Xms5m</td><td style="text-align:center">设置最小堆大小为5M</td></tr><tr><td style="text-align:center">-Xmx20M</td><td style="text-align:center">设置最大堆大小为20M</td></tr></tbody></table><p>实际工作中，可以将初始的堆大小与最大堆大小设置相等，好处是可以减少程序运行时的垃圾回收次数。通常是配置在Tomcat中，如catalina.sh</p><h2 id="堆分配参数二"><a href="#堆分配参数二" class="headerlink" title="堆分配参数二"></a>堆分配参数二</h2><table><thead><tr><th style="text-align:center">Command</th><th style="text-align:center">Description</th></tr></thead><tbody><tr><td style="text-align:center">-Xmn5M</td><td style="text-align:center">设置新生代的大小为5M，年老代+新生代大小=堆大小，这个参数对系统性能和GC行为有较大的影响，新生代大小一般设置为堆空间的1/3到1/4左右</td></tr><tr><td style="text-align:center">-XX:SurvivorRatio</td><td style="text-align:center">设置新生代中eden空间和from或to空间的比例（from和to空间大小相同），<code>含义：-XX:SurvivorRatio=eden/from=eden/to</code></td></tr><tr><td style="text-align:center">-XX:NewRatio</td><td style="text-align:center">除了可以通过<code>-Xmn</code>参数设置新生代的绝对大小，还可以<code>-XX:NewRatio</code>通过设置新生代和年老代的比例：<code>-XX:NewRatio=老年代/新生代</code></td></tr></tbody></table><p>实际工作中，应该根据系统的特点做出合理配置，基本策略：尽可能将对象预留在新生代，减少老年代的GC次数。比如系统内的实例对象大多是一直使用，那么老年代可以分配大一些。</p><h2 id="堆溢出处理"><a href="#堆溢出处理" class="headerlink" title="堆溢出处理"></a>堆溢出处理</h2><p>如果堆空间不足，可以出现OOM报错，可以通过</p><table><thead><tr><th style="text-align:center">Command</th><th style="text-align:center">Description</th></tr></thead><tbody><tr><td style="text-align:center">-XX:+HeapDumpOnOutOfMemoryError</td><td style="text-align:center">可以在内存溢出时与下面的参数配合，导出整个堆信息</td></tr><tr><td style="text-align:center">-XX:HeapDumpPath</td><td style="text-align:center">设置导出堆的存放路径</td></tr></tbody></table><p>内存分析工具：Eclipse Memory Analyzer (MAT)、VisualVM、jmap命令</p><h2 id="Java栈配置"><a href="#Java栈配置" class="headerlink" title="Java栈配置"></a>Java栈配置</h2><table><thead><tr><th style="text-align:center">Command</th><th style="text-align:center">Description</th></tr></thead><tbody><tr><td style="text-align:center">-Xss</td><td style="text-align:center">指定线程的最大栈空间，决定了函数可调用的最大深度</td></tr></tbody></table><h2 id="方法区"><a href="#方法区" class="headerlink" title="方法区"></a>方法区</h2><table><thead><tr><th style="text-align:center">Command</th><th style="text-align:center">Description</th></tr></thead><tbody><tr><td style="text-align:center">-XX:MaxPermSize</td><td style="text-align:center">方法区最大大小，默认为64MB，如果运行时产生大量的类，就需要设置一个相对合适的方法去，避免出现永久区OOM问题</td></tr></tbody></table><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-XX:PermSize=64M -XX:MaxPermSize=64MB</span><br></pre></td></tr></table></figure><h2 id="直接内存配置"><a href="#直接内存配置" class="headerlink" title="直接内存配置"></a>直接内存配置</h2><p>NIO中用得较多</p><p>-XX:MaxDirectMemorySize，如果不设置，默认值为最大堆空间即-Xmx，直接内存到达上限后就会触发垃圾回收，也会导致OOM。</p><h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p><a href="https://www.oracle.com/java/technologies/javase/vmoptions-jsp.html">Java HotSpot VM Options</a><br><a href="https://www.cnblogs.com/redcreen/archive/2011/05/04/2037057.html">JVM系列三:JVM参数设置、分析</a></p><blockquote><p>声明：本站所有文章均为原创或翻译，遵循<a href="https://creativecommons.org/licenses/by-nc-nd/4.0/deed.en">署名 - 非商业性使用 - 禁止演绎 4.0 国际许可协议</a>，如需转载请确保您对该协议有足够了解，并附上作者名 (Tsukasa) 及原文地址</p></blockquote>]]></content>
    
    
    <summary type="html">&lt;script src=&quot;&#92;assets&#92;js&#92;APlayer.min.js&quot;&gt; &lt;/script&gt;&lt;p&gt;文章摘要&lt;/p&gt;</summary>
    
    
    
    <category term="编程开发" scheme="http://blog.tsukasa.moe/categories/%E7%BC%96%E7%A8%8B%E5%BC%80%E5%8F%91/"/>
    
    
    <category term="JVM" scheme="http://blog.tsukasa.moe/tags/JVM/"/>
    
    <category term="性能优化" scheme="http://blog.tsukasa.moe/tags/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/"/>
    
  </entry>
  
  <entry>
    <title>Redis系列-Window和Linux安装配置Redis</title>
    <link href="http://blog.tsukasa.moe/2023/09/24/Redis%E7%B3%BB%E5%88%97-Windows%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AERedis/"/>
    <id>http://blog.tsukasa.moe/2023/09/24/Redis%E7%B3%BB%E5%88%97-Windows%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AERedis/</id>
    <published>2023-09-24T13:33:56.000Z</published>
    <updated>2023-09-25T06:45:55.784Z</updated>
    
    <content type="html"><![CDATA[<!-- excerpt --><!-- toc --><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>Redis是分布式缓存数据库，这篇文章记录下Windows 10和Centos 7下Redis的安装配置。</p><h1 id="Windows-10"><a href="#Windows-10" class="headerlink" title="Windows 10"></a>Windows 10</h1><h2 id="下载并解压到安装目录"><a href="#下载并解压到安装目录" class="headerlink" title="下载并解压到安装目录"></a>下载并解压到安装目录</h2><p>下载Redis，解压到安装目录</p><p><a href="https://github.com/MicrosoftArchive/redis/releases">Github下载地址</a></p><h2 id="配置环境变量并注册成服务"><a href="#配置环境变量并注册成服务" class="headerlink" title="配置环境变量并注册成服务"></a>配置环境变量并注册成服务</h2><p>环境变量配置</p><p><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202309242147280.png" alt=""></p><p>注册成服务并启动Redis服务：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">redis-server --service-install redis.windows-service.conf --loglevel verbose</span><br><span class="line">net start redis</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202309242145331.png" alt=""></p><p>测试客户端功能正常</p><p><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202309242151194.png" alt=""></p><h2 id="设置密码"><a href="#设置密码" class="headerlink" title="设置密码"></a>设置密码</h2><p>设置临时密码：<code>config set requirepass &quot;admin&quot;</code>后，执行<code>auth admin</code>即可登陆。</p><p><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202309242158453.png" alt=""></p><h2 id="配置远程连接"><a href="#配置远程连接" class="headerlink" title="配置远程连接"></a>配置远程连接</h2><p>远程连接命令：<code>redis-cli -h IP地址 -p 端口号 -a 密码</code>，默认ip地址为127.0.0.1，默认端口为6379。</p><p><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202309251432967.png" alt=""></p><p>当然要进行远程访问，需要进行下面2个配置。</p><h3 id="Redis绑定IP配置"><a href="#Redis绑定IP配置" class="headerlink" title="Redis绑定IP配置"></a>Redis绑定IP配置</h3><p>Redis配置文件默认绑定本地IP，只能从本地发起连接，如果想要让远程服务发起连接，可以将下面的<code>bind 127.0.0.1</code>一行注释掉，或者添加需要访问redis缓存的服务器地址。</p><p><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202309242209963.png" alt=""></p><h3 id="添加防火墙入站规则"><a href="#添加防火墙入站规则" class="headerlink" title="添加防火墙入站规则"></a>添加防火墙入站规则</h3><p><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202309251430294.png" alt=""></p><h1 id="Centos-7"><a href="#Centos-7" class="headerlink" title="Centos 7"></a>Centos 7</h1><h2 id="离线下载安装包"><a href="#离线下载安装包" class="headerlink" title="离线下载安装包"></a>离线下载安装包</h2><p>查找需要安装的Redis版本：<code>http://download.redis.io/releases/</code>，我选择了7.0.8版本。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /export/download</span><br><span class="line">wget http://download.redis.io/releases/redis-7.0.8.tar.gz</span><br></pre></td></tr></table></figure><h2 id="解压安装"><a href="#解压安装" class="headerlink" title="解压安装"></a>解压安装</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -zvxf redis-7.0.8.tar.gz</span><br></pre></td></tr></table></figure><h2 id="构建测试并安装"><a href="#构建测试并安装" class="headerlink" title="构建测试并安装"></a>构建测试并安装</h2><p>执行make进行构建时，如果提示缺少什么依赖就下载更新什么依赖即可。可以通过yum命令下载安装。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> redis</span><br><span class="line">sudo make</span><br><span class="line"><span class="comment"># 下面执行测试，时间较长</span></span><br><span class="line">sudo make <span class="built_in">test</span></span><br><span class="line">sudo make install PREFIX=/usr/local/redis</span><br></pre></td></tr></table></figure><h2 id="复制并修改Redis配置文件"><a href="#复制并修改Redis配置文件" class="headerlink" title="复制并修改Redis配置文件"></a>复制并修改Redis配置文件</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> /usr/local/redis/etc</span><br><span class="line"><span class="built_in">cp</span> /export/download/redis/redis.conf /usr/local/redis/etc</span><br></pre></td></tr></table></figure><p>修改Redis配置通常有2种方式，一种是在redis-cli客户端种进行，这种默认是直接生效的，如果修改的配置文件，需要重启Redis使修改生效。</p><p>编辑redis.conf配置文件，修改daemonize为yes，设置为后台启动。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">daemonize <span class="built_in">yes</span></span><br></pre></td></tr></table></figure><p>可以通过<code>config get protected-mode</code>命令获取该参数的配置，protected-mode默认为yes，表示Redis仅允许本地连接<strong>或者</strong>通过密码验证的连接访问，一般设置为yes。</p><h2 id="添加开机自启"><a href="#添加开机自启" class="headerlink" title="添加开机自启"></a>添加开机自启</h2><p>在/etc/rc.local中追加开机自启，需要sudo权限。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/rc.local</span><br><span class="line">/usr/local/redis/bin/redis-server /usr/local/redis/etc/redis.conf </span><br></pre></td></tr></table></figure><h2 id="启动Redis"><a href="#启动Redis" class="headerlink" title="启动Redis"></a>启动Redis</h2><p>复制redis-cli,redis-server到/usr/local/bin/目录下，类似Windows的环境变量配置，允许redis命令在其他目录下直接使用。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cp</span> /usr/local/redis/bin/redis-server /usr/local/bin/</span><br><span class="line"><span class="built_in">cp</span> /usr/local/redis/bin/redis-cli /usr/local/bin/</span><br><span class="line">/usr/local/redis/bin/redis-server /usr/local/redis/etc/redis.conf </span><br></pre></td></tr></table></figure><h2 id="设置Redis密码"><a href="#设置Redis密码" class="headerlink" title="设置Redis密码"></a>设置Redis密码</h2><p>设置完密码后和Windows一样进行Redis连接即可。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">config <span class="built_in">set</span> requirepass &lt;密码&gt;</span><br></pre></td></tr></table></figure><h2 id="远程连接配置"><a href="#远程连接配置" class="headerlink" title="远程连接配置"></a>远程连接配置</h2><p>主要涉及防火墙配置，以及Redis配置文件修改bind ip，修改完成后重启即可。Centos防火墙配置为firewall-cmd</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 防火墙配置</span></span><br><span class="line">sudo firewall-cmd --add-port=6379/tcp --permanent</span><br><span class="line">sudo firewall-cmd --reload</span><br><span class="line">sudo firewall-cmd --list-ports</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启Redis服务</span></span><br><span class="line">pkill redis</span><br><span class="line">/usr/local/redis/bin/redis-server /usr/local/redis/etc/redis.conf </span><br></pre></td></tr></table></figure><h1 id="Redis无法连接问题排查"><a href="#Redis无法连接问题排查" class="headerlink" title="Redis无法连接问题排查"></a>Redis无法连接问题排查</h1><p>1、检查Redis服务是否启动</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 执行下面命令返回PONG则已启动</span></span><br><span class="line">redis-cli -h 192.168.2.99 -p 6379 ping</span><br></pre></td></tr></table></figure><p>2、防火墙问题</p><p>检查防火墙规则，是否允许通过tcp协议访问Redis的6379端口，正常通过telnet可以连接该</p><p>如果防火墙使用的是iptables，执行下面的命令允许访问redis端口。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo iptables -L</span><br><span class="line">sudo iptables -A INPUT -p tcp --dport 6379 -j ACCEPT</span><br><span class="line"><span class="comment"># Centso</span></span><br><span class="line">sudo service iptables save</span><br></pre></td></tr></table></figure><p>如果使用的是firewalld，执行下面的命令允许访问redis端口。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看防火墙规则</span></span><br><span class="line">sudo firewall-cmd --list-ports</span><br><span class="line">sudo firewall-cmd --add-port=6379/tcp --permanent</span><br><span class="line">sudo firewall-cmd --reload</span><br></pre></td></tr></table></figure><p>如果防火墙没有启动，执行下面命令启动防火墙</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl <span class="built_in">enable</span> firewalld</span><br><span class="line">sudo systemctl start firewalld</span><br></pre></td></tr></table></figure><p>配置成功后可以通过telnet命令验证是否可以正常连接</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">telnet &lt;Windows_IP&gt; 6379</span><br></pre></td></tr></table></figure><p>3、Redis服务器配置的IP和端口是否正确</p><p>确认bind和port配置，看是否在白名单中，又或者允许所有ip访问。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">bind</span> 192.168.2.99</span><br><span class="line">port 6379</span><br></pre></td></tr></table></figure><h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p>[Windows-Redis安装与配置<a href="https://juejin.cn/post/7043684887773052965?searchId=202309242122437CD4714D3D22884226F3"></a><br><a href="https://juejin.cn/post/7212164132794662968?searchId=202309242122437CD4714D3D22884226F3">Windows Redis msi方式安装</a></p><blockquote><p>声明：本站所有文章均为原创或翻译，遵循<a href="https://creativecommons.org/licenses/by-nc-nd/4.0/deed.en">署名 - 非商业性使用 - 禁止演绎 4.0 国际许可协议</a>，如需转载请确保您对该协议有足够了解，并附上作者名 (Tsukasa) 及原文地址</p></blockquote>]]></content>
    
    
    <summary type="html">&lt;script src=&quot;&#92;assets&#92;js&#92;APlayer.min.js&quot;&gt; &lt;/script&gt;&lt;p&gt;文章记录下Windows 10和Centos 7下Redis的安装配置。&lt;/p&gt;</summary>
    
    
    
    <category term="编程开发" scheme="http://blog.tsukasa.moe/categories/%E7%BC%96%E7%A8%8B%E5%BC%80%E5%8F%91/"/>
    
    
    <category term="Redis" scheme="http://blog.tsukasa.moe/tags/Redis/"/>
    
    <category term="分布式缓存" scheme="http://blog.tsukasa.moe/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E7%BC%93%E5%AD%98/"/>
    
  </entry>
  
  <entry>
    <title>Spring框架学习系列 - IOC容器是如何工作的</title>
    <link href="http://blog.tsukasa.moe/2023/08/06/Spring-Learning-series-How-does-IOC-container-work/"/>
    <id>http://blog.tsukasa.moe/2023/08/06/Spring-Learning-series-How-does-IOC-container-work/</id>
    <published>2023-08-06T08:09:33.000Z</published>
    <updated>2023-10-11T03:57:31.085Z</updated>
    
    <content type="html"><![CDATA[<!-- excerpt --><!-- toc --><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>这篇文章主要从Spring IoC容器的角度进行切入，了解Spring是如何工作的。</p><h1 id="Spring-IOC容器构建过程"><a href="#Spring-IOC容器构建过程" class="headerlink" title="Spring IOC容器构建过程"></a>Spring IOC容器构建过程</h1><p><code>org.springframework.context.support.AbstractApplicationContext#refresh</code>核心代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">refresh</span><span class="params">()</span> <span class="keyword">throws</span> BeansException, IllegalStateException &#123;</span><br><span class="line"><span class="keyword">synchronized</span> (<span class="built_in">this</span>.startupShutdownMonitor) &#123;</span><br><span class="line"><span class="comment">// Prepare this context for refreshing.</span></span><br><span class="line">prepareRefresh();</span><br><span class="line"><span class="comment">// Tell the subclass to refresh the internal bean factory.</span></span><br><span class="line"><span class="type">ConfigurableListableBeanFactory</span> <span class="variable">beanFactory</span> <span class="operator">=</span> obtainFreshBeanFactory();</span><br><span class="line"><span class="comment">// Prepare the bean factory for use in this context.</span></span><br><span class="line">prepareBeanFactory(beanFactory);</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">// Allows post-processing of the bean factory in context subclasses.</span></span><br><span class="line">postProcessBeanFactory(beanFactory);</span><br><span class="line"><span class="comment">// Invoke factory processors registered as beans in the context.</span></span><br><span class="line">invokeBeanFactoryPostProcessors(beanFactory);</span><br><span class="line"><span class="comment">// Register bean processors that intercept bean creation.</span></span><br><span class="line">registerBeanPostProcessors(beanFactory);</span><br><span class="line"><span class="comment">// Initialize message source for this context.</span></span><br><span class="line">initMessageSource();</span><br><span class="line"><span class="comment">// Initialize event multicaster for this context.</span></span><br><span class="line">initApplicationEventMulticaster();</span><br><span class="line"><span class="comment">// Initialize other special beans in specific context subclasses.</span></span><br><span class="line">onRefresh();</span><br><span class="line"><span class="comment">// Check for listener beans and register them.</span></span><br><span class="line">registerListeners();</span><br><span class="line"><span class="comment">// Instantiate all remaining (non-lazy-init) singletons.</span></span><br><span class="line">finishBeanFactoryInitialization(beanFactory);</span><br><span class="line"><span class="comment">// Last step: publish corresponding event.</span></span><br><span class="line">finishRefresh();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (BeansException ex) &#123;</span><br><span class="line">logger.warn(<span class="string">&quot;Exception encountered during context initialization - cancelling refresh attempt&quot;</span>, ex);</span><br><span class="line"><span class="comment">// Destroy already created singletons to avoid dangling resources.</span></span><br><span class="line">destroyBeans();</span><br><span class="line"><span class="comment">// Reset &#x27;active&#x27; flag.</span></span><br><span class="line">cancelRefresh(ex);</span><br><span class="line"><span class="comment">// Propagate exception to caller.</span></span><br><span class="line"><span class="keyword">throw</span> ex;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="invokeBeanFactoryPostProcessors"><a href="#invokeBeanFactoryPostProcessors" class="headerlink" title="invokeBeanFactoryPostProcessors"></a>invokeBeanFactoryPostProcessors</h2><p><code>invokeBeanFactoryPostProcessors</code>方法主要是获取<code>BeanFactoryPostProcessor</code>接口的子类，并执行它的<code>postProcessBeanFactory</code>方法:</p><p><code>org.springframework.beans.factory.config.BeanFactoryPostProcessor#postProcessBeanFactory</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">postProcessBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException;</span><br></pre></td></tr></table></figure><h2 id="registerBeanPostProcessors"><a href="#registerBeanPostProcessors" class="headerlink" title="registerBeanPostProcessors"></a>registerBeanPostProcessors</h2><p><code>registerBeanPostProcessors</code>方法可以获取用户定义的<code>BeanPostProcessor</code>的子类，并把他们注册到<code>BeanFactory</code>对象中的<code>beanPostProcessors</code>变量中。<code>org.springframework.beans.factory.config.BeanPostProcessor</code>接口声明了2个方法：<code>postProcessBeforeInitialization</code>，<code>postProcessAfterInitialization</code>，在Bean初始化时执行用户自定义的操作。</p><h2 id="finishBeanFactoryInitialization"><a href="#finishBeanFactoryInitialization" class="headerlink" title="finishBeanFactoryInitialization"></a>finishBeanFactoryInitialization</h2><p>Bean的实例化代码逻辑，里面涉及一个FactoryBean，一个特殊的工厂bean，用于产生Bean。通常地，通过继承FactoryBean，实现其getObject方法，用户可以产生该类实例对象的方法。Spring获取FactoryBean本身的对象是通过在前面加上<code>&amp;</code>来完成。经常用来整合第三方框架。</p><p>Bean的实例创建流程比较复杂，可以查看流程图</p><h2 id="Bean存储在beanDefinitionMap中"><a href="#Bean存储在beanDefinitionMap中" class="headerlink" title="Bean存储在beanDefinitionMap中"></a>Bean存储在beanDefinitionMap中</h2><p>其中<code>BeanDefinition</code>接口是Bean的定义对象，Bean实例化之后存放在Spring容器中，维护在<code>DefaultListableBeanFactory#beanDefinitionMap</code>属性中，key默认是首字母小写的类名，value是一个BeanDefinition子类对象。</p><p><code>org.springframework.beans.factory.support.DefaultListableBeanFactory#beanDefinitionMap</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">private final Map&lt;String, BeanDefinition&gt; beanDefinitionMap = new ConcurrentHashMap&lt;String, BeanDefinition&gt;(64);</span><br></pre></td></tr></table></figure><h2 id="Bean如何加载到Spring容器中？"><a href="#Bean如何加载到Spring容器中？" class="headerlink" title="Bean如何加载到Spring容器中？"></a>Bean如何加载到Spring容器中？</h2><p>通过<code>org.springframework.beans.factory.support.BeanDefinitionReader</code>的子类来实现，XML配置文件，注解的方式标识需要Spring容器管理的Bean，有对应的<code>BeanDefinitionReader</code>进行加载。</p><h2 id="几个BeanFactory子列"><a href="#几个BeanFactory子列" class="headerlink" title="几个BeanFactory子列"></a>几个BeanFactory子列</h2><table><thead><tr><th style="text-align:left">类</th><th style="text-align:left">简介</th></tr></thead><tbody><tr><td style="text-align:left">ClassPathXmlApplicationContext</td><td style="text-align:left">通过读取类路径下的XMl配置文件创建IOC容器对象</td></tr><tr><td style="text-align:left">FileSystemXmlApplicationContext</td><td style="text-align:left">通过读取文件系统路径下的XMl配置文件创建IOC容器对象</td></tr><tr><td style="text-align:left">ConfigurableApplicationContext</td><td style="text-align:left">ApplicationContext的子接口，包含一些扩展方法refresh()和close()，让ApplicationContext具有启动、关闭和刷新上下文的能力</td></tr><tr><td style="text-align:left">WebApplicationContext</td><td style="text-align:left">基于Web环境创建IOC容器，将对象存入ServletContext中</td></tr></tbody></table><h2 id="Bean的生命周期"><a href="#Bean的生命周期" class="headerlink" title="Bean的生命周期"></a>Bean的生命周期</h2><h1 id="最佳实践"><a href="#最佳实践" class="headerlink" title="最佳实践"></a>最佳实践</h1><h1 id="代码工程"><a href="#代码工程" class="headerlink" title="代码工程"></a>代码工程</h1><hr><h1 id="Spring基本概念"><a href="#Spring基本概念" class="headerlink" title="Spring基本概念"></a>Spring基本概念</h1><p>1、IOC注入的三种方式</p><ul><li>构造方法</li><li>setter方法</li><li>接口注入</li></ul><p>注入有2层含义：<br>（1）将依赖的对象通过Spring容器注入进来；<br>（2）生成当前对象实例后注入到容器中（非必须）</p><p>注入是指，如果当前对象有依赖于其他对象实例，不再通过new的方式创建，而是直接从Spring容器中获取。</p><p>而从容器中获取的实例是否是同一个，涉及到对象的scope</p><p>2、对象的scope有几种<br>有3种：singleton单例，prototype多实例，session一次会话是相同的实例，不同的会话是不同的实例。</p><p>3、什么是控制反转IoC（Inversion of controll）<br>将原来通过new关键字创建对象实例的方式，改成直接从Spring容器中获取对象实例。</p><p>4、IoC的好处是什么？<br>好处是不用再关心依赖类的实例化，而是直接从容器中获取，从而直接使用被依赖对象提供的服务。</p><h1 id="IoC容器如何管理对象间的依赖关系"><a href="#IoC容器如何管理对象间的依赖关系" class="headerlink" title="IoC容器如何管理对象间的依赖关系"></a>IoC容器如何管理对象间的依赖关系</h1><p>1、有哪些管理对象间依赖的方式？</p><ul><li>直接编码，进行对象绑定 –&gt; 不符合IoC的理念，因此Spring主要是通过下面2种方式进行对象间依赖关系的管理</li><li>配置文件，通常用xml</li><li>元数据方式</li></ul><h1 id="IoC容器"><a href="#IoC容器" class="headerlink" title="IoC容器"></a>IoC容器</h1><p>1、Spring有哪些IoC容器？</p><ul><li>BeanFactory</li><li>ApplicationContext</li></ul><p>BeanFactory容器特点：<br>默认延迟初始化策略（懒加载lazy-load），启动初期所需资源少，速度快</p><p>ApplicationContext容器特点：<br>在BeanFactory的基础上构建，还提供了更高级的特性，如事件发布、国际化信息处理等<br>容器启动后，默认全部初始化并完成绑定，前期所需系统资源多，启动速度较慢</p><p>这2个容器都是接口</p><p>2、ApplicationContext与BeanFactory的关系是怎样的？ApplicationContext容器如何实现比BeanFactory更丰富的功能？ — 同样的问题</p><p>ApplicationContext间接继承BeanFactory，自然拥有BeanFactory的功能，此外还继承了其他三个接口：ApplicationEventPublisher，ResourceLoader，MessageSource，因此多出来的功能是通过三个接口抽象定义的。</p><p>3、BeanFactory与ApplicationContext分别如何进行构建？</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">BeanFactory</span> <span class="variable">bf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XmlBeanFactory</span>(<span class="string">&quot;配置文件路径&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">ApplicationContext</span> <span class="variable">ac</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;配置文件路径&quot;</span>);</span><br><span class="line"><span class="comment">// 或者根据下面的方式构建</span></span><br><span class="line"><span class="type">ApplicationContext</span> <span class="variable">ac</span> <span class="operator">=</span>  <span class="keyword">new</span> <span class="title class_">FileSystemXmlApplicatiionContext</span>(<span class="string">&quot;配置文件路径&quot;</span>)</span><br></pre></td></tr></table></figure><p>4、是不是所有的对象实例都应该通过Bean容器进行管理？</p><p>当然不是，通常来说只有需要对外提供服务的对象实例要通过Spring容器管理起来</p><p>5、Bean如何被注入Spring容器？—阅读源代码</p><p>todo</p><p>6、BeanDefinitionRegistry和BeanDefinitionReader类之间的关系？或者说Spring如何实现同一个的外部配置文件加载？</p><p>BeanDefinitionReader负责将相应的配置文件内容读取并映射到BeanDefinition，然后将映射完成的BeanDefinition注册到一个BeanDefinitionRegistry中，然后BeanDefinitionRegistry即完成Bean的注册和加载。大部分的工作，如括解析文件格式、装配BeanDefinition之类的工作，都是由BeanDefinitionReader的实现类来完成，BeanDefinitionRegistry只负责保管。</p><p>BeanDefinitionReader有3个实现类，一个抽象类AbstractBeanDefinitionReader，2个具体子类：PropertiesBeanDefinitionReader和XmlBeanDefinitionReader，说明Spring默认支持2种配置文件：xml和properties</p><p>因此，如果想要实现自定义配置文件的加载，可以通过继承AbstractBeanDefinitionReader来实现。</p><p>7、@Component和@Autowired注解的作用</p><p>@Component在类和接口上标注，开启自动扫包后，对应扫描路径下如果有该注解的类实例会注册到Spring容器中，通过Spring容器进行管理</p><p>自动扫包配置</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;cn.spring21.project.base.package&quot;</span>/&gt;</span> </span><br></pre></td></tr></table></figure><p>@Autowired是从Spring容器中获取依赖的对象实例并注入到注解标注的地方</p><p>8、xml配置文件有哪些关键的配置？</p><p>某个场景下如果要对大部分的<code>&lt;bean&gt;</code>进行设置某些行为的话，可以利用<code>&lt;beans&gt;</code>统一设置。</p><p>一些常用的属性<br>default-lazy-init<br>default-autowire<br>default-dependency-check<br>default-init-method<br>default-destroy-method</p><p>添加别名</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&quot;dataSourceForMasterDatabase&quot;</span> <span class="attr">alias</span>=<span class="string">&quot;masterDataSource&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure><p>在xml配置文件进行配置时，如果通过属性注入要求类提供setter方法，通过构造参数注入要求类提供对应参数列表的构造方法</p><p>了解如何注入复杂类型的对象，如集合、空元素null、内部bean</p><p>depends-on显示指定bean之间的依赖关系，可以通过逗号分隔指定多个依赖的bean</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;classAInstance&quot;</span> <span class="attr">class</span>=<span class="string">&quot;...ClassA&quot;</span> <span class="attr">depends-on</span>=<span class="string">&quot;configSetup,configSetup2,...&quot;</span>/&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;configSetup&quot;</span> <span class="attr">class</span>=<span class="string">&quot;SystemConfigurationSetup&quot;</span>/&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;configSetup2&quot;</span> <span class="attr">class</span>=<span class="string">&quot;SystemConfigurationSetup2&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure><p>9、Spring提供了哪些自动绑定方式？<br>5种：no(默认), byName, byType, constructor, autodetect</p><p>手动指定的绑定关系，会覆盖自动绑定的关系，一般来说会使用手动绑定，明确依赖关系，便于管理，避免一些不可预知的行为发生。比如，使用byName可能会导致同名的bean定义被替换，造成问题。</p><p>10、lazy-init属性了解<br>默认会进行初始化，除非设置了<code>lazy-init=&quot;true&quot;</code>。假如一个对象A依赖了延迟初始化的bean对象B，那么A实例化时会先实例化对象B，表现为lazy-init属性设置失效。</p><p>11、如果父类和子类都要放到bean容器进行管理，需要如何配置呢？</p><p>子类会继承父类的非私有属性，假如父类和子类的属性指向同一个对象，可以使用parent属性简化配置，当然建议是在代码属性上加上@Autowired注解，或者在xml中引用同一个bean对象即可。</p><h1 id="Bean的生命周期-1"><a href="#Bean的生命周期-1" class="headerlink" title="Bean的生命周期"></a>Bean的生命周期</h1><p>1.bean的scope</p><p>标记为singleton的bean是由容器来保证这种类型的bean在同一个容器中只存在一个共享实例；<br>而Singleton模式则是保证在同一个Classloader中只存在一个这种类型的实例</p><p>2、自定义scope的步骤</p><ul><li>实现Scope接口，参考org.springframework.context.support.SimpleThreadScope实现</li><li>Spring容器（例如ApplicationContext）中注册<ul><li>直接编码：<code>beanFactory.registerScope(&quot;thread&quot;,threadScope);</code></li><li>xml配置：</li></ul></li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.beans.factory.config.CustomScopeConfigurer&quot;</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;scopes&quot;</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">map</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">&quot;thread&quot;</span> <span class="attr">value</span>=<span class="string">&quot;com.foo.ThreadScope&quot;</span>/&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">map</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span> </span><br></pre></td></tr></table></figure><p>3、工厂bean类FactoryBean的作用是什么？使用方法？</p><p>Java强调面向接口编程，依赖的属性通常为接口，但类实例化时通常会选择具体的接口实现，FactoryBean就是将声明依赖接口的对象与接口实现类关联起来的一种方式。</p><p>FactoryBean这里有一个知识点，用到了工厂方法模式。</p><p>工厂方法模式：<br>定义一个用于创建对象的接口，让子类决定实例化哪一个类，使一个类的实例化延迟到其子类。或者更加本质的概括说：延迟到子类来选择实现</p><p>4、Spring容器有哪些地方使用了FactoryBean？</p><ul><li>JndiObjectFactoryBean</li><li>LocalSessionFactoryBean </li><li>SqlMapClientFactoryBean </li><li>ProxyFactoryBean </li><li>TransactionProxyFactoryBean </li></ul><p>4、依赖注入DI与控制反转IoC是同一个意思吗？区别是什么？</p><p>两者是对同一件事情的不同描述<br>依赖注入：应用程序依赖于容器并注入它所需要的资源<br>控制反转：由容器反向地向应用程序注入其所需要的外部资源</p><p>5、类B是类A的属性成员，假如类B定义为prototype，如果要确保每次实例化A时获取一个新的实例化对象B，需要通过lookup-method标签指定获取依赖对象B的方式，Spring会通过Cglib动态生成一个子类并覆写方法getNewsBean，把新生成的子类对象注入到对象A的newsBean属性中。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;newsBean&quot;</span> <span class="attr">class</span>=<span class="string">&quot;..domain.FXNewsBean&quot;</span> <span class="attr">scope</span>=<span class="string">&quot;prototype&quot;</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;mockPersister&quot;</span> <span class="attr">class</span>=<span class="string">&quot;..impl.MockNewsPersister&quot;</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">lookup-method</span> <span class="attr">name</span>=<span class="string">&quot;getNewsBean&quot;</span> <span class="attr">bean</span>=<span class="string">&quot;newsBean&quot;</span>/&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure><p>BeanFactoryAware接口：<br>容器会自己本身注入到BeanFactoryAware接口的子类中，通过BeanFactoryAware接口方法setBeanFactory实现，可以定义一个BeanFactory beanFactory属性，通过覆写setBeanFactory方法设置到beanFactory属性中，后续再次获取scope为prototype的对象时，则每次都通过beanFactory.getBean(“newsBean”)来获取。这种方式与上面的效果一样。</p><p>ObjectFactoryCreatingFactoryBean是一个FactoryBean实现类，它的父类还实现了BeanFactoryAware接口，但是通常认为直接操作BeanFactory可能会导致一些安全问题。ObjectFactoryCreatingFactoryBean会返回一个ObjectFactory实例，用于与Spring容器进行交互，隔离了客户端对BeanFactory的直接引用。</p><p>与方法注入只是通过相应方法为主体对象注入依赖对象不同，方法替换更多体现在方法的实现层<br>面上，它可以灵活替换或者说以新的方法实现覆盖掉原来某个方法的实现逻辑</p><p>方法替换MethodReplacer</p><p>ObjectFactoryCreatingFactoryBean源代码示例：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span>&gt;</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment">&lt;!-- Prototype bean since we have state --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;myService&quot;</span> <span class="attr">class</span>=<span class="string">&quot;a.b.c.MyService&quot;</span> <span class="attr">scope</span>=<span class="string">&quot;prototype&quot;</span>/&gt;</span></span><br><span class="line"> </span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;myServiceFactory&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">class</span>=<span class="string">&quot;org.springframework.beans.factory.config.ObjectFactoryCreatingFactoryBean&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;targetBeanName&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">idref</span> <span class="attr">local</span>=<span class="string">&quot;myService&quot;</span>/&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"> </span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;clientBean&quot;</span> <span class="attr">class</span>=<span class="string">&quot;a.b.c.MyClientBean&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;myServiceFactory&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;myServiceFactory&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"> </span><br><span class="line"> <span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyClientBean</span> &#123;</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">private</span> ObjectFactory&lt;MyService&gt; myServiceFactory;</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setMyServiceFactory</span><span class="params">(ObjectFactory&lt;MyService&gt; myServiceFactory)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.myServiceFactory = myServiceFactory;</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">someBusinessMethod</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// get a &#x27;fresh&#x27;, brand new MyService instance</span></span><br><span class="line">    <span class="type">MyService</span> <span class="variable">service</span> <span class="operator">=</span> <span class="built_in">this</span>.myServiceFactory.getObject();</span><br><span class="line">    <span class="comment">// use the service object to effect the business logic...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>6、BeanFactoryPostProcessor容器扩展机制，可以实现什么功能？</p><p>本身就有很多实现</p><p>BeanFactoryPostProcessor一些常见的实现：</p><p>PropertyPlaceholderConfigurer<br>（1）PropertyPlaceholderConfigurer允许我们在xml配置文件中使用&gt;${jdbc.url}之类的占位符，加载配置文件的方式对其进行填充，因此可以将这些配置信息单独配置到一个个的properties，不需要全部写到xml中。直接改properties的KV结构要比改xml配置文件更不如容易出错。<br>（2）PropertyPlaceholderConfigurer不单可以从properties文件中加载配置项，也可以从Java的System类中的Properties加载配置项，默认是先从properties文件中查找，再从System的Properties中查找。</p><p>PropertyOverrideConfigurer<br>（1）对任何的bean定义进行更改，指定一些properties配置文件，里面的kv可以替换掉其他地方的键值对定义，还可以修改bean定义。比如使用<code>beanName.propertyName=value</code>来修改。<br>（2）配置多个PropertyOverrideConfigurer时，以最后一个为准。</p><p>PropertyPlaceholderConfigurer和PropertyOverrideConfigurer都继承自PropertyResourceConfigurer，里面有一个protected类型的方法convertPropertyValue，子类可以覆盖这个方法对相应的配置项进行转换，比如有些敏感配置项是通过密文存储，加载的时候需要先解密在覆盖到bean定义中。</p><p>CustomEditorConfigurer<br>对对BeanDefinition没有做任何变动，只是将后期会用到的信息注册到容器。</p><p>PropertyEditor<br>xml文件中配置的都是String类型的字符串，解析bean定义时需要转换为实际的类型，比如</p><ul><li>StringArrayPropertyEditor：将逗号分隔的字符串转换为String[]格式</li><li>ClassEditor：根据String类型的class名称，直接将其转换成相应的Class对象，相当于Class.forName(String)完成的功效</li><li>FileEditor等等</li></ul><p>PropertyEditor也可以自定义，可以通过实现PropertyEditor接口，也可以继承PropertyEditorSupport，如果仅仅涉及格式转换，可以重写setAsText()和getAsText()方法</p><p>7、bean的实例化过程？或者说bean的生命周期<br>第一次调用beanFactory.getBean会进行bean的实例化，第二次调用会直接返回容器缓存的对象实例（prototype类型的bean除外）</p><p>实例化的过程如下：</p><ul><li>实例化bean对象</li><li>设置对象属性</li><li>检查Aware相关接口并设置相关依赖</li><li>BeanPostProcessor前置处理postProcessBeforeInitialization</li><li>检查是否是InitializingBean的实现，决定是否调用afterPropertiesSet方法</li><li>如果配置有init-method方法，则调用</li><li>BeanPostProcessor后置处理postProcessAfterInitialization</li><li>注册必要的Destruction相关回调接口</li><li><strong>使用中</strong></li><li>如果实现了DisposableBean接口，则调用destroy方法</li><li>如果配置有destroy-method方法，则调用</li></ul><p>可以AbstractAutowireCapableBeanFactory的createBean()方法查看完整实现</p><p>8、容器内部可以通过哪些方式来实例化bean？</p><p>策略模式来决定采用何种方式初始化bean实例，可以通过反射或者Cglib动态字节码的方式初始化bean或者动态生成其子类。<br>InstantiationStrategy定义是实例化策略的抽象接口，直接子类SimpleInstantiationStrategy实现了简单的对象实例化功能，可以通过反射来实例化对象实例。<br>CglibSubclassingInstantiationStrategy继承了SimpleInstantiationStrategy，除了能够通过反射实例化对象，也可以通过Cglib动态字节码技术生成某个类的子类，满足方法注入所需对象的实例化需求。<br>默认情况下，Spring容器内部采用的是CglibSubclassingInstantiationStrategy</p><p>策略模式：<br>AbstractAutowireCapableBeanFactory相当于context，持有InstantiationStrategy，而上面两种策略可以根据需要进行选择，默认选用CglibSubclassingInstantiationStrategy</p><p>BeanWrapper定义继承了org.springframework.beans.PropertyAccessor接口，可以以统一的<br>方式对对象属性进行访问</p><p>9、Spring容器的Aware接口</p><p>BeanFactory容器的Aware接口</p><ul><li>BeanNameAware：将改对象实例的bean定义对应的beanName设置到当前对象实例</li><li>BeanClassLoaderAware：将对应加载当前bean的ClassLoader注入到当前对象。默认会使用ClassUtils类的ClassLoader</li><li>：将BeanFactory容器自身注入到当前对象实例，当前对象实例就持有了BeanFactBeanFactoryAwareory容器的引用</li></ul><p>ApplicationContext容器的Aware接口</p><ul><li>ResourceLoaderAware：ApplicationContext实现了ResourceLoaderAware接口，会将当前的ApplicationContext容器注入到当前对象实例，与BeanFactoryAware类似</li><li>ApplicationEventPublisherAware：将当前的ApplicationContext容器注入到当前对象实例，还具有发布器的作用</li><li>MessageSourceAware：将当前的ApplicationContext容器注入到当前对象实例，并提供国际化的信息支持</li></ul><p>10、BeanFactoryPostProcessor和BeanPostProcessor区别<br>（1）前者是容器启动阶段，后者是对象实例化阶段。<br>（2）BeanFactoryPostProcessor会处理容器内所有符合条件的BeanDefinition，BeanPostProcessor会处理所有符合条件的实例化后的对象实例</p><h1 id="ApplicationContext容器"><a href="#ApplicationContext容器" class="headerlink" title="ApplicationContext容器"></a>ApplicationContext容器</h1><p>1、讲讲ApplicationContext如何实现统一资源加载？</p><p>Spring中通过Resource定义了资源的抽象接口，ResourceLoader定义资源的加载，两者结合完成统一资源加载。ApplicationContext继承了ResourcePatternResolver，间接实现了ResourceLoader接口，因此这就是ApplicationContext支持Spring内统一资源加载原因。</p><p>涉及的几个Aware接口：</p><ul><li>ResourceLoaderAware</li><li>ApplicationContextAware</li></ul><p>2、Java和Spring分别使用什么方式进行国际化信息的处理？</p><p>（1）Java主要涉及2个类；java.util包里的Locale和ResourceBundle，ResourceBundle用来保存特定某个Locale的信息，ResourceBundle管理一组信息序列，命名格式为：{basename}<em>{language}</em>{COUNTRY}.properties，例如messages_zh_CN.properties，每个文件涉及的key相同，value与国家语言有关。</p><p>（2）Spring通过MessageSource接口，传入相应的Locale、资源的key以及相应参数就可以获取相应的信息，不用先根据Locale取得ResourceBundle</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MessageSource</span> &#123; </span><br><span class="line">String <span class="title function_">getMessage</span><span class="params">(String code, Object[] args, String defaultMessage, Locale locale)</span>; </span><br><span class="line"></span><br><span class="line">String <span class="title function_">getMessage</span><span class="params">(String code, Object[] args, Locale locale)</span> <span class="keyword">throws</span> NoSuchMessageException; </span><br><span class="line"></span><br><span class="line">String <span class="title function_">getMessage</span><span class="params">(MessageSourceResolvable resolvable, Locale locale)</span> <span class="keyword">throws</span> NoSuchMessage zException; </span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure><p>ApplicationContext使用messageSourcec示例</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;messageSource&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.context.support.ResourceBundleMessageSource&quot;</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;basenames&quot;</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">list</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">value</span>&gt;</span>messages<span class="tag">&lt;/<span class="name">value</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">value</span>&gt;</span>errorcodes<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">list</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span> </span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ApplicationContext</span> <span class="variable">ctx</span> <span class="operator">=</span> ...; </span><br><span class="line"><span class="type">String</span> <span class="variable">fileMenuName</span> <span class="operator">=</span> ctx.getMessage(<span class="string">&quot;menu.file&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;F&quot;</span>&#125;, Locale.US); </span><br><span class="line"><span class="type">String</span> <span class="variable">editMenuName</span> <span class="operator">=</span> ctx.getMessage(<span class="string">&quot;menu.file&quot;</span>, <span class="literal">null</span>, Locale.US); </span><br><span class="line">assertEquals(<span class="string">&quot;File(F)&quot;</span>, fileMenuName); </span><br><span class="line">assertEquals(<span class="string">&quot;Edit&quot;</span>, editMenuName); </span><br></pre></td></tr></table></figure><p>MessageSource的三种实现：</p><ul><li>StaticMessageSource：一般只用于测试</li><li>ResourceBundleMessageSource：提供了对多个ResourceBundle的缓存以提高查询速度，常用。</li><li>ReloadableResourceBundleMessageSource：通过其cacheSeconds属性可以指定时间段，以定期刷新并检查底层的properties资源文件是否有变更。</li></ul><p>上面三种MessageResource可以独立于容器在程序中使用。</p><p>MessageSourceAware类</p><p>3、容器内事件发布机制</p><p>（1）<br>与观察者模式有些相似，Listener相当于Observer，事件发布器Publisher+ApplicationEvent相当于主题Subject，持有Listner集合并维护集合，当主题状态发生变化时，通知所有Listener<br>注意：Spring的ApplicationContext容器内的事件发布机制，主要用于单一容器内的简单消息通知和处<br>理，并不适合分布式、多进程、多容器之间的事件通知。</p><p>（2）一旦容器内发布ApplicationEvent及其子类的事件，注册到容器的ApplicationListener就会对事件进行处理。</p><p>一些ApplicationEvent的子类：</p><ul><li>ContextClosedEvent：ApplicationContext容器在即将关闭时发布的事件类型</li><li>ContextRefreshedEvent：ApplicationContext容器在初始化或者刷新时发布的事件类型</li><li>RequestHandledEvent：Web请求处理后发布的事件类型，其中一个子类ServletRequestHandled用于Java EE的Servlet事件。</li></ul><p>ApplicationListener<br>ApplicationContext容器内使用的自定义事件监听器接口定义，继承自java.util.EventListener，ApplicationContext容器启动时，会自动识别并加载EventListener类型的bean定义，一旦容器内有事件发布，会将通知这些注册到容器的EventListener</p><p>ApplicationContext<br>继承了ApplicationEventPublisher接口，担当了事件发布者的角色，通过类层次结构可以看出来，它将对应的活委托给了ApplicationEventMulticaster接口来实现，而ApplicationEventMulticaster接口有一个抽象子类AbstractApplicationEventMulticaster，这个抽象子类实现了监听器的管理，将事件发布委托给了它的子类SimpleApplicationEventMulticaster。这个SimpleApplicationEventMulticaster事件发布交给Executor类型去执行，是否同步异步可以自定义。</p><p>（3）一些Aware类<br>ApplicationEventPublisherAware</p><p>4、Spring中的Aware接口使用场景有哪些？<br>Aware接口是Spring框架中提供的一组标记接口，用于在Bean装配的过程中获取Spring容器中提供的一些核心组件或运行时上下文等信息。通过使用Aware接口，我们可以在Bean实例化和初始化过程中获取到Spring容器中其他组件，方便Bean类实现更复杂的业务逻辑。</p><p>通俗的说，只要实现了Aware子接口的Bean都能获取到一个Spring底层组件。实现XXXAware接口的bean：通过实现的setXXX方法就可以获取到XXX组件对象，在Aware的实现类就可以对组件进行操作了。具体可以查看源码org.springframework.context.support.ApplicationContextAwareProcessor#invokeAwareInterfaces，本质是通过BeanPostProcessor的子类ApplicationContextAwareProcessor调用postProcessBeforeInitialization方法完成一些操作。</p><p>常见的是实现ApplicationContextAware获取ApplicationContext，做成一个工具类AppplicationUtil，提供应用去获取bean。</p><p>常见的Aware实现：</p><ul><li>ApplicationContextAware：web项目中可以获取ServletContext，获取国际化信息、Scheduler等定时任务</li><li>BeanFactoryAware：获取Spring容器中的Bean实例、手动注册BeanDefinition</li><li>MessageSourceAware：获取国际化信息</li><li>ResourceLoaderAware：进行资源加载操作</li><li>ServletContextAware：让Bean获取到ServletContext对象</li><li>EnvironmentAware：获取当前的环境配置，获取配置文件中的属性值</li><li>ServletConfigAware：让Bean获取到ServletConfig对象，可以获取Servlet相关参数</li><li>ApplicationContextInitializer：在Spring容器初始化之前做一些必要的操作</li><li>EmbeddedValueResolverAware：替换配置文件中的占位符，与@Value功能类似</li><li>LoadTimeWeaverAware：让Bean获取到LoadTimeWeaver对象，实现类的动态加载</li><li>ApplicationEventPublisherAware：让Bean获取到ApplicationEventPublisher对象，发布和监听事件</li><li>ConversionServiceAware：类型转换，数据校验</li></ul><h1 id="Spring注解"><a href="#Spring注解" class="headerlink" title="Spring注解"></a>Spring注解</h1><p>1、系统有哪些BeanPostProcessor？功能主要是做什么？</p><p>AutowiredAnnotationBeanPostProcessor：往@Autowired标注的对象注入</p><p>2、JSR250标准下的注解有哪些？</p><p>使用JSR250注解需要在xml配置文件往Spring容器中注入下面的对象</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.context.annotation.CommonAnnotationBeanPostProcessor&quot;</span>/&gt;</span> </span><br></pre></td></tr></table></figure><p>@Resource：byName的方式注入<br>@PostConstruct和@PreDestroy：用于标注对象生命周期管理相关方法</p><p>同理，使用Spring的注解@Autowired，也需要在xml配置进行配置</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.beans.factory.annotation.AutowiredAnnotationBeanPostProcessor&quot;</span>/&gt;</span> </span><br></pre></td></tr></table></figure><p>当然，有一种更简便的方法，在xml配置文件中使用下面配置搞定以上所有的BeanPostProcessor配置，作用是把AutowiredAnnotationBeanPostProcessor、CommonAnnotationBeanPostProcessor、PersistenceAnnotationBeanPostProcessor、RequiredAnnotationBeanPostProcessor四个BeanPostProcessor注册到容器。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">context:annotation-config</span>/&gt;</span> </span><br></pre></td></tr></table></figure><p>classpath-scanning功能可以从某一顶层包（base package）开始扫描。当扫描到某个类标注了相应的注解之后，就会提取该类的相关信息，构<br>建对应的BeanDefinition，然后把构建完的BeanDefinition注册到容器。注意，下面配置还将AutowiredAnnotationBeanPostProcessor和<br>CommonAnnotationBeanPostProcessor一并注册到了容器中，因此上面的<code>&lt;context:annotation-config/&gt;</code>也可以不要。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;org.spring21&quot;</span>/&gt;</span> </span><br></pre></td></tr></table></figure><h1 id="Spring-AOP切面"><a href="#Spring-AOP切面" class="headerlink" title="Spring AOP切面"></a>Spring AOP切面</h1><p>涉及到的设计模式：代理模式</p><p>1、什么是Spring AOP？有哪些关键概念？</p><p>Joinpoint：需要织入代码的地方，比如方法调用，字段设置、异常处理等</p><p>Pointcut：Joinpoint表达式定义<br>常见的Pointcut</p><ul><li><p>Advice：横切逻辑，有5种</p></li><li>BeforeAdvice：通常不会中断程序执行流程，除非有必要可以通过抛异常方式中断当前流。实现MethodBeforeAdvice即可</li><li>AfterAdvice：<ul><li>After returning Advice：当前Joinpoint处执行流程正常完成之后。对应接口AfterReturningAdvice</li><li>After throwing Advice：抛异常的情况下会执行。对应接口ThrowsAdvice，覆写三个方法，可以对运行时异常、普通异常、应用异常分别处理，可以发送邮件给对应人员。</li><li>After finally Advice：无论正常终了还是抛出异常都会执行，类似finally块，使用MethodInterceptor接口实现</li></ul></li><li>Around Advice：可以在Joinpoint之前和之后指定相应逻辑，甚至于中断或忽略Joinpoint原来程序流程的执行。Spring AOP没有直接定义Around Advice，使用MethodInterceptor接口实现</li></ul><p>MethodInterceptor可以干些什么？<br>什么都能干，应用场景很多，系统安全验证检查、权限控制、性能检测、限流、日志记录等等</p><p>Aspect：对系统中横切点逻辑进行模块化封装的AOP实体。</p><p>2、什么是动态代理机制？<br>Java中的动态代理由Proxy和InvocationHandler两个类实现，</p><p>3、Cglib动态字节码技术？<br>借助Cglib动态字节码技术，在系统运行期间，为目标对象生成相应的扩展子类。</p><p>4、Spring MVC的拦截器Interceptor如何实现？</p><p>实现 org.springframework.web.servlet.HandlerInterceptor接口或继承 org.springframework.web.servlet.handler.HandlerInterceptorAdapter类，重写下面方法进行拦截处理。</p><p>一些拦截器的细节：</p><ul><li>拦截链条中，假如有A、B、C三个拦截器，假如各个拦截器的preHandle和postHandle方法都返回true，那么afterCompletion方法执行顺序是：C-&gt;B-&gt;A，并且都在postHandle执行完成后执行</li><li>假如preHandle方法返回true，但是controller的方法中抛出异常，那么当前Interceptor的afterCompletion方法也会执行，postHandle方法不执行</li><li>假如preHandle方法返回false，那么后续的controller方法和拦截器及其方法都不会执行</li><li>拦截链条中，假如当前拦截器的preHandle返回false，当前拦截器的拦截方法不会执行，但是前面拦截器的afterCompletion方法还会执行</li></ul><p><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202309031600647.png" alt=""></p><p>使用步骤：</p><ul><li>实现HandlerInterceptor接口或者继承HandlerInterceptorAdapter，重写对应拦截方法</li><li>配置拦截器，可以用@Configuration注解或者xml配置文件进行配置，主要包括拦截请求类型、拦截的Interceptor信息，注意添加拦截器是有顺序关系的。</li></ul><p>xml配置方式</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mvc:interceptors</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--第一种方式配置某个拦截器，默认是拦截所有请求的--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;com.citi.interceptor.ZuluInterceptor&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mvc:interceptors</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 返回false，后续的Interceptor不会继续执行，为true时会继续调用后续Interceptor的preHandle方法</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span></span><br><span class="line"><span class="keyword">throws</span> Exception &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">*  Controller方法调用之后执行，通常用于设置一些通用的响应信息，如响应字段等，可以对Controller 处理之后的 ModelAndView 对象进行操作</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postHandle</span><span class="params">(</span></span><br><span class="line"><span class="params">HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView)</span></span><br><span class="line"><span class="keyword">throws</span> Exception &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 在ModelAndView对象完成渲染之后且在响应返回之前会执行该方法对结果进行后置处理。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterCompletion</span><span class="params">(</span></span><br><span class="line"><span class="params">HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span></span><br><span class="line"><span class="keyword">throws</span> Exception &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>应用场景：<br>（1）性能监控，监控请求处理的时长<br>通常来说controller请求处理前和后分别记录时间，两者时间差就是整个请求处理所耗费的时间，对于一些时间延迟比较大的，我们可以进行分析和优化。实现步骤如下：<br>利用ThreadLocal线程私有相关的变量，在实现的Interceptor中持有该变量，preHandle方法记录请求到达时间，在postHandle请求中记录请求处理完成后的时间，然后两个时间的差值就是所耗费的时间。</p><p>（2）拦截器通过判断 cookie/session 中是否有该标识，来决定继续流程还是重定向到登录页面<br><code>request.setAttribute(&quot;requestStartTime&quot;, startTime);</code>同样可以实现请求耗时的计算。</p><p>5、过滤器Filter与拦截器Interceptor有什么区别？分别在什么场景使用？<br>Filter和Interceptor都可以用来实现权限校验、日志处理、数据解压/压缩处理、加密/解密处理等问题，但是Filter是Servlet规范，主要在Tomcat等Web容器下使用，Interceptor是Spring MVC规范，主要由Spring容器进行管理。</p><p>（1）Filter主要用责任链模式进行设计，在Tomcat中使用org.apache.catalina.core.ApplicationFilterChain来实现上面提到的责任链模式</p><p>通常在web.xml配置文件中配置：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>MDCInsertingServletFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span></span><br><span class="line">        ch.qos.logback.classic.helpers.MDCInsertingServletFilter</span><br><span class="line">    <span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>MDCInsertingServletFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure><p>如果是在Spring中使用Filter，还可以通过注解的方式<br>在自定义过滤器上使用@WebFilter注解，并在启动类上使用@ServletComponentScan注解；结合@WebFilter注解中的urlPattern字段，Spring能够将过滤器的处理粒度进一步细化，还可以通过@Order来定义过滤器的顺序</p><p>（2）Interceptor是Spring原创的，interceptor的执行时机是要晚于filter的前置处理并且早于filter的后置处理的，同样也是采用责任链的设计模式。</p><p>详细可以查看org.springframework.web.servlet.DispatcherServlet#doDispatch源码，</p><p>Spring中的配置方式</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebConfig</span> <span class="keyword">implements</span> <span class="title class_">WebMvcConfigurer</span> &#123;</span><br><span class="line">​</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> &#123;</span><br><span class="line">        registry.addInterceptor(<span class="keyword">new</span> <span class="title class_">DemoInterceptor</span>()).addPathPatterns(<span class="string">&quot;/api/*&quot;</span>).excludePathPatterns(<span class="string">&quot;/api/ok&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202309031642303.png" alt=""></p><p>6、Spring有几种拦截器<br>Filter过滤器-&gt;Interceptor拦截器-&gt;@ControllerAdvice-&gt;AOP</p><p>使用<br>Filter：通常同时实现Filter, Ordered接口并重写，可以自定义顺序</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">结果：</span><br><span class="line">Filter 进入</span><br><span class="line">Interceptor preHandle 进入</span><br><span class="line">ControllerAdvice init 进入</span><br><span class="line">Aop 进入</span><br><span class="line">业务：user.name: 宫三公子</span><br><span class="line">ControllerAdvice handleException 进入</span><br><span class="line">Interceptor afterCompletion 进入</span><br><span class="line">Filter 退出</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202309031658844.png" alt=""></p><p><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202309031701159.png" alt=""></p><p>9、Spring的循环依赖如何解决？如何避免循环依赖？</p><blockquote><p>声明：本站所有文章均为原创或翻译，遵循<a href="https://creativecommons.org/licenses/by-nc-nd/4.0/deed.en">署名 - 非商业性使用 - 禁止演绎 4.0 国际许可协议</a>，如需转载请确保您对该协议有足够了解，并附上作者名 (Tsukasa) 及原文地址</p></blockquote>]]></content>
    
    
    <summary type="html">&lt;script src=&quot;&#92;assets&#92;js&#92;APlayer.min.js&quot;&gt; &lt;/script&gt;&lt;p&gt;未完成&lt;/p&gt;</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>K8s 集群搭建系列（四）：集成Kubernetes Dashboard</title>
    <link href="http://blog.tsukasa.moe/2023/08/03/K8s-cluster-series-Kubernetes-dashboard-integration/"/>
    <id>http://blog.tsukasa.moe/2023/08/03/K8s-cluster-series-Kubernetes-dashboard-integration/</id>
    <published>2023-08-02T19:09:38.000Z</published>
    <updated>2023-08-05T07:42:22.675Z</updated>
    
    <content type="html"><![CDATA[<!-- excerpt --><!-- toc --><p>在k8s集群的master节点部署Kubernetes dashboard，便于管理集群、扩容。</p><h1 id="生成dashboard自签名证书"><a href="#生成dashboard自签名证书" class="headerlink" title="生成dashboard自签名证书"></a>生成dashboard自签名证书</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p /export/servers/kubernetes/certs &amp;&amp; <span class="built_in">cd</span> /export/servers/kubernetes/certs/</span><br><span class="line"><span class="comment"># 生成私钥</span></span><br><span class="line">openssl genrsa -out dashboard.key 2048</span><br><span class="line"><span class="comment"># 生成自签证书，CN=&lt;Master ip或者域名&gt;</span></span><br><span class="line">openssl req -days 3650 -new -key dashboard.key -out dashboard.csr -subj /C=CN/ST=BEIJING/L=BEIJING/O=JD/OU=JD/CN=192.168.2.100</span><br><span class="line"><span class="comment"># </span></span><br><span class="line">openssl x509 -req -days 3650 -<span class="keyword">in</span> dashboard.csr -signkey dashboard.key -out dashboard.crt</span><br><span class="line"></span><br></pre></td></tr></table></figure><h1 id="创建Secret"><a href="#创建Secret" class="headerlink" title="创建Secret"></a>创建Secret</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create secret tls kubernetes-dashboard-certs -n kubernetes-dashboard --key dashboard.key --cert dashboard.crt</span><br></pre></td></tr></table></figure><p>如果发现Secret有问题，可以通过下面命令删除：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete secret kubernetes-dashboard-certs -n kube-system</span><br></pre></td></tr></table></figure><h1 id="配置dashboard-yaml文件"><a href="#配置dashboard-yaml文件" class="headerlink" title="配置dashboard.yaml文件"></a>配置dashboard.yaml文件</h1><p><code>/export/servers/k8s_dashboard/kubernetes-dashboard.yml</code>配置文件可以直接从网上获取，也可以参考附录生成，应用配置文件</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f /export/servers/k8s_dashboard/kubernetes-dashboard.yml</span><br><span class="line"><span class="comment"># 撤销应用配置文件：kubectl delete -f /export/servers/k8s_dashboard/kubernetes-dashboard.yml</span></span><br></pre></td></tr></table></figure><p>查看kubernetes-dashboard是否正常</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods -A | grep kubernetes-dashboard</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202308031620009.png" alt=""></p><p>此时已经可以访问dashboard页面，但是我们需要创建一个有管理权限的admin用户进行登陆。</p><p>web浏览器访问地址：<a href="https://192.168.2.100:31001/#/login">https://192.168.2.100:31001/#/login</a></p><p><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202308031622927.png" alt=""></p><h1 id="制作访问token"><a href="#制作访问token" class="headerlink" title="制作访问token"></a>制作访问token</h1><p>创建Dashboard管理用户的配置文件。</p><p><code>/export/servers/k8s_dashboard/dashboard-adminuser.yaml</code></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">admin-user</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">admin-user</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cluster-admin</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">admin-user</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>执行<code>dashboard-adminuser.yaml</code>配置文件</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下面的命令是创建一个叫admin-user的服务账号，放在kubernetes-dashboard命名空间下，并将cluster-admin角色绑定到admin-user账户，这样admin-user账户就有了管理员的权限。</span></span><br><span class="line">kubectl create -f /export/servers/kubernetes/dashboard-adminuser.yaml</span><br><span class="line"><span class="comment"># 查看admin-user的token，复制可用于Dashboard UI登陆</span></span><br><span class="line">kubectl -n kubernetes-dashboard describe secret $(kubectl -n kubernetes-dashboard get secret | grep admin-user | awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>如果想要删除帐号，可以执行下面的命令：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kubernetes-dashboard delete serviceaccount admin-user</span><br></pre></td></tr></table></figure><h1 id="登陆Dashboard"><a href="#登陆Dashboard" class="headerlink" title="登陆Dashboard"></a>登陆Dashboard</h1><p>复制上一步的Token返回Dashboard页面进行登陆，选择全部命名空间可以查看所有的负载：</p><p><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202308031635854.png" alt=""></p><h1 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h1><h2 id="Kubernetes-dashboard的配置文件"><a href="#Kubernetes-dashboard的配置文件" class="headerlink" title="Kubernetes dashboard的配置文件"></a>Kubernetes dashboard的配置文件</h2><p>官方推荐配置文件，注意需要修改<br><a href="https://raw.githubusercontent.com/kubernetes/dashboard/v2.7.0/aio/deploy/recommended.yaml">https://raw.githubusercontent.com/kubernetes/dashboard/v2.7.0/aio/deploy/recommended.yaml</a></p><p><code>/export/servers/k8s_dashboard/kubernetes-dashboard.yml</code></p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Copyright 2017 The Kubernetes Authors.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span></span><br><span class="line"><span class="comment"># you may not use this file except in compliance with the License.</span></span><br><span class="line"><span class="comment"># You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#     http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span></span><br><span class="line"><span class="comment"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="comment"># See the License for the specific language governing permissions and</span></span><br><span class="line"><span class="comment"># limitations under the License.</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Namespace</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">443</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8443</span></span><br><span class="line">      <span class="attr">nodePort:</span> <span class="number">31001</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard-certs</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">Opaque</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard-csrf</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">Opaque</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">csrf:</span> <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard-key-holder</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">Opaque</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard-settings</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="comment"># Allow Dashboard to get, update and delete Dashboard exclusive secrets.</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;secrets&quot;</span>]</span><br><span class="line">    <span class="attr">resourceNames:</span> [<span class="string">&quot;kubernetes-dashboard-key-holder&quot;</span>, <span class="string">&quot;kubernetes-dashboard-certs&quot;</span>, <span class="string">&quot;kubernetes-dashboard-csrf&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;update&quot;</span>, <span class="string">&quot;delete&quot;</span>]</span><br><span class="line">    <span class="comment"># Allow Dashboard to get and update &#x27;kubernetes-dashboard-settings&#x27; config map.</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;configmaps&quot;</span>]</span><br><span class="line">    <span class="attr">resourceNames:</span> [<span class="string">&quot;kubernetes-dashboard-settings&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;update&quot;</span>]</span><br><span class="line">    <span class="comment"># Allow Dashboard to get metrics.</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;services&quot;</span>]</span><br><span class="line">    <span class="attr">resourceNames:</span> [<span class="string">&quot;heapster&quot;</span>, <span class="string">&quot;dashboard-metrics-scraper&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;proxy&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;services/proxy&quot;</span>]</span><br><span class="line">    <span class="attr">resourceNames:</span> [<span class="string">&quot;heapster&quot;</span>, <span class="string">&quot;http:heapster:&quot;</span>, <span class="string">&quot;https:heapster:&quot;</span>, <span class="string">&quot;dashboard-metrics-scraper&quot;</span>, <span class="string">&quot;http:dashboard-metrics-scraper&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="comment"># Allow Metrics Scraper to get metrics from the Metrics server</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;metrics.k8s.io&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;pods&quot;</span>, <span class="string">&quot;nodes&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">revisionHistoryLimit:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">securityContext:</span></span><br><span class="line">        <span class="attr">seccompProfile:</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">RuntimeDefault</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">kubernetesui/dashboard:v2.7.0</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8443</span></span><br><span class="line">              <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">          <span class="attr">args:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--auto-generate-certificates</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--namespace=kubernetes-dashboard</span></span><br><span class="line">            <span class="comment"># Uncomment the following line to manually specify Kubernetes API server Host</span></span><br><span class="line">            <span class="comment"># If not specified, Dashboard will attempt to auto discover the API server and connect</span></span><br><span class="line">            <span class="comment"># to it. Uncomment only if the default does not work.</span></span><br><span class="line">            <span class="comment"># - --apiserver-host=http://my-address:port</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kubernetes-dashboard-certs</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/certs</span></span><br><span class="line">              <span class="comment"># Create on-disk volume to store exec logs</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/tmp</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">tmp-volume</span></span><br><span class="line">          <span class="attr">livenessProbe:</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">scheme:</span> <span class="string">HTTPS</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">              <span class="attr">port:</span> <span class="number">8443</span></span><br><span class="line">            <span class="attr">initialDelaySeconds:</span> <span class="number">30</span></span><br><span class="line">            <span class="attr">timeoutSeconds:</span> <span class="number">30</span></span><br><span class="line">          <span class="attr">securityContext:</span></span><br><span class="line">            <span class="attr">allowPrivilegeEscalation:</span> <span class="literal">false</span></span><br><span class="line">            <span class="attr">readOnlyRootFilesystem:</span> <span class="literal">true</span></span><br><span class="line">            <span class="attr">runAsUser:</span> <span class="number">1001</span></span><br><span class="line">            <span class="attr">runAsGroup:</span> <span class="number">2001</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kubernetes-dashboard-certs</span></span><br><span class="line">          <span class="attr">secret:</span></span><br><span class="line">            <span class="attr">secretName:</span> <span class="string">kubernetes-dashboard-certs</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">tmp-volume</span></span><br><span class="line">          <span class="attr">emptyDir:</span> &#123;&#125;</span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">      <span class="attr">nodeSelector:</span></span><br><span class="line">        <span class="attr">&quot;kubernetes.io/os&quot;:</span> <span class="string">linux</span></span><br><span class="line">      <span class="comment"># Comment the following tolerations if Dashboard must not be deployed on master</span></span><br><span class="line">      <span class="attr">tolerations:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">node-role.kubernetes.io/master</span></span><br><span class="line">          <span class="attr">effect:</span> <span class="string">NoSchedule</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">dashboard-metrics-scraper</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dashboard-metrics-scraper</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">8000</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8000</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">dashboard-metrics-scraper</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">dashboard-metrics-scraper</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dashboard-metrics-scraper</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">revisionHistoryLimit:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">k8s-app:</span> <span class="string">dashboard-metrics-scraper</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">k8s-app:</span> <span class="string">dashboard-metrics-scraper</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">securityContext:</span></span><br><span class="line">        <span class="attr">seccompProfile:</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">RuntimeDefault</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dashboard-metrics-scraper</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">kubernetesui/metrics-scraper:v1.0.8</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8000</span></span><br><span class="line">              <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">          <span class="attr">livenessProbe:</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">              <span class="attr">port:</span> <span class="number">8000</span></span><br><span class="line">            <span class="attr">initialDelaySeconds:</span> <span class="number">30</span></span><br><span class="line">            <span class="attr">timeoutSeconds:</span> <span class="number">30</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/tmp</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">tmp-volume</span></span><br><span class="line">          <span class="attr">securityContext:</span></span><br><span class="line">            <span class="attr">allowPrivilegeEscalation:</span> <span class="literal">false</span></span><br><span class="line">            <span class="attr">readOnlyRootFilesystem:</span> <span class="literal">true</span></span><br><span class="line">            <span class="attr">runAsUser:</span> <span class="number">1001</span></span><br><span class="line">            <span class="attr">runAsGroup:</span> <span class="number">2001</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">      <span class="attr">hostNetwork:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">nodeSelector:</span></span><br><span class="line">        <span class="attr">&quot;kubernetes.io/os&quot;:</span> <span class="string">linux</span></span><br><span class="line">      <span class="comment"># Comment the following tolerations if Dashboard must not be deployed on master</span></span><br><span class="line">      <span class="attr">tolerations:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">node-role.kubernetes.io/master</span></span><br><span class="line">          <span class="attr">effect:</span> <span class="string">NoSchedule</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">tmp-volume</span></span><br><span class="line">          <span class="attr">emptyDir:</span> &#123;&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://github.com/kubernetes/dashboard">Kubernetes Dashboard Github repo</a><br><a href="https://github.com/kubernetes/dashboard/tree/06e7fac1b78727e07c0dd7b693279d13b4914b48/aio/deploy">Kubernetes Dashboard的官方配置文件参考</a><br><a href="https://kubernetes.io/docs/tasks/access-application-cluster/web-ui-dashboard/">Kubernetes Dashboard官方指导</a></p><blockquote><p>声明：本站所有文章均为原创或翻译，遵循<a href="https://creativecommons.org/licenses/by-nc-nd/4.0/deed.en">署名 - 非商业性使用 - 禁止演绎 4.0 国际许可协议</a>，如需转载请确保您对该协议有足够了解，并附上作者名 (Tsukasa) 及原文地址</p></blockquote>]]></content>
    
    
    <summary type="html">&lt;script src=&quot;&#92;assets&#92;js&#92;APlayer.min.js&quot;&gt; &lt;/script&gt;&lt;p&gt;在k8s集群的master节点部署Kubernetes dashboard，便于管理集群、扩容。&lt;/p&gt;</summary>
    
    
    
    <category term="环境配置" scheme="http://blog.tsukasa.moe/categories/%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/"/>
    
    
    <category term="Kubernetes Dashboard" scheme="http://blog.tsukasa.moe/tags/Kubernetes-Dashboard/"/>
    
  </entry>
  
  <entry>
    <title>K8s 集群搭建系列（三）：Harbor + Docker搭建K8s集群</title>
    <link href="http://blog.tsukasa.moe/2023/08/02/Create-k8s-cluster-in-linux/"/>
    <id>http://blog.tsukasa.moe/2023/08/02/Create-k8s-cluster-in-linux/</id>
    <published>2023-08-02T14:57:10.000Z</published>
    <updated>2023-11-14T09:18:27.591Z</updated>
    
    <content type="html"><![CDATA[<!-- excerpt --><!-- toc --><p>Harbor + Docker搭建K8s集群</p><h1 id="系统资源"><a href="#系统资源" class="headerlink" title="系统资源"></a>系统资源</h1><table><thead><tr><th style="text-align:left">IP</th><th style="text-align:left">角色</th><th style="text-align:left">主机名</th><th style="text-align:left">组件</th><th style="text-align:left">配置</th></tr></thead><tbody><tr><td style="text-align:left">192.168.2.183</td><td style="text-align:left">Windows10，个人PC</td><td style="text-align:left">Tsukasa</td><td style="text-align:left">VMWare</td><td style="text-align:left">-</td></tr><tr><td style="text-align:left">192.168.2.100</td><td style="text-align:left">deploy</td><td style="text-align:left">tsukasa</td><td style="text-align:left">ansible, docker, harbor</td><td style="text-align:left">4Cx2Gx20G</td></tr><tr><td style="text-align:left">192.168.2.100</td><td style="text-align:left">kubernetes</td><td style="text-align:left">k8s-master</td><td style="text-align:left">kubectl, kubelet, kubeadm, flnanel</td><td style="text-align:left">2Cx2Gx20G</td></tr><tr><td style="text-align:left">192.168.2.101</td><td style="text-align:left">kubernetes</td><td style="text-align:left">k8s-worker01</td><td style="text-align:left">kubectl</td><td style="text-align:left">2Cx1Gx20G</td></tr><tr><td style="text-align:left">192.168.2.102</td><td style="text-align:left">kubernetes</td><td style="text-align:left">k8s-worker02</td><td style="text-align:left">kubectl</td><td style="text-align:left">2Cx1Gx20G</td></tr><tr><td style="text-align:left">192.168.2.103</td><td style="text-align:left">etcd</td><td style="text-align:left">etcd01</td><td style="text-align:left">etcd</td><td style="text-align:left">2Cx1Gx20G</td></tr><tr><td style="text-align:left">192.168.2.104</td><td style="text-align:left">etcd</td><td style="text-align:left">etcd02</td><td style="text-align:left">etcd</td><td style="text-align:left">1Cx1Gx10G</td></tr><tr><td style="text-align:left">192.168.2.105</td><td style="text-align:left">etcd</td><td style="text-align:left">etcd03(leader)</td><td style="text-align:left">etcd</td><td style="text-align:left">1Cx1Gx10G</td></tr><tr><td style="text-align:left">192.168.2.106</td><td style="text-align:left">mysql</td><td style="text-align:left">mysql01</td><td style="text-align:left">mysql</td><td style="text-align:left">2Cx1Gx15G</td></tr><tr><td style="text-align:left">192.168.2.107</td><td style="text-align:left">mysql</td><td style="text-align:left">mysql02</td><td style="text-align:left">mysql</td><td style="text-align:left">2Cx1Gx15G</td></tr></tbody></table><h1 id="一、系统基础配置"><a href="#一、系统基础配置" class="headerlink" title="一、系统基础配置"></a>一、系统基础配置</h1><h2 id="工作、日志及数据存储目录创建"><a href="#工作、日志及数据存储目录创建" class="headerlink" title="工作、日志及数据存储目录创建"></a>工作、日志及数据存储目录创建</h2><p>deploy节点执行</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在deploy主机也创建对应目录</span></span><br><span class="line"><span class="built_in">mkdir</span> -p /export/servers</span><br><span class="line"><span class="built_in">mkdir</span> -p /export/logs</span><br><span class="line"><span class="built_in">mkdir</span> -p /export/data</span><br><span class="line"><span class="built_in">mkdir</span> -p /export/upload</span><br><span class="line"></span><br><span class="line"><span class="comment"># 分发命令到所有节点</span></span><br><span class="line">ansible all -m <span class="built_in">command</span> -a <span class="string">&quot;mkdir -p /export/servers&quot;</span></span><br><span class="line">ansible all -m <span class="built_in">command</span> -a <span class="string">&quot;mkdir -p /export/logs&quot;</span></span><br><span class="line">ansible all -m <span class="built_in">command</span> -a <span class="string">&quot;mkdir -p /export/data&quot;</span></span><br><span class="line">ansible all -m <span class="built_in">command</span> -a <span class="string">&quot;mkdir -p /export/upload&quot;</span></span><br></pre></td></tr></table></figure><h2 id="取消SELINUX设定，关闭防火墙和关闭交换分区"><a href="#取消SELINUX设定，关闭防火墙和关闭交换分区" class="headerlink" title="取消SELINUX设定，关闭防火墙和关闭交换分区"></a>取消SELINUX设定，关闭防火墙和关闭交换分区</h2><p>deploy节点执行</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">取消SELINUX设定</span></span><br><span class="line">ansible k8s -m command -a &quot;setenforce 0&quot;</span><br><span class="line">ansible k8s -m command -a &quot;sed --follow-symlinks -i &#x27;s/SELINUX=enforcing/SELINUX=disabled/g&#x27; /etc/selinux/config&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">关闭防火墙</span></span><br><span class="line">ansible k8s -m command -a &quot;firewall-cmd --set-default-zone=trusted&quot;</span><br><span class="line">ansible k8s -m command -a &quot;firewall-cmd --complete-reload&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">临时关闭交换分区</span></span><br><span class="line">ansible k8s -m command -a &quot;swapoff -a&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置系统加载时关闭交换分区</span></span><br><span class="line">ansible  k8s  -m shell -a &quot;yes | cp /etc/fstab /etc/fstab_bak&quot;</span><br><span class="line">ansible  k8s  -m shell -a &quot;cat /etc/fstab_bak | grep -v swap &gt; /etc/fstab&quot;</span><br><span class="line">ansible  k8s  -m shell -a &quot;echo vm.swappiness = 0 &gt;&gt; /etc/sysctl.d/k8s.conf&quot;</span><br><span class="line">ansible  k8s  -m shell -a &quot;sysctl -p /etc/sysctl.d/k8s.conf&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>如果对sysctl加载顺序感兴趣，可以执行<code>sysctl --system</code>查看</p><p><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202308022353017.png" alt=""></p><h2 id="ulimit优化"><a href="#ulimit优化" class="headerlink" title="ulimit优化"></a>ulimit优化</h2><p>ulimit用来限制每个用户可以使用的资源，如CPU、内存、句柄等。</p><p><code>/etc/security/limits.conf</code>设置以下内容：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">* soft memlock unlimited</span><br><span class="line">* hard memlock unlimited</span><br><span class="line">* soft <span class="built_in">nproc</span> 102400</span><br><span class="line">* hard <span class="built_in">nproc</span> 102400</span><br><span class="line">* soft nofile 1048576</span><br><span class="line">* hard nofile 1048576</span><br></pre></td></tr></table></figure><p>ansible命令：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ansible all -m shell -a <span class="string">&quot;cat &gt;&gt; /etc/security/limits.conf &lt;&lt; EOF</span></span><br><span class="line"><span class="string">* soft memlock unlimited</span></span><br><span class="line"><span class="string">* hard memlock unlimited</span></span><br><span class="line"><span class="string">* soft nproc 102400</span></span><br><span class="line"><span class="string">* hard nproc 102400</span></span><br><span class="line"><span class="string">* soft nofile 1048576</span></span><br><span class="line"><span class="string">* hard nofile 1048576</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">EOF&quot;</span></span><br></pre></td></tr></table></figure><h2 id="内核及网络参数优化"><a href="#内核及网络参数优化" class="headerlink" title="内核及网络参数优化"></a>内核及网络参数优化</h2><p>所有节点的<code>/etc/sysctl.conf</code>添加下面配置信息，可以通过ansible命令批量添加。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">fs.file-max = 1048576</span><br><span class="line">net.ipv4.tcp_syncookies = 1</span><br><span class="line">net.ipv4.tcp_tw_reuse = 1</span><br><span class="line">net.ipv4.tcp_fin_timeout = 5</span><br><span class="line">net.ipv4.neigh.default.gc_stale_time = 120</span><br><span class="line">net.ipv4.conf.default.rp_filter = 0</span><br><span class="line">net.ipv4.conf.all.rp_filter = 0</span><br><span class="line">net.ipv4.conf.all.arp_announce = 2</span><br><span class="line">net.ipv4.conf.lo.arp_announce = 2 </span><br><span class="line">vm.max_map_count = 262144</span><br></pre></td></tr></table></figure><p>ansible命令：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">ansible all -m shell -a <span class="string">&quot;cat &gt;&gt; /etc/sysctl.conf &lt;&lt; EOF</span></span><br><span class="line"><span class="string">fs.file-max = 1048576</span></span><br><span class="line"><span class="string">net.ipv4.tcp_syncookies = 1</span></span><br><span class="line"><span class="string">net.ipv4.tcp_tw_reuse = 1</span></span><br><span class="line"><span class="string">net.ipv4.tcp_fin_timeout = 5</span></span><br><span class="line"><span class="string">net.ipv4.neigh.default.gc_stale_time = 120</span></span><br><span class="line"><span class="string">net.ipv4.conf.default.rp_filter = 0</span></span><br><span class="line"><span class="string">net.ipv4.conf.all.rp_filter = 0</span></span><br><span class="line"><span class="string">net.ipv4.conf.all.arp_announce = 2</span></span><br><span class="line"><span class="string">net.ipv4.conf.lo.arp_announce = 2 </span></span><br><span class="line"><span class="string">vm.max_map_count = 262144</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">EOF&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 重新加载让配置生效</span></span><br><span class="line">ansible all -m <span class="built_in">command</span> -a <span class="string">&quot;sysctl -p&quot;</span></span><br><span class="line"><span class="comment"># 查询所有配置，根据需要执行</span></span><br><span class="line">sysctl -a</span><br></pre></td></tr></table></figure><h2 id="Kubernetes主机hosts设置"><a href="#Kubernetes主机hosts设置" class="headerlink" title="Kubernetes主机hosts设置"></a>Kubernetes主机hosts设置</h2><p><code>cd /export/upload &amp;&amp; vim hosts_set.sh</code>，输入下面内容:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">cat</span> &gt; /etc/hosts &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4</span></span><br><span class="line"><span class="string">::1         localhost localhost.localdomain localhost6 localhost6.localdomain6</span></span><br><span class="line"><span class="string">192.168.2.99 deploy harbor</span></span><br><span class="line"><span class="string">192.168.2.100 master01</span></span><br><span class="line"><span class="string">192.168.2.101 worker01</span></span><br><span class="line"><span class="string">192.168.2.102 worker02</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><p>deploy主机执行：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ansible k8s -m copy -a <span class="string">&#x27;src=/export/upload/hosts_set.sh dest=/export/upload&#x27;</span></span><br><span class="line">ansible k8s -m <span class="built_in">command</span> -a <span class="string">&#x27;sh /export/upload/hosts_set.sh&#x27;</span></span><br></pre></td></tr></table></figure><h1 id="Deploy主机环境搭建"><a href="#Deploy主机环境搭建" class="headerlink" title="Deploy主机环境搭建"></a>Deploy主机环境搭建</h1><h2 id="Docker安装"><a href="#Docker安装" class="headerlink" title="Docker安装"></a>Docker安装</h2><p>deploy主机的docker主要用于harbor针对镜像的操作，包括镜像的打tag以及push，用于后期部署pod的时候直接通过harbor私有镜像库拉取。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在线安装</span></span><br><span class="line">yum -y install docker-ce-20.10.17</span><br><span class="line"><span class="comment"># 或者提前上传docker及其依赖rpm包，进行离线安装：yum -y ./*rpm</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动docker</span></span><br><span class="line">systemctl start docker</span><br><span class="line"><span class="comment"># 查看Docker状态</span></span><br><span class="line">systemctl status docker</span><br><span class="line"><span class="comment"># 查看docker版本</span></span><br><span class="line">docker version</span><br><span class="line"><span class="comment"># 设置开机自启</span></span><br><span class="line">systemctl <span class="built_in">enable</span> docker </span><br></pre></td></tr></table></figure><h2 id="docker-compose安装"><a href="#docker-compose安装" class="headerlink" title="docker-compose安装"></a>docker-compose安装</h2><p>harbor私有镜像库的依赖docker-compose，deploy主机安装。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">可以打开下面网址，用PC下载docker-compose-linux-x86_64后，通过ftp上传到deploy服务器，目录需要有写权限</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">curl -L https://github.com/docker/compose/releases/download/v2.20.0/docker-compose-linux-x86_64 -o docker-compose</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">移动到/usr/local/bin/并添加执行权限</span></span><br><span class="line">mv docker-compose /usr/local/bin/</span><br><span class="line">chmod +x /usr/local/bin/docker-compose</span><br><span class="line">docker-compose version</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看docker-compose的版本</span></span><br><span class="line">docker-compose version</span><br></pre></td></tr></table></figure><h2 id="Harbor安装"><a href="#Harbor安装" class="headerlink" title="Harbor安装"></a>Harbor安装</h2><p>私有镜像仓库，deploy主机安装。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载</span></span><br><span class="line">wget https://github.com/goharbor/harbor/releases/download/v2.4.3/harbor-offline-installer-v2.4.3.tgz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解压并进行配置</span></span><br><span class="line">tar -xzvf harbor-offline-installer-v2.4.3.tgz -C /export/servers/</span><br><span class="line"><span class="built_in">cd</span> /export/servers/harbor</span><br><span class="line"><span class="built_in">mv</span> harbor.yml.tmpl harbor.yml</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="修改配置文件harbor-yml"><a href="#修改配置文件harbor-yml" class="headerlink" title="修改配置文件harbor.yml"></a>修改配置文件harbor.yml</h3><p>执行配置文件修改<code>vim harbor.yml</code>：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.修改对应配置如下，注意配置文件为yml，修改需要符合yml语法</span></span><br><span class="line"><span class="attr">hostname:</span> <span class="number">192.168</span><span class="number">.2</span><span class="number">.99</span></span><br><span class="line"><span class="attr">http:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8090</span></span><br><span class="line"></span><br><span class="line"><span class="attr">data_volume:</span> <span class="string">/export/data/harbor</span></span><br><span class="line"></span><br><span class="line"><span class="attr">log:</span></span><br><span class="line">  <span class="attr">location:</span> <span class="string">/export/logs/harbor</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.注释下面内容</span></span><br><span class="line"><span class="comment"># https related config</span></span><br><span class="line"><span class="comment">#https:</span></span><br><span class="line">  <span class="comment"># https port for harbor, default is 443</span></span><br><span class="line">  <span class="comment">#port: 443</span></span><br><span class="line">  <span class="comment"># The path of cert and key files for nginx</span></span><br><span class="line">  <span class="comment">#certificate: /your/certificate/path</span></span><br><span class="line">  <span class="comment">#private_key: /your/private/key/path</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.配置管理员密码</span></span><br><span class="line"><span class="attr">harbor_admin_password:</span> <span class="string">harbor950101</span></span><br><span class="line"><span class="attr">database:</span></span><br><span class="line">  <span class="comment"># The password for the root user of Harbor DB. Change this before any production use.</span></span><br><span class="line">  <span class="attr">password:</span> <span class="string">admin</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>执行命令使配置文件修改生效</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./prepare  <span class="comment"># 如果有二次修改harbor.yml文件，需执行该命令让配置文件生效</span></span><br><span class="line">./install.sh --<span class="built_in">help</span> <span class="comment"># 查看启动参数</span></span><br></pre></td></tr></table></figure><h3 id="导入Harbor镜像"><a href="#导入Harbor镜像" class="headerlink" title="导入Harbor镜像"></a>导入Harbor镜像</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /export/servers/harbor</span><br><span class="line"><span class="comment"># harbor-offline-installer-v2.4.3.tgz解压后可以看到harbor.v2.4.3.tar.gz，用docker导入</span></span><br><span class="line">docker load -i harbor.v2.4.3.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看镜像</span></span><br><span class="line">docker images</span><br><span class="line"></span><br><span class="line">REPOSITORY                      TAG       IMAGE ID       CREATED       SIZE</span><br><span class="line">goharbor/harbor-exporter        v2.4.3    776ac6ee91f4   4 weeks ago   81.5MB</span><br><span class="line">goharbor/chartmuseum-photon     v2.4.3    f39a9694988d   4 weeks ago   172MB</span><br><span class="line">goharbor/redis-photon           v2.4.3    b168e9750dc8   4 weeks ago   154MB</span><br><span class="line">goharbor/trivy-adapter-photon   v2.4.3    a406a715461c   4 weeks ago   251MB</span><br><span class="line">goharbor/notary-server-photon   v2.4.3    da89404c7cf9   4 weeks ago   109MB</span><br><span class="line">goharbor/notary-signer-photon   v2.4.3    38468ac13836   4 weeks ago   107MB</span><br><span class="line">goharbor/harbor-registryctl     v2.4.3    61243a84642b   4 weeks ago   135MB</span><br><span class="line">goharbor/registry-photon        v2.4.3    9855479dd6fa   4 weeks ago   77.9MB</span><br><span class="line">goharbor/nginx-photon           v2.4.3    0165c71ef734   4 weeks ago   44.4MB</span><br><span class="line">goharbor/harbor-log             v2.4.3    57ceb170dac4   4 weeks ago   161MB</span><br><span class="line">goharbor/harbor-jobservice      v2.4.3    7fea87c4b884   4 weeks ago   219MB</span><br><span class="line">goharbor/harbor-core            v2.4.3    d864774a3b8f   4 weeks ago   197MB</span><br><span class="line">goharbor/harbor-portal          v2.4.3    85f00db66862   4 weeks ago   53.4MB</span><br><span class="line">goharbor/harbor-db              v2.4.3    7693d44a2ad6   4 weeks ago   225MB</span><br><span class="line">goharbor/prepare                v2.4.3    c882d74725ee   4 weeks ago   268MB</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>如果没有按照<code>编辑harbor.yml</code>章节注释，会遇到下面报错。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">prepare base dir is set to /export/servers/harbor</span><br><span class="line">Error happened in config validation...</span><br><span class="line">ERROR:root:Error: The protocol is https but attribute ssl_cert is not set</span><br></pre></td></tr></table></figure><h3 id="启动Harbor"><a href="#启动Harbor" class="headerlink" title="启动Harbor"></a>启动Harbor</h3><p>如果配置文件harbor.yml有改动，需要执行<code>./prepare</code>使配置修改生效后再启动。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./install.sh --with-chartmuseum</span><br></pre></td></tr></table></figure><p>启动成功后，浏览器可以直接访问Harbor：<code>http://192.168.2.99:8090/</code>，根据harbor.yml配置的管理员帐号和密码登陆</p><p><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202308030121841.png" alt=""></p><p><strong>配置对Harbor的HTTPS访问请参考：</strong><br><a href="https://blog.csdn.net/RtxTitanV/article/details/107140001">https://blog.csdn.net/RtxTitanV/article/details/107140001</a></p><h1 id="Kubernetes集群配置"><a href="#Kubernetes集群配置" class="headerlink" title="Kubernetes集群配置"></a>Kubernetes集群配置</h1><h2 id="Docker安装-1"><a href="#Docker安装-1" class="headerlink" title="Docker安装"></a>Docker安装</h2><p>docker离线下载地址：<a href="https://download.docker.com/linux/static/stable/x86_64/">https://download.docker.com/linux/static/stable/x86_64/</a></p><p>配置docker-ce.repo的镜像仓库</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo -O /etc/yum.repos.d/docker-ce.repo</span><br><span class="line"><span class="comment"># 或者通过下面方式添加下面方式添加镜像仓库</span></span><br><span class="line"><span class="comment"># yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>我们要在所有K8s节点安装Docker，因此下载回来后离线安装更快捷。</p><p>yum命令只下载不安装命令：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install --downloadonly -downloaddir /export/upload docker-ce-20.10.17</span><br></pre></td></tr></table></figure><p>deploy主机执行下面的ansible命令，将打包好的压缩包分发给k8s集群机器，并执行解压、安装，启动docker等操作。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 分发安装包</span></span><br><span class="line">ansible k8s -m copy -a <span class="string">&quot;src=/export/upload/docker-rpm.tar.gz dest=/export/upload/&quot;</span></span><br><span class="line"><span class="comment"># 解压并安装</span></span><br><span class="line">ansible k8s -m shell -a <span class="string">&quot;tar -xzvf /export/upload/docker-rpm.tar.gz -C /export/upload/ &amp;&amp; yum -y install /export/upload/docker-rpm/*&quot;</span></span><br><span class="line"><span class="comment"># 设置Docker开机自启，以及启动Docker</span></span><br><span class="line">ansible k8s -m shell -a <span class="string">&quot;systemctl enable docker &amp;&amp; systemctl start docker&quot;</span></span><br><span class="line"><span class="comment"># 查看Docker启动状态</span></span><br><span class="line">ansible k8s -m shell -a <span class="string">&quot;docker version&quot;</span></span><br></pre></td></tr></table></figure><p>所有k8s节点返回下面消息证明完成安装</p><p><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202308030133314.png" alt=""></p><p><strong>附：常用压缩打包、解压缩命令</strong></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 打包</span></span><br><span class="line">tar –cvf xxx.tar &lt;file or <span class="built_in">dir</span>&gt;</span><br><span class="line"><span class="comment"># 打包并且压缩</span></span><br><span class="line">tar –zcvf docker-rpm.tar.gz &lt;file or <span class="built_in">dir</span>&gt;</span><br><span class="line"><span class="comment"># 解压缩到指定位置</span></span><br><span class="line">tar -xzvf docker-rpm.tar.gz  -C &lt;位置&gt;</span><br></pre></td></tr></table></figure><h2 id="Kubernetes安装"><a href="#Kubernetes安装" class="headerlink" title="Kubernetes安装"></a>Kubernetes安装</h2><p>deploy节点执行，所有k8s节点需要安装。</p><p>1、添加阿里云YUM的kubernetes软件源：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/yum.repos.d/kubernetes.repo &lt;&lt; EOF</span><br><span class="line">[kubernetes]</span><br><span class="line">name=Kubernetes</span><br><span class="line">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=0</span><br><span class="line">repo_gpgcheck=0</span><br><span class="line">gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>2、下载kubelet、kubeadm、kubectl组件但不安装：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y kubelet-1.22.4 kubeadm-1.22.4 kubectl-1.22.4 --downloadonly --downloaddir /export/download/kubeadm-rpm</span><br></pre></td></tr></table></figure><p>3、执行解压</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /export/download</span><br><span class="line">tar -zcvf kubeadm-rpm.tgz kubeadm-rpm</span><br></pre></td></tr></table></figure><p>4、分发到k8s集群所有节点并解压安装</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ansible k8s -m copy -a <span class="string">&quot;src=/export/upload/kubeadm-rpm.tgz dest=/export/upload/&quot;</span></span><br><span class="line">ansible k8s -m shell -a <span class="string">&quot;tar xzvf /export/upload/kubeadm-rpm.tgz -C /export/upload/ &amp;&amp; yum -y install /export/upload/kubeadm-rpm/*&quot;</span></span><br></pre></td></tr></table></figure><p>5、启动kubelet并设置开机自启</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible k8s -m shell -a <span class="string">&quot;systemctl enable kubelet &amp;&amp; systemctl start kubelet&quot;</span></span><br></pre></td></tr></table></figure><p>注：此时kubelet启动失败，会进入不断重启，这个是正常现象，执行init或join后问题会自动解决，对此官网有如下描述，也就是此时不用理会kubelet.service，可执行发下命令查看kubelet状态。</p><p><code>journalctl -xefu kubelet</code>可以查看日志：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Jul 29 08:34:33 k8s-worker02 systemd[1]: Starting kubelet: The Kubernetes Node Agent...</span><br><span class="line">-- Subject: Unit kubelet.service has begun start-up</span><br><span class="line">-- Defined-By: systemd</span><br><span class="line">-- Support: http://lists.freedesktop.org/mailman/listinfo/systemd-devel</span><br><span class="line">--</span><br><span class="line">-- Unit kubelet.service has begun starting up.</span><br><span class="line">Jul 29 08:34:33 k8s-worker02 kubelet[9377]: E0729 08:34:33.685622    9377 server.go:206] &quot;Failed to load kubelet config file&quot; err=&quot;failed to load Kubelet config file /var/lib/kubelet/config.yaml, error failed to read kubelet config file \&quot;/var/lib/kubelet/config.yaml\&quot;, error: open /var/lib/kubelet/config.yaml: no such file or directory&quot; path=&quot;/var/lib/kubelet/config.yaml&quot;</span><br><span class="line">Jul 29 08:34:33 k8s-worker02 systemd[1]: kubelet.service: main process exited, code=exited, status=1/FAILURE</span><br><span class="line">Jul 29 08:34:33 k8s-worker02 systemd[1]: Unit kubelet.service entered failed state.</span><br><span class="line">Jul 29 08:34:33 k8s-worker02 systemd[1]: kubelet.service failed.</span><br><span class="line">Jul 29 08:34:43 k8s-worker02 systemd[1]: kubelet.service holdoff time over, scheduling restart.</span><br><span class="line">Jul 29 08:34:43 k8s-worker02 systemd[1]: Started kubelet: The Kubernetes Node Agent.</span><br></pre></td></tr></table></figure><h3 id="Deploy主机下载镜像"><a href="#Deploy主机下载镜像" class="headerlink" title="Deploy主机下载镜像"></a>Deploy主机下载镜像</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Docker拉取镜像</span></span><br><span class="line">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/coredns:v1.8.4</span><br><span class="line">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:3.5.0-0</span><br><span class="line">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v1.22.4</span><br><span class="line">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v1.22.4</span><br><span class="line">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v1.22.4</span><br><span class="line">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v1.22.4</span><br><span class="line">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.5</span><br><span class="line">docker pull rancher/mirrored-flannelcni-flannel-cni-plugin:v1.1.0</span><br><span class="line">docker pull rancher/mirrored-flannelcni-flannel:v0.19.1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 导出镜像到/export/upload/docker-images/位置</span></span><br><span class="line"><span class="built_in">mkdir</span> -p /export/upload/docker-images/</span><br><span class="line">docker save -o /export/upload/docker-images/rancher-mirrored-flannelcni-flannel-v0.19.1.tar rancher/mirrored-flannelcni-flannel </span><br><span class="line">docker save -o /export/upload/docker-images/rancher-mirrored-flannelcni-flannel-cni-plugin-v1.1.0.tar rancher/mirrored-flannelcni-flannel-cni-plugin </span><br><span class="line">docker save -o /export/upload/docker-images/google_containers-kube-apiserver-v1.22.4.tar registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver </span><br><span class="line">docker save -o /export/upload/docker-images/google_containers-kube-controller-manager-v1.22.4.tar registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager </span><br><span class="line">docker save -o /export/upload/docker-images/google_containers-kube-scheduler-v1.22.4.tar registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler </span><br><span class="line">docker save -o /export/upload/docker-images/google_containers-kube-proxy-v1.22.4.tar registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy </span><br><span class="line">docker save -o /export/upload/docker-images/google_containers-etcd-3.5.0-0.tar registry.cn-hangzhou.aliyuncs.com/google_containers/etcd </span><br><span class="line">docker save -o /export/upload/docker-images/google_containers-coredns-v1.8.4.tar registry.cn-hangzhou.aliyuncs.com/google_containers/coredns </span><br><span class="line">docker save -o /export/upload/docker-images/google_containers-pause-3.5.tar registry.cn-hangzhou.aliyuncs.com/google_containers/pause </span><br><span class="line"></span><br><span class="line"><span class="comment"># Docker导入镜像</span></span><br><span class="line"><span class="built_in">cd</span> /export/upload/docker-images/</span><br><span class="line">docker load -i rancher-mirrored-flannelcni-flannel-v0.19.1.tar</span><br><span class="line">docker load -i rancher-mirrored-flannelcni-flannel-cni-plugin-v1.1.0.tar</span><br><span class="line">docker load -i google_containers-kube-apiserver-v1.22.4.tar</span><br><span class="line">docker load -i google_containers-kube-controller-manager-v1.22.4.tar</span><br><span class="line">docker load -i google_containers-kube-scheduler-v1.22.4.tar</span><br><span class="line">docker load -i google_containers-kube-proxy-v1.22.4.tar</span><br><span class="line">docker load -i google_containers-etcd-3.5.0-0.tar</span><br><span class="line">docker load -i google_containers-coredns-v1.8.4.tar</span><br><span class="line">docker load -i google_containers-pause-3.5.tar</span><br><span class="line"></span><br><span class="line"><span class="comment"># 镜像打harbor镜像库tag</span></span><br><span class="line">docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/coredns:v1.8.4 192.168.2.99:8090/community/coredns:v1.8.4</span><br><span class="line">docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:3.5.0-0 192.168.2.99:8090/community/etcd:3.5.0-0</span><br><span class="line">docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v1.22.4 192.168.2.99:8090/community/kube-apiserver:v1.22.4</span><br><span class="line">docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v1.22.4 192.168.2.99:8090/community/kube-controller-manager:v1.22.4</span><br><span class="line">docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v1.22.4 192.168.2.99:8090/community/kube-proxy:v1.22.4</span><br><span class="line">docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v1.22.4 192.168.2.99:8090/community/kube-scheduler:v1.22.4</span><br><span class="line">docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.5 192.168.2.99:8090/community/pause:3.5</span><br><span class="line">docker tag rancher/mirrored-flannelcni-flannel-cni-plugin:v1.1.0 192.168.2.99:8090/community/mirrored-flannelcni-flannel-cni-plugin:v1.1.0</span><br><span class="line">docker tag rancher/mirrored-flannelcni-flannel:v0.19.1 192.168.2.99:8090/community/mirrored-flannelcni-flannel:v0.19.1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 推送至harbor镜像库，后续可以通过docker pull从harbor中直接拉取</span></span><br><span class="line">docker push 192.168.2.99:8090/community/coredns:v1.8.4</span><br><span class="line">docker push 192.168.2.99:8090/community/etcd:3.5.0-0</span><br><span class="line">docker push 192.168.2.99:8090/community/kube-apiserver:v1.22.4</span><br><span class="line">docker push 192.168.2.99:8090/community/kube-controller-manager:v1.22.4</span><br><span class="line">docker push 192.168.2.99:8090/community/kube-proxy:v1.22.4</span><br><span class="line">docker push 192.168.2.99:8090/community/kube-scheduler:v1.22.4</span><br><span class="line">docker push 192.168.2.99:8090/community/pause:3.5</span><br><span class="line">docker push 192.168.2.99:8090/community/mirrored-flannelcni-flannel-cni-plugin:v1.1.0</span><br><span class="line">docker push 192.168.2.99:8090/community/mirrored-flannelcni-flannel:v0.19.1</span><br></pre></td></tr></table></figure><h4 id="可能遇到的问题"><a href="#可能遇到的问题" class="headerlink" title="可能遇到的问题"></a>可能遇到的问题</h4><p><strong>1、docker push推送过程中可能会报错，提示docker推送要求为https，而harbor服务端通信协议为http。</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@tsukasa docker-images]# docker push 192.168.2.99:8090/community/mirrored-flannelcni-flannel:v0.19.1</span><br><span class="line">The push refers to repository [192.168.2.99:8090/community/mirrored-flannelcni-flannel]</span><br><span class="line">Get &quot;https://192.168.2.99:8090/v2/&quot;: http: server gave HTTP response to HTTPS client</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>修改docker的配置文件/etc/docker/daemon.json（文件不存在则新增），添加下面内容，下面IP端口为harbor的http配置：</p><p><code>vim /etc/docker/daemon.json</code></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;insecure-registries&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="string">&quot;192.168.2.99:8090&quot;</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>重启docker服务、重新加载harbor镜像</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart docker.service</span><br><span class="line"><span class="comment"># 重新加载harbor</span></span><br><span class="line">docker load -i harbor.v2.4.3.tar.gz</span><br><span class="line"><span class="comment"># 启动Harbor</span></span><br><span class="line"><span class="built_in">cd</span> /export/servers/harbor</span><br><span class="line">./install.sh --with-chartmuseum</span><br></pre></td></tr></table></figure><p><strong>2、docker push推送过程中提示project community not found: project community not found</strong></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@tsukasa harbor]<span class="comment"># docker push 192.168.2.99:8090/community/coredns:v1.8.4</span></span><br><span class="line">The push refers to repository [192.168.2.99:8090/community/coredns]</span><br><span class="line">f72781b18181: Preparing</span><br><span class="line">225df95e717c: Preparing</span><br><span class="line">unauthorized: project community not found: project community not found</span><br></pre></td></tr></table></figure><p>解决办法是在harbor管理台创建项目</p><p><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202307300117189.png" alt=""></p><p><strong>3、docker push进行推送时出现unauthorized: unauthorized to access repository</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@tsukasa harbor]# docker push 192.168.2.99:8090/community/coredns:v1.8.4</span><br><span class="line">The push refers to repository [192.168.2.99:8090/community/coredns]</span><br><span class="line">f72781b18181: Preparing</span><br><span class="line">225df95e717c: Preparing</span><br><span class="line">unauthorized: unauthorized to access repository: community/coredns, action: push: unauthorized to access repository: community/coredns, action: push</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>解决办法是在需要推送镜像的主机上（这里是deploy）登陆harbor：<code>docker login 192.168.2.99:8090</code></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@tsukasa harbor]<span class="comment"># docker login 192.168.2.99:8090</span></span><br><span class="line">Username: admin</span><br><span class="line">Password:</span><br><span class="line">WARNING! Your password will be stored unencrypted <span class="keyword">in</span> /root/.docker/config.json.</span><br><span class="line">Configure a credential helper to remove this warning. See</span><br><span class="line">https://docs.docker.com/engine/reference/commandline/login/<span class="comment">#credentials-store</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="Master节点"><a href="#Master节点" class="headerlink" title="Master节点"></a>Master节点</h3><p>通常地，k8s集群Master节点有多个，本地因资源问题，只创建了一台master。</p><h4 id="部署首个Master"><a href="#部署首个Master" class="headerlink" title="部署首个Master"></a>部署首个Master</h4><p>1、在docker配置文件/etc/docker/daemon.json中添加下面内容，重启docker</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;exec-opts&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;native.cgroupdriver=systemd&quot;</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>重启docker</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart docker</span><br></pre></td></tr></table></figure><p>3、在k8s-master(ip:192.168.2.100)执行初始化：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 如果初始化失败，先强制重置kubeadm再初始化：kubeadm reset -f</span></span><br><span class="line"><span class="comment"># 初始化</span></span><br><span class="line">kubeadm init \</span><br><span class="line">--control-plane-endpoint <span class="string">&quot;192.168.2.100:6443&quot;</span> \</span><br><span class="line">--image-repository 192.168.2.99:8090/community \</span><br><span class="line">--kubernetes-version v1.22.4 \</span><br><span class="line">--service-cidr=172.16.0.0/16 \</span><br><span class="line">--pod-network-cidr=10.244.0.0/16 \</span><br><span class="line">--token <span class="string">&quot;abcdef.0123456789abcdef&quot;</span> \</span><br><span class="line">--token-ttl <span class="string">&quot;0&quot;</span> \</span><br><span class="line">--upload-certs</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><code>--image-repository</code>参数是镜像仓库，目前设置为搭建的harbor，也可以使用阿里云<code>registry.aliyuncs.com/google_containers</code></p><p>执行后的控台输出如下，进行其他Master和Worker节点初始化需要用到</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master ~]# kubeadm init \</span><br><span class="line">&gt; --control-plane-endpoint &quot;192.168.2.100:6443&quot; \</span><br><span class="line">&gt; --image-repository 192.168.2.99:8090/community \</span><br><span class="line">&gt; --kubernetes-version v1.22.4 \</span><br><span class="line">&gt; --service-cidr=172.16.0.0/16 \</span><br><span class="line">&gt; --pod-network-cidr=10.244.0.0/16 \</span><br><span class="line">&gt; --token &quot;abcdef.0123456789abcdef&quot; \</span><br><span class="line">&gt; --token-ttl &quot;0&quot; \</span><br><span class="line">&gt; --upload-certs</span><br><span class="line">[init] Using Kubernetes version: v1.22.4</span><br><span class="line">[preflight] Running pre-flight checks</span><br><span class="line">        [WARNING Firewalld]: firewalld is active, please ensure ports [6443 10250] are open or your cluster may not function correctly</span><br><span class="line">        [WARNING Hostname]: hostname &quot;k8s-master&quot; could not be reached</span><br><span class="line">        [WARNING Hostname]: hostname &quot;k8s-master&quot;: lookup k8s-master on 223.5.5.5:53: no such host</span><br><span class="line">[preflight] Pulling images required for setting up a Kubernetes cluster</span><br><span class="line">[preflight] This might take a minute or two, depending on the speed of your internet connection</span><br><span class="line">[preflight] You can also perform this action in beforehand using &#x27;kubeadm config images pull&#x27;</span><br><span class="line">[certs] Using certificateDir folder &quot;/etc/kubernetes/pki&quot;</span><br><span class="line">[certs] Generating &quot;ca&quot; certificate and key</span><br><span class="line">[certs] Generating &quot;apiserver&quot; certificate and key</span><br><span class="line">[certs] apiserver serving cert is signed for DNS names [k8s-master kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.cluster.local] and IPs [172.16.0.1 192.168.2.100]</span><br><span class="line">[certs] Generating &quot;apiserver-kubelet-client&quot; certificate and key</span><br><span class="line">[certs] Generating &quot;front-proxy-ca&quot; certificate and key</span><br><span class="line">[certs] Generating &quot;front-proxy-client&quot; certificate and key</span><br><span class="line">[certs] Generating &quot;etcd/ca&quot; certificate and key</span><br><span class="line">[certs] Generating &quot;etcd/server&quot; certificate and key</span><br><span class="line">[certs] etcd/server serving cert is signed for DNS names [k8s-master localhost] and IPs [192.168.2.100 127.0.0.1 ::1]</span><br><span class="line">[certs] Generating &quot;etcd/peer&quot; certificate and key</span><br><span class="line">[certs] etcd/peer serving cert is signed for DNS names [k8s-master localhost] and IPs [192.168.2.100 127.0.0.1 ::1]</span><br><span class="line">[certs] Generating &quot;etcd/healthcheck-client&quot; certificate and key</span><br><span class="line">[certs] Generating &quot;apiserver-etcd-client&quot; certificate and key</span><br><span class="line">[certs] Generating &quot;sa&quot; key and public key</span><br><span class="line">[kubeconfig] Using kubeconfig folder &quot;/etc/kubernetes&quot;</span><br><span class="line">[kubeconfig] Writing &quot;admin.conf&quot; kubeconfig file</span><br><span class="line">[kubeconfig] Writing &quot;kubelet.conf&quot; kubeconfig file</span><br><span class="line">[kubeconfig] Writing &quot;controller-manager.conf&quot; kubeconfig file</span><br><span class="line">[kubeconfig] Writing &quot;scheduler.conf&quot; kubeconfig file</span><br><span class="line">[kubelet-start] Writing kubelet environment file with flags to file &quot;/var/lib/kubelet/kubeadm-flags.env&quot;</span><br><span class="line">[kubelet-start] Writing kubelet configuration to file &quot;/var/lib/kubelet/config.yaml&quot;</span><br><span class="line">[kubelet-start] Starting the kubelet</span><br><span class="line">[control-plane] Using manifest folder &quot;/etc/kubernetes/manifests&quot;</span><br><span class="line">[control-plane] Creating static Pod manifest for &quot;kube-apiserver&quot;</span><br><span class="line">[control-plane] Creating static Pod manifest for &quot;kube-controller-manager&quot;</span><br><span class="line">[control-plane] Creating static Pod manifest for &quot;kube-scheduler&quot;</span><br><span class="line">[etcd] Creating static Pod manifest for local etcd in &quot;/etc/kubernetes/manifests&quot;</span><br><span class="line">[wait-control-plane] Waiting for the kubelet to boot up the control plane as static Pods from directory &quot;/etc/kubernetes/manifests&quot;. This can take up to 4m0s</span><br><span class="line">[apiclient] All control plane components are healthy after 7.005575 seconds</span><br><span class="line">[upload-config] Storing the configuration used in ConfigMap &quot;kubeadm-config&quot; in the &quot;kube-system&quot; Namespace</span><br><span class="line">[kubelet] Creating a ConfigMap &quot;kubelet-config-1.22&quot; in namespace kube-system with the configuration for the kubelets in the cluster</span><br><span class="line">[upload-certs] Storing the certificates in Secret &quot;kubeadm-certs&quot; in the &quot;kube-system&quot; Namespace</span><br><span class="line">[upload-certs] Using certificate key:</span><br><span class="line">7ed3ef5d6b04a668e7bed67e419fd9f69ce482047350e5b391357005064db994</span><br><span class="line">[mark-control-plane] Marking the node k8s-master as control-plane by adding the labels: [node-role.kubernetes.io/master(deprecated) node-role.kubernetes.io/control-plane node.kubernetes.io/exclude-from-external-load-balancers]</span><br><span class="line">[mark-control-plane] Marking the node k8s-master as control-plane by adding the taints [node-role.kubernetes.io/master:NoSchedule]</span><br><span class="line">[bootstrap-token] Using token: abcdef.0123456789abcdef</span><br><span class="line">[bootstrap-token] Configuring bootstrap tokens, cluster-info ConfigMap, RBAC Roles</span><br><span class="line">[bootstrap-token] configured RBAC rules to allow Node Bootstrap tokens to get nodes</span><br><span class="line">[bootstrap-token] configured RBAC rules to allow Node Bootstrap tokens to post CSRs in order for nodes to get long term certificate credentials</span><br><span class="line">[bootstrap-token] configured RBAC rules to allow the csrapprover controller automatically approve CSRs from a Node Bootstrap Token</span><br><span class="line">[bootstrap-token] configured RBAC rules to allow certificate rotation for all node client certificates in the cluster</span><br><span class="line">[bootstrap-token] Creating the &quot;cluster-info&quot; ConfigMap in the &quot;kube-public&quot; namespace</span><br><span class="line">[kubelet-finalize] Updating &quot;/etc/kubernetes/kubelet.conf&quot; to point to a rotatable kubelet client certificate and key</span><br><span class="line">[addons] Applied essential addon: CoreDNS</span><br><span class="line">[addons] Applied essential addon: kube-proxy</span><br><span class="line"></span><br><span class="line">Your Kubernetes control-plane has initialized successfully!</span><br><span class="line"></span><br><span class="line">To start using your cluster, you need to run the following as a regular user:</span><br><span class="line"></span><br><span class="line">  mkdir -p $HOME/.kube</span><br><span class="line">  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br><span class="line">  sudo chown $(id -u):$(id -g) $HOME/.kube/config</span><br><span class="line"></span><br><span class="line">Alternatively, if you are the root user, you can run:</span><br><span class="line"></span><br><span class="line">  export KUBECONFIG=/etc/kubernetes/admin.conf</span><br><span class="line"></span><br><span class="line">You should now deploy a pod network to the cluster.</span><br><span class="line">Run &quot;kubectl apply -f [podnetwork].yaml&quot; with one of the options listed at:</span><br><span class="line">  https://kubernetes.io/docs/concepts/cluster-administration/addons/</span><br><span class="line"></span><br><span class="line">You can now join any number of the control-plane node running the following command on each as root:</span><br><span class="line"></span><br><span class="line">  kubeadm join 192.168.2.100:6443 --token abcdef.0123456789abcdef \</span><br><span class="line">        --discovery-token-ca-cert-hash sha256:fdfca7204c17842d264752cc0cf9efcf4da515837f5deb7f69cc3ec3f3fe00c6 \</span><br><span class="line">        --control-plane --certificate-key 7ed3ef5d6b04a668e7bed67e419fd9f69ce482047350e5b391357005064db994</span><br><span class="line"></span><br><span class="line">Please note that the certificate-key gives access to cluster sensitive data, keep it secret!</span><br><span class="line">As a safeguard, uploaded-certs will be deleted in two hours; If necessary, you can use</span><br><span class="line">&quot;kubeadm init phase upload-certs --upload-certs&quot; to reload certs afterward.</span><br><span class="line"></span><br><span class="line">Then you can join any number of worker nodes by running the following on each as root:</span><br><span class="line"></span><br><span class="line">kubeadm join 192.168.2.100:6443 --token abcdef.0123456789abcdef \</span><br><span class="line">        --discovery-token-ca-cert-hash sha256:fdfca7204c17842d264752cc0cf9efcf4da515837f5deb7f69cc3ec3f3fe00c6</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>如果控制台信息被清理，可以在通过下面的命令查看token</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看token列表</span></span><br><span class="line">kubeadm token list</span><br></pre></td></tr></table></figure><p>如果token过期，可以重新创建再查看token</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubeadm token create --print-join-command</span><br><span class="line">kubeadm token list</span><br></pre></td></tr></table></figure><p>4、生成kubelet环境配置文件</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">sudo <span class="built_in">cp</span> -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">sudo <span class="built_in">chown</span> $(<span class="built_in">id</span> -u):$(<span class="built_in">id</span> -g) <span class="variable">$HOME</span>/.kube/config</span><br></pre></td></tr></table></figure><h4 id="配置网络插件flannel"><a href="#配置网络插件flannel" class="headerlink" title="配置网络插件flannel"></a>配置网络插件flannel</h4><p>Kubernetes跨主机容器之间的通信组件，目前主流的是flannel和calico，这里选择flannel。<br>如果使用<code>kubectl get nodes</code>查看节点状态，Worker节点显示<code>NotReady</code>，是因为缺少网络插件导致的。</p><p>（1）创建/export/servers/kubernetes/flannel.yml配置文件，内容参考附录。</p><p>在执行下面的命令</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 应用flannel配置文件</span></span><br><span class="line">kubectl apply -f /export/servers/kubernetes/flannel.yml</span><br></pre></td></tr></table></figure><p>如果配置文件有改动需要重新加载，可以执行下面命令进行撤销</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete -f /export/servers/kubernetes/flannel.yml</span><br></pre></td></tr></table></figure><h4 id="其他Master"><a href="#其他Master" class="headerlink" title="其他Master"></a>其他Master</h4><p>复制首个Master节点kubeadm初始化后的master节点加入命令，到其他Master节点执行即可。也可以用deploy主机使用ansible命令批量执行。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubeadm <span class="built_in">join</span> 192.168.2.100:6443 --token abcdef.0123456789abcdef \</span><br><span class="line">      --discovery-token-ca-cert-hash sha256:fdfca7204c17842d264752cc0cf9efcf4da515837f5deb7f69cc3ec3f3fe00c6 \</span><br><span class="line">      --control-plane --certificate-key 7ed3ef5d6b04a668e7bed67e419fd9f69ce482047350e5b391357005064db994</span><br></pre></td></tr></table></figure><h3 id="Worker节点"><a href="#Worker节点" class="headerlink" title="Worker节点"></a>Worker节点</h3><p>复制首个Master节点kubeadm初始化后的Worker节点加入命令，到所有Worker节点分别执行。也可以用deploy主机使用ansible命令批量执行。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubeadm <span class="built_in">join</span> 192.168.2.100:6443 --token abcdef.0123456789abcdef \</span><br><span class="line">        --discovery-token-ca-cert-hash sha256:fdfca7204c17842d264752cc0cf9efcf4da515837f5deb7f69cc3ec3f3fe00c6</span><br></pre></td></tr></table></figure><p>ansible命令</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ansible worker -m shell -a <span class="string">&quot;kubeadm join 192.168.2.100:6443 --token abcdef.0123456789abcdef \</span></span><br><span class="line"><span class="string">        --discovery-token-ca-cert-hash sha256:fdfca7204c17842d264752cc0cf9efcf4da515837f5deb7f69cc3ec3f3fe00c6&quot;</span></span><br></pre></td></tr></table></figure><p>查看所有pod状态</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods -A</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202308030235232.png" alt=""></p><p>至此，Kubernetes集群已经建立！</p><h3 id="可能遇到的问题-1"><a href="#可能遇到的问题-1" class="headerlink" title="可能遇到的问题"></a>可能遇到的问题</h3><h4 id="1-Pod状态显示ImagePullBackoff"><a href="#1-Pod状态显示ImagePullBackoff" class="headerlink" title="1.Pod状态显示ImagePullBackoff"></a>1.Pod状态显示ImagePullBackoff</h4><p>需要手动拉取镜像，等待k8s重试成功后即可解决</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull rancher/mirrored-flannelcni-flannel:v0.19.1</span><br></pre></td></tr></table></figure><h4 id="常用的定位命令"><a href="#常用的定位命令" class="headerlink" title="常用的定位命令"></a>常用的定位命令</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看命名空间kube-system详细的pod状态</span></span><br><span class="line">kubectl get pod -n kube-system -o wide</span><br><span class="line"><span class="comment"># 查看pod的日志</span></span><br><span class="line">kubectl describe pod &lt;Pod名称&gt; -n &lt;命名空间&gt;</span><br><span class="line"><span class="comment"># 查看pod的详细日志，可以查看到代码报错的堆栈</span></span><br><span class="line">kubectl logs -f kubernetes-dashboard-658b66597c-jcw4s -n kubernetes-dashboard </span><br></pre></td></tr></table></figure><h3 id="Kubernetes常用命令"><a href="#Kubernetes常用命令" class="headerlink" title="Kubernetes常用命令"></a>Kubernetes常用命令</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">kubectl get all <span class="comment">#查看所有启动的配置，包括容器，服务，监视等等等等 --all-namespaces 参数 可以看到所有命名空间的 -o wide 可以看到更多的信息，如容器启动在哪台机器上</span></span><br><span class="line">kubectl get pods -o wide <span class="comment">#查看pod</span></span><br><span class="line">kubectl get pod name --output json <span class="comment">#以JSON格式输出POD信息:</span></span><br><span class="line">kubectl get pod name --output yaml <span class="comment">#以yaml格式输出POD信息</span></span><br><span class="line">kubectl get svc  <span class="comment">#查询所有实例的对外端口</span></span><br><span class="line">kubectl describe pod xxx-mariadb-0   <span class="comment">#查看pod的详情</span></span><br><span class="line">kubectl get nodes <span class="comment">#查看node节点</span></span><br><span class="line">kubectl get rc,namespace <span class="comment">#查看rc ,namespace</span></span><br><span class="line">kubectl <span class="built_in">exec</span> -ti xxx-jw64d sh    <span class="comment">#登陆到某个模块实例查日志或配置</span></span><br><span class="line">kubectl cluster-info     <span class="comment">#查看集群状态</span></span><br><span class="line">kubectl get deployments <span class="comment">#查询Deployment当前状态</span></span><br><span class="line">NAME               DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">nginx-deployment   3         3         3            3           2h</span><br><span class="line">其中DESIRED为期望的Pod数量，CURRENT为当前的数量，UP-TO-DATE为已更新的数量，AVAILABLE为已运行的数量</span><br><span class="line">kubectl get rs <span class="comment">#Replica Set（RS）是k8s新一代的Pod controller</span></span><br><span class="line">kubectl get cs <span class="comment">#检查组件状态是否都正常 component status （CS）</span></span><br><span class="line">kubectl get pods --show-labels</span><br><span class="line">kubectl describe deployments</span><br><span class="line">kubectl get pvc <span class="comment">#获取 StatefulSet 的 PersistentVolumeClaims</span></span><br><span class="line">kubectl <span class="built_in">exec</span> nginx -- <span class="built_in">printenv</span> | grep SERVICE <span class="comment">#检查正在运行的 Nginx Pod 的环境变量</span></span><br><span class="line">kubectl get services kube-dns --namespace=kube-system <span class="comment">#检查 DNS 插件 Service</span></span><br><span class="line">kubectl get pods -o yaml | grep -i podip</span><br><span class="line">kubectl <span class="built_in">exec</span> xxx-2xd57 <span class="built_in">date</span>      <span class="comment">#对pod中的容器执行命令</span></span><br><span class="line"> </span><br><span class="line">kubectl delete pod name <span class="comment">#删除某个POD</span></span><br><span class="line">kubectl delete deployment kubernetes-dashboard --namespace=kubernetes-dashboard <span class="comment">#删除</span></span><br><span class="line">kubectl delete secrets xxx-secrets   <span class="comment">#或者在页面删除</span></span><br></pre></td></tr></table></figure><h1 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h1><h2 id="网络插件flannel的配置文件"><a href="#网络插件flannel的配置文件" class="headerlink" title="网络插件flannel的配置文件"></a>网络插件flannel的配置文件</h2><p><code>/export/servers/kubernetes/flannel.yml</code></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Namespace</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kube-flannel</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">pod-security.kubernetes.io/enforce:</span> <span class="string">privileged</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">flannel</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">pods</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nodes</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nodes/status</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">patch</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">flannel</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">flannel</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">flannel</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-flannel</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">flannel</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-flannel</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kube-flannel-cfg</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-flannel</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">node</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">flannel</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">cni-conf.json:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">      &quot;name&quot;: &quot;cbr0&quot;,</span></span><br><span class="line"><span class="string">      &quot;cniVersion&quot;: &quot;0.3.1&quot;,</span></span><br><span class="line"><span class="string">      &quot;plugins&quot;: [</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">          &quot;type&quot;: &quot;flannel&quot;,</span></span><br><span class="line"><span class="string">          &quot;delegate&quot;: &#123;</span></span><br><span class="line"><span class="string">            &quot;hairpinMode&quot;: true,</span></span><br><span class="line"><span class="string">            &quot;isDefaultGateway&quot;: true</span></span><br><span class="line"><span class="string">          &#125;</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">          &quot;type&quot;: &quot;portmap&quot;,</span></span><br><span class="line"><span class="string">          &quot;capabilities&quot;: &#123;</span></span><br><span class="line"><span class="string">            &quot;portMappings&quot;: true</span></span><br><span class="line"><span class="string">          &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">      ]</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span>  <span class="attr">net-conf.json:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">      &quot;Network&quot;: &quot;10.244.0.0/16&quot;,</span></span><br><span class="line"><span class="string">      &quot;Backend&quot;: &#123;</span></span><br><span class="line"><span class="string">        &quot;Type&quot;: &quot;vxlan&quot;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kube-flannel-ds</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-flannel</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">node</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">flannel</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">flannel</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">tier:</span> <span class="string">node</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">flannel</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">affinity:</span></span><br><span class="line">        <span class="attr">nodeAffinity:</span></span><br><span class="line">          <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">            <span class="attr">nodeSelectorTerms:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">matchExpressions:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">kubernetes.io/os</span></span><br><span class="line">                <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">                <span class="attr">values:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">linux</span></span><br><span class="line">      <span class="attr">hostNetwork:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">priorityClassName:</span> <span class="string">system-node-critical</span></span><br><span class="line">      <span class="attr">tolerations:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">operator:</span> <span class="string">Exists</span></span><br><span class="line">        <span class="attr">effect:</span> <span class="string">NoSchedule</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">flannel</span></span><br><span class="line">      <span class="attr">initContainers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install-cni-plugin</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">docker.io/rancher/mirrored-flannelcni-flannel-cni-plugin:v1.1.0</span></span><br><span class="line">        <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">cp</span></span><br><span class="line">        <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">-f</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/flannel</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/opt/cni/bin/flannel</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cni-plugin</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/opt/cni/bin</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install-cni</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">docker.io/rancher/mirrored-flannelcni-flannel:v0.19.1</span></span><br><span class="line">        <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">cp</span></span><br><span class="line">        <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">-f</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/etc/kube-flannel/cni-conf.json</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/etc/cni/net.d/10-flannel.conflist</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cni</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/etc/cni/net.d</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">flannel-cfg</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/etc/kube-flannel/</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kube-flannel</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">docker.io/rancher/mirrored-flannelcni-flannel:v0.19.1</span></span><br><span class="line">        <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/opt/bin/flanneld</span></span><br><span class="line">        <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--ip-masq</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--kube-subnet-mgr</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;100m&quot;</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">&quot;50Mi&quot;</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;100m&quot;</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">&quot;50Mi&quot;</span></span><br><span class="line">        <span class="attr">securityContext:</span></span><br><span class="line">          <span class="attr">privileged:</span> <span class="literal">false</span></span><br><span class="line">          <span class="attr">capabilities:</span></span><br><span class="line">            <span class="attr">add:</span> [<span class="string">&quot;NET_ADMIN&quot;</span>, <span class="string">&quot;NET_RAW&quot;</span>]</span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_NAME</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_NAMESPACE</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">metadata.namespace</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">EVENT_QUEUE_DEPTH</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;5000&quot;</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">run</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/run/flannel</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">flannel-cfg</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/etc/kube-flannel/</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">xtables-lock</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/run/xtables.lock</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">run</span></span><br><span class="line">        <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/run/flannel</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cni-plugin</span></span><br><span class="line">        <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/opt/cni/bin</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cni</span></span><br><span class="line">        <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/etc/cni/net.d</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">flannel-cfg</span></span><br><span class="line">        <span class="attr">configMap:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">kube-flannel-cfg</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">xtables-lock</span></span><br><span class="line">        <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/run/xtables.lock</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">FileOrCreate</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h1 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h1><p><a href="https://juejin.cn/post/7161621568747995166">IoT运维 - 如何部署一套高可用K8S集群</a><br><a href="https://juejin.cn/post/7179072854397288509">手把手教你一套完善且高效的k8s离线部署方案</a><br><a href="https://github.com/flannel-io/flannel">Flannel-io Github repo</a><br><a href="https://github.com/easzlab/kubeasz">快速部署高可用k8s集群的工具kubeasz</a></p><blockquote><p>声明：本站所有文章均为原创或翻译，遵循<a href="https://creativecommons.org/licenses/by-nc-nd/4.0/deed.en">署名 - 非商业性使用 - 禁止演绎 4.0 国际许可协议</a>，如需转载请确保您对该协议有足够了解，并附上作者名 (Tsukasa) 及原文地址</p></blockquote>]]></content>
    
    
    <summary type="html">&lt;script src=&quot;&#92;assets&#92;js&#92;APlayer.min.js&quot;&gt; &lt;/script&gt;&lt;p&gt;Harbor + Docker搭建K8s集群&lt;/p&gt;</summary>
    
    
    
    <category term="环境配置" scheme="http://blog.tsukasa.moe/categories/%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/"/>
    
    
    <category term="Kubernetes" scheme="http://blog.tsukasa.moe/tags/Kubernetes/"/>
    
    <category term="Harbor" scheme="http://blog.tsukasa.moe/tags/Harbor/"/>
    
    <category term="Docker" scheme="http://blog.tsukasa.moe/tags/Docker/"/>
    
  </entry>
  
  <entry>
    <title>K8s集群搭建系列（二）：搭建ETCD多节点单实例集群</title>
    <link href="http://blog.tsukasa.moe/2023/08/02/Create-etcd-cluster-in-linux-system/"/>
    <id>http://blog.tsukasa.moe/2023/08/02/Create-etcd-cluster-in-linux-system/</id>
    <published>2023-08-02T06:26:45.000Z</published>
    <updated>2023-08-05T06:49:37.477Z</updated>
    
    <content type="html"><![CDATA[<!-- excerpt --><!-- toc --><p>ETCD是一个分布式键值存储组件，可以用于服务注册与发现。这篇文章主要记录下ETCD多节点单实例集群的搭建。etcd是服务端，etcdctl是客户端命令行。</p><h1 id="系统资源"><a href="#系统资源" class="headerlink" title="系统资源"></a>系统资源</h1><table><thead><tr><th style="text-align:left">IP</th><th style="text-align:left">角色</th><th style="text-align:left">主机名</th><th style="text-align:left">组件</th><th style="text-align:left">配置</th></tr></thead><tbody><tr><td style="text-align:left">192.168.2.183</td><td style="text-align:left">Windows10，个人PC</td><td style="text-align:left">Tsukasa</td><td style="text-align:left">VMWare</td><td style="text-align:left">-</td></tr><tr><td style="text-align:left">192.168.2.100</td><td style="text-align:left">deploy</td><td style="text-align:left">tsukasa</td><td style="text-align:left">ansible, docker, harbor</td><td style="text-align:left">4Cx2Gx20G</td></tr><tr><td style="text-align:left">192.168.2.100</td><td style="text-align:left">kubernetes</td><td style="text-align:left">k8s-master</td><td style="text-align:left">kubectl, kubelet, kubeadm, flnanel</td><td style="text-align:left">2Cx2Gx20G</td></tr><tr><td style="text-align:left">192.168.2.101</td><td style="text-align:left">kubernetes</td><td style="text-align:left">k8s-worker01</td><td style="text-align:left">kubectl</td><td style="text-align:left">2Cx1Gx20G</td></tr><tr><td style="text-align:left">192.168.2.102</td><td style="text-align:left">kubernetes</td><td style="text-align:left">k8s-worker02</td><td style="text-align:left">kubectl</td><td style="text-align:left">2Cx1Gx20G</td></tr><tr><td style="text-align:left">192.168.2.103</td><td style="text-align:left">etcd</td><td style="text-align:left">etcd01</td><td style="text-align:left">etcd</td><td style="text-align:left">2Cx1Gx20G</td></tr><tr><td style="text-align:left">192.168.2.104</td><td style="text-align:left">etcd</td><td style="text-align:left">etcd02</td><td style="text-align:left">etcd</td><td style="text-align:left">1Cx1Gx10G</td></tr><tr><td style="text-align:left">192.168.2.105</td><td style="text-align:left">etcd</td><td style="text-align:left">etcd03(leader)</td><td style="text-align:left">etcd</td><td style="text-align:left">1Cx1Gx10G</td></tr><tr><td style="text-align:left">192.168.2.106</td><td style="text-align:left">mysql</td><td style="text-align:left">mysql01</td><td style="text-align:left">mysql</td><td style="text-align:left">2Cx1Gx15G</td></tr><tr><td style="text-align:left">192.168.2.107</td><td style="text-align:left">mysql</td><td style="text-align:left">mysql02</td><td style="text-align:left">mysql</td><td style="text-align:left">2Cx1Gx15G</td></tr></tbody></table><h1 id="基础配置"><a href="#基础配置" class="headerlink" title="基础配置"></a>基础配置</h1><p>默认已经完成SSH免密登陆、时间同步等基础配置，如果未完成需要参考同系列之前的文章配置。</p><h2 id="关闭防火墙"><a href="#关闭防火墙" class="headerlink" title="关闭防火墙"></a>关闭防火墙</h2><p>deploy主机执行</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ansible etcd -m shell -a <span class="string">&quot;systemctl stop firewalld &amp;&amp; systemctl disable firewalld&quot;</span></span><br><span class="line">ansible etcd -m shell -a <span class="string">&quot;sed -i &#x27;s/^SELINUX=.*/SELINUX=disabled/g&#x27; /etc/selinux/config&quot;</span></span><br></pre></td></tr></table></figure><h1 id="生成证书信息"><a href="#生成证书信息" class="headerlink" title="生成证书信息"></a>生成证书信息</h1><p>deploy主机执行，后续通过ansible命令将生成好的证书信息发送到etcd节点。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64 -O /usr/bin/cfssl</span><br><span class="line">wget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64 -O /usr/bin/cfssljson</span><br><span class="line">wget https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64 -O /usr/bin/cfssl-certinfo </span><br><span class="line"><span class="built_in">chmod</span> +x /usr/bin/cfssl*</span><br></pre></td></tr></table></figure><h2 id="创建CA配置文件"><a href="#创建CA配置文件" class="headerlink" title="创建CA配置文件"></a>创建CA配置文件</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p /root/ssl</span><br><span class="line"><span class="built_in">cd</span> /root/ssl</span><br><span class="line"><span class="built_in">cat</span> &gt;ca-config.json &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  &quot;signing&quot;: &#123;</span></span><br><span class="line"><span class="string">    &quot;default&quot;: &#123;</span></span><br><span class="line"><span class="string">      &quot;expiry&quot;: &quot;876000h&quot;</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">    &quot;profiles&quot;: &#123;</span></span><br><span class="line"><span class="string">      &quot;etcd&quot;: &#123;</span></span><br><span class="line"><span class="string">        &quot;usages&quot;: [</span></span><br><span class="line"><span class="string">            &quot;signing&quot;,</span></span><br><span class="line"><span class="string">            &quot;key encipherment&quot;,</span></span><br><span class="line"><span class="string">            &quot;server auth&quot;,</span></span><br><span class="line"><span class="string">            &quot;client auth&quot;</span></span><br><span class="line"><span class="string">        ],</span></span><br><span class="line"><span class="string">        &quot;expiry&quot;: &quot;876000h&quot;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><h2 id="创建CA证书签名请求"><a href="#创建CA证书签名请求" class="headerlink" title="创建CA证书签名请求"></a>创建CA证书签名请求</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &gt;ca-csr.json &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  &quot;CN&quot;: &quot;etcd&quot;,</span></span><br><span class="line"><span class="string">  &quot;key&quot;: &#123;</span></span><br><span class="line"><span class="string">    &quot;algo&quot;: &quot;rsa&quot;,</span></span><br><span class="line"><span class="string">    &quot;size&quot;: 2048</span></span><br><span class="line"><span class="string">  &#125;,</span></span><br><span class="line"><span class="string">  &quot;names&quot;: [</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">      &quot;C&quot;: &quot;CN&quot;,</span></span><br><span class="line"><span class="string">      &quot;ST&quot;: &quot;beijing&quot;,</span></span><br><span class="line"><span class="string">      &quot;L&quot;: &quot;beijing&quot;,</span></span><br><span class="line"><span class="string">      &quot;O&quot;: &quot;jdt&quot;,</span></span><br><span class="line"><span class="string">      &quot;OU&quot;: &quot;iot&quot;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  ]</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><h2 id="生成CA证书和私钥"><a href="#生成CA证书和私钥" class="headerlink" title="生成CA证书和私钥"></a>生成CA证书和私钥</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert -initca ca-csr.json | cfssljson -bare ca</span><br></pre></td></tr></table></figure><h2 id="创建etcd的TLS认证证书"><a href="#创建etcd的TLS认证证书" class="headerlink" title="创建etcd的TLS认证证书"></a>创建etcd的TLS认证证书</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert -initca ca-csr.json | cfssljson -bare ca</span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &gt; etcd-csr.json &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  &quot;CN&quot;: &quot;etcd&quot;,</span></span><br><span class="line"><span class="string">  &quot;hosts&quot;: [</span></span><br><span class="line"><span class="string">    &quot;192.168.2.103&quot;, </span></span><br><span class="line"><span class="string">    &quot;192.168.2.104&quot;, </span></span><br><span class="line"><span class="string">    &quot;192.168.2.105&quot;,</span></span><br><span class="line"><span class="string">    &quot;192.168.2.100&quot;,</span></span><br><span class="line"><span class="string">    &quot;etcd01&quot;,</span></span><br><span class="line"><span class="string">    &quot;etcd02&quot;,</span></span><br><span class="line"><span class="string">    &quot;etcd03&quot;,</span></span><br><span class="line"><span class="string">    &quot;master&quot;</span></span><br><span class="line"><span class="string">  ],</span></span><br><span class="line"><span class="string">  &quot;key&quot;: &#123;</span></span><br><span class="line"><span class="string">    &quot;algo&quot;: &quot;rsa&quot;,</span></span><br><span class="line"><span class="string">    &quot;size&quot;: 2048</span></span><br><span class="line"><span class="string">  &#125;,</span></span><br><span class="line"><span class="string">  &quot;names&quot;: [</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">      &quot;C&quot;: &quot;CN&quot;,</span></span><br><span class="line"><span class="string">      &quot;ST&quot;: &quot;beijing&quot;,</span></span><br><span class="line"><span class="string">      &quot;L&quot;: &quot;beijing&quot;,</span></span><br><span class="line"><span class="string">      &quot;O&quot;: &quot;jdt&quot;,</span></span><br><span class="line"><span class="string">      &quot;OU&quot;: &quot;iot&quot;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  ]</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><h2 id="生成并分发etcd证书和私钥"><a href="#生成并分发etcd证书和私钥" class="headerlink" title="生成并分发etcd证书和私钥"></a>生成并分发etcd证书和私钥</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=etcd etcd-csr.json | cfssljson -bare etcd</span><br><span class="line">ansible  etcd -m copy -a <span class="string">&quot;src=/root/ssl/ dest=/export/Data/certs/&quot;</span></span><br></pre></td></tr></table></figure><h1 id="ETCD安装和配置"><a href="#ETCD安装和配置" class="headerlink" title="ETCD安装和配置"></a>ETCD安装和配置</h1><p>上面已经把etcd的证书和私钥分发到了各个etcd节点，下面进行etcd的安装和配置。</p><h2 id="下载并分发etcd"><a href="#下载并分发etcd" class="headerlink" title="下载并分发etcd"></a>下载并分发etcd</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建etcd数据目录</span></span><br><span class="line">ansible etcd -m shell -a <span class="string">&quot;mkdir -p /export/Data/etcd_data&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果下载速度很慢，可以通过用windows主机下载再上传至deploy主机</span></span><br><span class="line">wget https://github.com/etcd-io/etcd/releases/download/v3.5.1/etcd-v3.5.1-linux-amd64.tar.gz</span><br><span class="line">tar xf etcd-v3.5.1-linux-amd64.tar.gz  &amp;&amp; <span class="built_in">cd</span> etcd-v3.5.1-linux-amd64</span><br><span class="line">ansible etcd -m copy -a <span class="string">&quot;src=etcd  dest=/usr/bin/&quot;</span></span><br><span class="line">ansible etcd -m copy -a <span class="string">&quot;src=etcdutl  dest=/usr/bin/&quot;</span></span><br><span class="line">ansible etcd -m copy -a <span class="string">&quot;src=etcdctl  dest=/usr/bin/&quot;</span></span><br><span class="line">ansible etcd -m shell -a <span class="string">&quot;chmod +x /usr/bin/etcd*&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="配置etcd"><a href="#配置etcd" class="headerlink" title="配置etcd"></a>配置etcd</h2><p>创建etcd配置文件：<code>/export/upload/etcd_config.sh</code></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#PEER_NAME指定本节点的主机名称/域名，</span></span><br><span class="line"><span class="comment">#PRIVATE_IP指定本节点的IP(用于后面配置文件的生成)</span></span><br><span class="line"><span class="comment">#ETCD_CLUSTER群集列表，是所有节点信息（内容格式: 各节点名称=https://ip:端口  名称任意但要有标识性）</span></span><br><span class="line"><span class="comment">#ETCD_INITIAL_CLUSTER_TOKEN为该etcd集群Token,同一集群token一致</span></span><br><span class="line">interface_name=`<span class="built_in">cat</span> /proc/net/dev | sed -n <span class="string">&#x27;3,$p&#x27;</span> | awk -F <span class="string">&#x27;:&#x27;</span> &#123;<span class="string">&#x27;print $1&#x27;</span>&#125; | grep  -E <span class="string">&quot;^ &quot;</span> | grep -v lo | <span class="built_in">head</span> -n1`</span><br><span class="line">ipaddr=`ip a | grep <span class="variable">$interface_name</span>  | awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span> | awk -F<span class="string">&quot;/&quot;</span>  <span class="string">&#x27;&#123;print $1&#125;&#x27;</span> | awk -F<span class="string">&#x27;:&#x27;</span> <span class="string">&#x27;&#123;print $NF&#125;&#x27;</span>`</span><br><span class="line"><span class="built_in">export</span> PEER_NAME=`hostname`</span><br><span class="line"><span class="built_in">export</span> PRIVATE_IP=`<span class="built_in">echo</span> <span class="variable">$ipaddr</span> | <span class="built_in">tr</span> -d <span class="string">&#x27;\r&#x27;</span>`</span><br><span class="line"><span class="built_in">export</span> ETCD_CLUSTER=<span class="string">&quot;etcd01=https://192.168.2.103:2380,etcd02=https://192.168.2.104:2380,etcd03=https://192.168.2.105:2380&quot;</span></span><br><span class="line"><span class="built_in">export</span> ETCD_INITIAL_CLUSTER_TOKEN=<span class="string">&quot;etcd-cluster-1&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &gt; /etc/systemd/system/etcd.service  &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">[Unit]</span></span><br><span class="line"><span class="string">Description=etcd</span></span><br><span class="line"><span class="string">Documentation=https://github.com/coreos/etcd</span></span><br><span class="line"><span class="string">Conflicts=etcd.service</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Service]</span></span><br><span class="line"><span class="string">Type=notify</span></span><br><span class="line"><span class="string">Restart=always</span></span><br><span class="line"><span class="string">RestartSec=5s</span></span><br><span class="line"><span class="string">LimitNOFILE=65536</span></span><br><span class="line"><span class="string">TimeoutStartSec=0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">ExecStart=/usr/bin/etcd --name $&#123;PEER_NAME&#125; \</span></span><br><span class="line"><span class="string">    --data-dir /export/Data/etcd_data\</span></span><br><span class="line"><span class="string">    --listen-client-urls https://$&#123;PRIVATE_IP&#125;:2379 \</span></span><br><span class="line"><span class="string">    --advertise-client-urls https://$&#123;PRIVATE_IP&#125;:2379 \</span></span><br><span class="line"><span class="string">    --listen-peer-urls https://$&#123;PRIVATE_IP&#125;:2380 \</span></span><br><span class="line"><span class="string">    --initial-advertise-peer-urls https://$&#123;PRIVATE_IP&#125;:2380 \</span></span><br><span class="line"><span class="string">    --cert-file=/export/Data/certs/etcd.pem \</span></span><br><span class="line"><span class="string">    --key-file=/export/Data/certs/etcd-key.pem \</span></span><br><span class="line"><span class="string">    --client-cert-auth \</span></span><br><span class="line"><span class="string">    --trusted-ca-file=/export/Data/certs/ca.pem \</span></span><br><span class="line"><span class="string">    --peer-cert-file=/export/Data/certs/etcd.pem \</span></span><br><span class="line"><span class="string">    --peer-key-file=/export/Data/certs/etcd-key.pem \</span></span><br><span class="line"><span class="string">    --peer-client-cert-auth \</span></span><br><span class="line"><span class="string">    --peer-trusted-ca-file=/export/Data/certs/ca.pem \</span></span><br><span class="line"><span class="string">    --initial-cluster $&#123;ETCD_CLUSTER&#125; \</span></span><br><span class="line"><span class="string">    --initial-cluster-token etcd-cluster-1 \</span></span><br><span class="line"><span class="string">    --initial-cluster-state new</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Install]</span></span><br><span class="line"><span class="string">WantedBy=multi-user.target</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><p>分发etcd配置文件到各个etcd节点。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 分发etcd_config.sh配置脚本到etcd节点</span></span><br><span class="line">ansible etcd -m copy -a <span class="string">&quot;src=/export/upload/etcd_config.sh dest=/root/etcd_config.sh&quot;</span></span><br><span class="line">ansible etcd -m shell -a <span class="string">&quot;chmod u+x,g+x /root/etcd_config.sh&quot;</span></span><br><span class="line">ansible etcd -m shell -a <span class="string">&quot;sh /root/etcd_config.sh&quot;</span></span><br><span class="line"><span class="comment"># 重启etcd服务</span></span><br><span class="line">ansible etcd -m shell -a <span class="string">&quot;systemctl daemon-reload&quot;</span></span><br><span class="line">ansible etcd -m service -a <span class="string">&#x27;name=etcd  state=started&#x27;</span></span><br><span class="line">ansible etcd -m shell -a <span class="string">&quot;systemctl enable etcd&quot;</span> </span><br></pre></td></tr></table></figure><h2 id="etcd健康检查"><a href="#etcd健康检查" class="headerlink" title="etcd健康检查"></a>etcd健康检查</h2><p>创建etcd的健康检查脚本：<code>/export/upload/check_etcd.sh</code>，用于在各个etcd节点快速检查etcd集群健康状态。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">HOST1=192.168.2.103</span><br><span class="line">HOST2=192.168.2.104</span><br><span class="line">HOST3=192.168.2.105</span><br><span class="line">ENDPOINTS=<span class="variable">$HOST1</span>:2379,<span class="variable">$HOST2</span>:2379,<span class="variable">$HOST3</span>:2379</span><br><span class="line"><span class="comment">#因为开启了证书验证，因此执行命令需加上证书</span></span><br><span class="line">KEY=<span class="string">&quot;--cacert=/export/Data/certs/ca.pem \</span></span><br><span class="line"><span class="string">--cert=/export/Data/certs/etcd.pem \</span></span><br><span class="line"><span class="string">--key=/export/Data/certs/etcd-key.pem&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#etcd集群健康信息</span></span><br><span class="line">etcdctl --endpoints=<span class="variable">$ENDPOINTS</span> <span class="variable">$KEY</span> endpoint health</span><br><span class="line"></span><br><span class="line"><span class="comment">#etcd集群状态信息</span></span><br><span class="line">etcdctl --endpoints=<span class="variable">$ENDPOINTS</span> <span class="variable">$KEY</span> --write-out=table endpoint status</span><br><span class="line"></span><br><span class="line"><span class="comment">#etcd集群成员信息</span></span><br><span class="line">etcdctl --endpoints=<span class="variable">$ENDPOINTS</span> <span class="variable">$KEY</span> member list -w table</span><br><span class="line"></span><br><span class="line">etcdctl --endpoints 192.168.2.103:2379,192.168.2.104:2379,192.168.2.105:2379 --cacert=/export/Data/certs/ca.pem --cert=/export/Data/certs/etcd.pem --key=/export/Data/certs/etcd-key.pem endpoint health</span><br></pre></td></tr></table></figure><p>分发到各个etcd节点：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> u+x,g+x check_etcd.sh</span><br><span class="line"></span><br><span class="line">ansible etcd -m copy -a <span class="string">&quot;src=/export/upload/check_etcd.sh dest=/root/check_etcd.sh&quot;</span></span><br><span class="line">ansible etcd -m shell -a <span class="string">&quot;chmod u+x,g+x /root/check_etcd.sh&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ETCDCTL_API=3 etcdctl --cacert=/export/Data/certs/ca.pem --cert=/export/Data/certs/etcd.pem --key=/export/Data/certs/etcd-key.pem --endpoints=<span class="string">&quot;https://192.168.2.103:2379,https://192.168.2.104:2379,https://192.168.2.105:2379&quot;</span> endpoint health --write-out=table</span><br><span class="line"></span><br><span class="line">etcdctl --cacert=/export/Data/certs/ca.pem --cert=/export/Data/certs/etcd.pem --key=/export/Data/certs/etcd-key.pem --endpoints=<span class="string">&quot;https://192.168.2.103:2379,https://192.168.2.104:2379,https://192.168.2.105:2379&quot;</span> endpoint health --write-out=table</span><br></pre></td></tr></table></figure><p>执行etcd健康检查脚本，即可查询到etcd集群状态。下图显示etcd集群健康检查正常。</p><p><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202307310147910.png" alt=""></p><h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p><a href="https://github.com/etcd-io/etcd">etcd github repo</a></p><blockquote><p>声明：本站所有文章均为原创或翻译，遵循<a href="https://creativecommons.org/licenses/by-nc-nd/4.0/deed.en">署名 - 非商业性使用 - 禁止演绎 4.0 国际许可协议</a>，如需转载请确保您对该协议有足够了解，并附上作者名 (Tsukasa) 及原文地址</p></blockquote>]]></content>
    
    
    <summary type="html">&lt;script src=&quot;&#92;assets&#92;js&#92;APlayer.min.js&quot;&gt; &lt;/script&gt;&lt;p&gt;ETCD是一个分布式键值存储组件，可以用于服务注册与发现。这篇文章主要记录下ETCD多节点单实例集群的搭建。&lt;/p&gt;</summary>
    
    
    
    <category term="环境配置" scheme="http://blog.tsukasa.moe/categories/%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/"/>
    
    
    <category term="etcd" scheme="http://blog.tsukasa.moe/tags/etcd/"/>
    
    <category term="分布式" scheme="http://blog.tsukasa.moe/tags/%E5%88%86%E5%B8%83%E5%BC%8F/"/>
    
  </entry>
  
  <entry>
    <title>K8s集群搭建系列（一）：Windows下使用VMWare搭建linux集群和基础配置</title>
    <link href="http://blog.tsukasa.moe/2023/07/27/Create-Virtual-Machine-for-linux-cluster/"/>
    <id>http://blog.tsukasa.moe/2023/07/27/Create-Virtual-Machine-for-linux-cluster/</id>
    <published>2023-07-27T14:55:34.000Z</published>
    <updated>2023-08-02T18:53:19.805Z</updated>
    
    <content type="html"><![CDATA[<!-- excerpt --><!-- toc --><p>Windows可以使用VMWare搭建linux集群，用于日常学习、工作开发测试。自身电脑配置较好的情况下，可以节省购买云服务器的开销。</p><h1 id="系统资源"><a href="#系统资源" class="headerlink" title="系统资源"></a>系统资源</h1><p>下面是我根据集群最少节点要求，自身电脑配置来规划的集群信息。</p><p>kubernetes集群：最少3台，1 master，2 worker<br>etcd集群：最少3台，1 master, 2 node<br>mysql主从同步集群：最少2台，1 master，1 slave</p><table><thead><tr><th style="text-align:left">IP</th><th style="text-align:left">角色</th><th style="text-align:left">主机名</th><th style="text-align:left">组件</th><th style="text-align:left">配置</th></tr></thead><tbody><tr><td style="text-align:left">192.168.2.183</td><td style="text-align:left">Windows10，个人PC</td><td style="text-align:left">Tsukasa</td><td style="text-align:left">VMWare</td><td style="text-align:left">-</td></tr><tr><td style="text-align:left">192.168.2.100</td><td style="text-align:left">deploy</td><td style="text-align:left">tsukasa</td><td style="text-align:left">ansible, docker, harbor</td><td style="text-align:left">4Cx2Gx20G</td></tr><tr><td style="text-align:left">192.168.2.100</td><td style="text-align:left">kubernetes</td><td style="text-align:left">k8s-master</td><td style="text-align:left">kubectl, kubelet, kubeadm, flnanel</td><td style="text-align:left">2Cx2Gx20G</td></tr><tr><td style="text-align:left">192.168.2.101</td><td style="text-align:left">kubernetes</td><td style="text-align:left">k8s-worker01</td><td style="text-align:left">kubectl</td><td style="text-align:left">2Cx1Gx20G</td></tr><tr><td style="text-align:left">192.168.2.102</td><td style="text-align:left">kubernetes</td><td style="text-align:left">k8s-worker02</td><td style="text-align:left">kubectl</td><td style="text-align:left">2Cx1Gx20G</td></tr><tr><td style="text-align:left">192.168.2.103</td><td style="text-align:left">etcd</td><td style="text-align:left">etcd01</td><td style="text-align:left">etcd</td><td style="text-align:left">2Cx1Gx20G</td></tr><tr><td style="text-align:left">192.168.2.104</td><td style="text-align:left">etcd</td><td style="text-align:left">etcd02</td><td style="text-align:left">etcd</td><td style="text-align:left">1Cx1Gx10G</td></tr><tr><td style="text-align:left">192.168.2.105</td><td style="text-align:left">etcd</td><td style="text-align:left">etcd03(leader)</td><td style="text-align:left">etcd</td><td style="text-align:left">1Cx1Gx10G</td></tr><tr><td style="text-align:left">192.168.2.106</td><td style="text-align:left">mysql</td><td style="text-align:left">mysql01</td><td style="text-align:left">mysql</td><td style="text-align:left">2Cx1Gx15G</td></tr><tr><td style="text-align:left">192.168.2.107</td><td style="text-align:left">mysql</td><td style="text-align:left">mysql02</td><td style="text-align:left">mysql</td><td style="text-align:left">2Cx1Gx15G</td></tr></tbody></table><p>System：Centos 7，64位<br>User：root/tsukasa</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[tsukasa@tsukasa ~]$ cat /proc/version</span><br><span class="line">Linux version 3.10.0-693.el7.x86_64 (builder@kbuilder.dev.centos.org) (gcc version 4.8.5 20150623 (Red Hat 4.8.5-16) (GCC) ) #1 SMP Tue Aug 22 21:09:27 UTC 2017</span><br></pre></td></tr></table></figure><h1 id="创建虚拟主机"><a href="#创建虚拟主机" class="headerlink" title="创建虚拟主机"></a>创建虚拟主机</h1><p>网络上创建虚拟主机的教程很多，为了方便，网络设置通过桥接模式上网，下面上面一章节的系统资源创建主机。</p><p>k8s-master主机配置示例：</p><p><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202307272252370.png" alt=""></p><p>安装过程中，可以在下面图形化界面进行网络配置，也可以参照下一章节进行网络配置。</p><p><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202307291540000.png" alt=""></p><h1 id="网络配置"><a href="#网络配置" class="headerlink" title="网络配置"></a>网络配置</h1><p>通过桥接模式上网，下面配置在所有节点执行。</p><h2 id="1、修改hostname"><a href="#1、修改hostname" class="headerlink" title="1、修改hostname"></a>1、修改hostname</h2><p>如果前期设置hostname不符合预期，可以执行下面命令，或者修改<code>/etc/hostname</code>文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hostnamectl set-hostname &lt;hostname&gt;</span><br></pre></td></tr></table></figure><h2 id="2、修改虚拟网卡置"><a href="#2、修改虚拟网卡置" class="headerlink" title="2、修改虚拟网卡置"></a>2、修改虚拟网卡置</h2><p>（1）执行命令<code>ifconfig</code>，查看虚拟网卡位<code>ens33</code>，修改网卡配置命令：<code>vim /etc/sysconfig/network-scripts/ifcfg-ens33</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">TYPE=Ethernet</span><br><span class="line">PROXY_METHOD=none</span><br><span class="line">BROWSER_ONLY=no</span><br><span class="line">BOOTPROTO=static</span><br><span class="line">DEFROUTE=yes</span><br><span class="line">IPV4_FAILURE_FATAL=no</span><br><span class="line">IPV6INIT=yes</span><br><span class="line">IPV6_AUTOCONF=yes</span><br><span class="line">IPV6_DEFROUTE=yes</span><br><span class="line">IPV6_FAILURE_FATAL=no</span><br><span class="line">IPV6_ADDR_GEN_MODE=stable-privacy</span><br><span class="line">NAME=ens33</span><br><span class="line">UUID=a4214b82-9e0e-4c27-b499-9890e5068306</span><br><span class="line">DEVICE=ens33</span><br><span class="line">ONBOOT=yes</span><br><span class="line">IPV6_PRIVACY=no</span><br><span class="line">IPADDR=192.168.2.100</span><br><span class="line">PREFIX=24</span><br><span class="line">GATEWAY=192.168.2.1</span><br><span class="line">DNS1=223.5.5.5</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>重要参数</p><ul><li><strong>BOOTPROTO</strong>：默认是dhcp，动态分配ip地址，这里指定为static，后续ip则不会改变</li><li><strong>NAME, DEVICE</strong>: 与<code>ifconfig</code>命令中看到的网卡名称保持一致</li><li><strong>ONBOOT</strong>：yes表示开机自启</li><li><strong>IPADDR, NETMASK, GATEWAY, DNS1</strong>：根据自己的网络配置进行配置即可宿主机器（Windows）查询<code>ipconfig</code>，查到网关为192.168.2.1，子网掩码为255.255.255.0，个人PC地址为192.168.2.183。这里我们手动给k8s-master主机分配IP为192.168.2.100，不与当前局域网下其他ip冲突即可。DNS服务器选择阿里云的公共免费DNS -&gt; 223.5.5.5或者223.6.6.6</li></ul><p>（2）修改完成后，重启网络服务</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart network.service</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>如果配置成功</p><ul><li>执行<code>ping baidu.com</code>可以正常联网。</li><li>局域网主机之间可以互相ping通，个人PC可以通过<code>ping 192.168.2.100</code></li></ul><h1 id="SSH免密登录"><a href="#SSH免密登录" class="headerlink" title="SSH免密登录"></a>SSH免密登录</h1><p>按照系统资源创建好所有主机并完成网络配置后，可以配置下deploy跳板机SSH免密登陆集群中的其他机器，方便后续通过ansible进行批量操作。</p><h2 id="基本原理"><a href="#基本原理" class="headerlink" title="基本原理"></a>基本原理</h2><p>SSH通过RSA非对称密钥算法实现身份验证，客户端A把公钥发给服务端B，服务端用客户端的公钥加密一段随机字符串返回给客户端，客户端用私钥解密再次发给服务端，服务端验证通过，在<code>~/.ssh/authorized_keys</code>中追加客户端公钥后，后续可以免密登陆。</p><h2 id="操作步骤"><a href="#操作步骤" class="headerlink" title="操作步骤"></a>操作步骤</h2><h3 id="服务端配置允许公钥授权登陆"><a href="#服务端配置允许公钥授权登陆" class="headerlink" title="服务端配置允许公钥授权登陆"></a>服务端配置允许公钥授权登陆</h3><p>所有主机需要修改下面配置，允许公钥授权登陆。</p><p><code>vi /etc/ssh/sshd_config</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">RSAAuthentication <span class="built_in">yes</span></span><br><span class="line">PubkeyAuthentication <span class="built_in">yes</span></span><br><span class="line">AuthorizedKeysFile  .ssh/authorized_keys</span><br></pre></td></tr></table></figure><p>重启sshd服务</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart sshd</span><br></pre></td></tr></table></figure><h3 id="客户端生成RSA公私钥对"><a href="#客户端生成RSA公私钥对" class="headerlink" title="客户端生成RSA公私钥对"></a>客户端生成RSA公私钥对</h3><p>客户端切换到需要免密登陆的用户，执行下面命令生成RSA公私钥对，系统自动生成~/.ssh目录和公私钥。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在deploy主机下执行</span></span><br><span class="line">ssh-keygen -t rsa</span><br><span class="line"></span><br><span class="line">[root@tsukasa ~]<span class="comment"># ll ~/.ssh</span></span><br><span class="line">total 12</span><br><span class="line">-rw-------. 1 root root 1675 Jul 29 01:26 id_rsa</span><br><span class="line">-rw-r--r--. 1 root root  394 Jul 29 01:26 id_rsa.pub</span><br><span class="line">-rw-r--r--. 1 root root 1400 Jul 29 01:30 known_hosts</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="SSH免密配置"><a href="#SSH免密配置" class="headerlink" title="SSH免密配置"></a>SSH免密配置</h3><p><strong>方法一：ssh-copy-id（推荐）</strong></p><p>单台服务器配置免密登陆，后续可以通过ssh user@host直接登陆。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-copy-id -i ~/.ssh/id_rsa.pub user@host</span><br></pre></td></tr></table></figure><p>通常linux集群中会根据业务分配一个业务用户，后续跳板机可以通过<code>ssh &lt;ip&gt;</code>更简洁的方式登陆。我所有主机的业务用户都为tsukasa</p><p>因为集群中的机器很多，可以通过循环的方式，批量授权。具体步骤：<br>确认所有服务器设置好允许通过公钥授权登陆后，登陆到deploy主机，切换到想要免密登陆的用户如tsukasa，执行下列命令完成批量授权。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">for xIp in 192.168.2.&#123;100..107&#125;; do  ssh-copy-id  -i ~/.ssh/id_rsa.pub $xIp; done</span><br></pre></td></tr></table></figure><p><strong>方法二：手动在服务端的authorized_keys文件追加客户端公钥</strong></p><p>这种方法需要在每一台服务器上执行，追加完成后，在deploy主机中分别验证：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -v user@host</span><br></pre></td></tr></table></figure><h3 id="MobaXterm或shell客户端分组维护服务器信息"><a href="#MobaXterm或shell客户端分组维护服务器信息" class="headerlink" title="MobaXterm或shell客户端分组维护服务器信息"></a>MobaXterm或shell客户端分组维护服务器信息</h3><p><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202308021818041.png" alt=""></p><h2 id="可能遇到的问题"><a href="#可能遇到的问题" class="headerlink" title="可能遇到的问题"></a>可能遇到的问题</h2><h3 id="ssh目录和authorized-keys文件的权限问题"><a href="#ssh目录和authorized-keys文件的权限问题" class="headerlink" title="~/.ssh目录和authorized_keys文件的权限问题"></a>~/.ssh目录和authorized_keys文件的权限问题</h3><p>Linux出于安全的考虑，~/.ssh目录目录权限和authorized_keys文件权限不能过大，手动创建场景要修改访问权限：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> 700 ~/.ssh</span><br><span class="line"><span class="built_in">chmod</span> 600 ~/.ssh/authorized_keys</span><br></pre></td></tr></table></figure><h3 id="SSH服务端可能配置了不允许root用户登录"><a href="#SSH服务端可能配置了不允许root用户登录" class="headerlink" title="SSH服务端可能配置了不允许root用户登录"></a>SSH服务端可能配置了不允许root用户登录</h3><p>修改<code>/etc/ssh/sshd_config</code>，将<code>PermitRootLogin no</code>改为<code>PermitRootLogin yes</code></p><h3 id="Linux创建用户设置密码提示：BAD-PASSWORD-The-password-is-shorter-than-8-characters"><a href="#Linux创建用户设置密码提示：BAD-PASSWORD-The-password-is-shorter-than-8-characters" class="headerlink" title="Linux创建用户设置密码提示：BAD PASSWORD: The password is shorter than 8 characters"></a>Linux创建用户设置密码提示：BAD PASSWORD: The password is shorter than 8 characters</h3><p>linux在系统初始化的时候可以强制创建密码少于8个字符的用户，初始化成功通过命令行终端创建会失败，提示BAD PASSWORD: The password is shorter than 8 characters</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">groupadd tsukasa</span><br><span class="line">useradd tsukasa -g tsukasa</span><br><span class="line">passwd</span><br></pre></td></tr></table></figure><p>通常地，在生产环境我们不应该设置过于简单的密码，因为是个人开发环境，没有必要设置那么复杂。此时，可以这样进行密码设置：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> 密码 |passwd --stdin 用户名</span><br></pre></td></tr></table></figure><h2 id="ansible工具"><a href="#ansible工具" class="headerlink" title="ansible工具"></a>ansible工具</h2><p>为了后续操作在各个服务器主机批量执行，减少重复工作，选择基于SSH协议传输数据的ansible工具。</p><p>因为所有操作在跳板机进行，ansible在deploy主机安装即可。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">yum -y install https://releases.ansible.com/ansible/rpm/release/epel-7-x86_64/ansible-2.9.27-1.el7.ans.noarch.rpm</span><br><span class="line"></span><br><span class="line">[root@tsukasa ~]<span class="comment"># ansible --version</span></span><br><span class="line">ansible 2.9.27</span><br><span class="line">  config file = /etc/ansible/ansible.cfg</span><br><span class="line">  configured module search path = [u<span class="string">&#x27;/root/.ansible/plugins/modules&#x27;</span>, u<span class="string">&#x27;/usr/share/ansible/plugins/modules&#x27;</span>]</span><br><span class="line">  ansible python module location = /usr/lib/python2.7/site-packages/ansible</span><br><span class="line">  executable location = /usr/bin/ansible</span><br><span class="line">  python version = 2.7.5 (default, Aug  4 2017, 00:39:18) [GCC 4.8.5 20150623 (Red Hat 4.8.5-16)]</span><br></pre></td></tr></table></figure><h3 id="设备管理主机列表ansible配置"><a href="#设备管理主机列表ansible配置" class="headerlink" title="设备管理主机列表ansible配置"></a>设备管理主机列表ansible配置</h3><p>在<code>/etc/ansible/hosts</code>文件中配置集群分组信息。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[master]</span><br><span class="line">192.168.2.100    node_name=k8s-master</span><br><span class="line"></span><br><span class="line">[worker]</span><br><span class="line">192.168.2.101    node_name=k8s-worker01</span><br><span class="line">192.168.2.102    node_name=k8s-worker02</span><br><span class="line"></span><br><span class="line">[etcd]</span><br><span class="line">192.168.2.103    etcd_name=etcd01</span><br><span class="line">192.168.2.104    etcd_name=etcd02</span><br><span class="line">192.168.2.105    etcd_name=etcd03</span><br><span class="line"></span><br><span class="line">[k8s:children]</span><br><span class="line">master</span><br><span class="line">worker</span><br><span class="line"></span><br><span class="line">[mysql]</span><br><span class="line">192.168.2.106</span><br><span class="line">192.168.2.107</span><br><span class="line"></span><br><span class="line">[elb]</span><br><span class="line">192.168.2.108</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="禁用主机检查"><a href="#禁用主机检查" class="headerlink" title="禁用主机检查"></a>禁用主机检查</h3><p><code>vi /etc/ansible/ansible.cfg</code><br></br></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">uncomment this to <span class="built_in">disable</span> SSH key host checking</span></span><br><span class="line">host_key_checking = False</span><br></pre></td></tr></table></figure><h3 id="配置时间同步"><a href="#配置时间同步" class="headerlink" title="配置时间同步"></a>配置时间同步</h3><p>搭建集群通常要求集群节点必须精确一致，因此所有机器都需要配置时间同步，在deploy主机执行ansible命令</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ansible all -m <span class="built_in">command</span> -a <span class="string">&quot;yum install ntpdate -y&quot;</span></span><br><span class="line">ansible all -m <span class="built_in">command</span> -a <span class="string">&quot;ntpdate ntp.aliyun.com&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 将时间同步加入linux定时任务，每30分钟执行一次</span></span><br><span class="line">ansible all -m cron -a <span class="string">&#x27;minute=*/30 job=&quot;/usr/sbin/ntpdate ntp.aliyun.com&quot; name=&quot;time sync&quot;&#x27;</span></span><br><span class="line"><span class="comment"># 删除任务：ansible elb -m cron -a &#x27;name=&quot;time sync&quot; state=absent&#x27;</span></span><br></pre></td></tr></table></figure><h1 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h1><p><a href="http://ip.yqie.com/ziwangyanma.aspx">在线计算子网掩码</a></p><blockquote><p>声明：本站所有文章均为原创或翻译，遵循<a href="https://creativecommons.org/licenses/by-nc-nd/4.0/deed.en">署名 - 非商业性使用 - 禁止演绎 4.0 国际许可协议</a>，如需转载请确保您对该协议有足够了解，并附上作者名 (Tsukasa) 及原文地址</p></blockquote>]]></content>
    
    
    <summary type="html">&lt;script src=&quot;&#92;assets&#92;js&#92;APlayer.min.js&quot;&gt; &lt;/script&gt;&lt;p&gt;Windows可以使用VMWare搭建linux集群，用于日常学习、工作开发测试。自身电脑配置较好的情况下，可以节省购买云服务器的开销。&lt;/p&gt;</summary>
    
    
    
    <category term="环境配置" scheme="http://blog.tsukasa.moe/categories/%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/"/>
    
    
    <category term="VMWare" scheme="http://blog.tsukasa.moe/tags/VMWare/"/>
    
    <category term="SSH" scheme="http://blog.tsukasa.moe/tags/SSH/"/>
    
    <category term="虚拟机" scheme="http://blog.tsukasa.moe/tags/%E8%99%9A%E6%8B%9F%E6%9C%BA/"/>
    
  </entry>
  
  <entry>
    <title>Maven配置文件详解和使用</title>
    <link href="http://blog.tsukasa.moe/2023/07/25/Maven-configuration-guide-01/"/>
    <id>http://blog.tsukasa.moe/2023/07/25/Maven-configuration-guide-01/</id>
    <published>2023-07-25T15:59:36.000Z</published>
    <updated>2023-07-27T17:45:05.924Z</updated>
    
    <content type="html"><![CDATA[<!-- excerpt --><p>本文详细分析了Maven的全局/用户级配置文件settings.xml和项目级配置文件pom.xml，便于查阅。</p><!-- toc --><h1 id="一、工作原理"><a href="#一、工作原理" class="headerlink" title="一、工作原理"></a>一、工作原理</h1><p>项目根据Maven配置，通常先从本地仓库去拉取jar包，如果没有则取远程仓库拉取，这个远程仓库可以是私服，也可以是中央仓库或者镜像仓库。</p><h1 id="二、仓库管理"><a href="#二、仓库管理" class="headerlink" title="二、仓库管理"></a>二、仓库管理</h1><p>Maven分为本地仓库和远程仓库，本地仓库即<code>&lt;localRepository&gt;</code>标签配置的路径。<br>远程仓库分为中央仓库、私服、其他公共库。</p><p>Maven仓库的关系：</p><p><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202307260017629.png" alt=""></p><p>由于墙的存在，国内访问国外中央仓库不顺利，Maven拉取Jar包时会很慢甚至无法拉取，因此需要配置下国内的中央镜像仓库。镜像仓库在Maven配置文件settings.xml下进行配置。</p><p><strong>镜像仓库</strong>：将国外的中心仓库复制一份到国内，提升访问速度。</p><p><strong>私服</strong>：基于系统保密性的原因，搭建的内部远程仓库，存储一些公司内部不希望被公开的依赖服务，也可以避免因外部中央仓库网络的访问不顺畅导致的各种问题。</p><h1 id="三、Maven配置文件"><a href="#三、Maven配置文件" class="headerlink" title="三、Maven配置文件"></a>三、Maven配置文件</h1><p>Maven配置文件有三种：</p><ul><li>全局配置文件：<code>%MAVEN_HOME%\conf\settings.xml</code></li><li>用户配置文件：<code>C:\Users\用户名\.m2\settings.xml</code></li><li>项目配置文件：项目下的<code>pom.xml</code></li></ul><p>配置优先级：项目pom.xml &gt; 本地settings &gt; 全局settings，如果配置文件同时存在，会进行合并，有重复的配置时，优先级高的配置会覆盖优先级低的配置。</p><h1 id="四、Settings配置详解"><a href="#四、Settings配置详解" class="headerlink" title="四、Settings配置详解"></a>四、Settings配置详解</h1><p>首先，可以从Maven安装目录的conf下查看配置文件settings.xml，示例如下（注意仅展示结构，要经过定制才可使用）：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">settings</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/SETTINGS/1.2.0&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/SETTINGS/1.2.0 https://maven.apache.org/xsd/settings-1.2.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">localRepository</span>&gt;</span>/path/to/local/repo<span class="tag">&lt;/<span class="name">localRepository</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">interactiveMode</span>&gt;</span>true<span class="tag">&lt;/<span class="name">interactiveMode</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">offline</span>&gt;</span>false<span class="tag">&lt;/<span class="name">offline</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">pluginGroups</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">pluginGroup</span>&gt;</span>com.your.plugins<span class="tag">&lt;/<span class="name">pluginGroup</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">pluginGroups</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">servers</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">server</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>deploymentRepo<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">username</span>&gt;</span>repouser<span class="tag">&lt;/<span class="name">username</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">password</span>&gt;</span>repopwd<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">server</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- Another sample, using keys to authenticate. --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">server</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>siteServer<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">privateKey</span>&gt;</span>/path/to/private/key<span class="tag">&lt;/<span class="name">privateKey</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">passphrase</span>&gt;</span>optional; leave empty if not used.<span class="tag">&lt;/<span class="name">passphrase</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">server</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servers</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">proxies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">proxy</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>optional<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">active</span>&gt;</span>true<span class="tag">&lt;/<span class="name">active</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">protocol</span>&gt;</span>http<span class="tag">&lt;/<span class="name">protocol</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">username</span>&gt;</span>proxyuser<span class="tag">&lt;/<span class="name">username</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">password</span>&gt;</span>proxypass<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">host</span>&gt;</span>proxy.host.net<span class="tag">&lt;/<span class="name">host</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">port</span>&gt;</span>80<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">nonProxyHosts</span>&gt;</span>local.net|some.host.com<span class="tag">&lt;/<span class="name">nonProxyHosts</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">proxy</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">proxies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">mirrors</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>maven-default-http-blocker<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>external:http:*<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>Pseudo repository to mirror external repositories initially using HTTP.<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://0.0.0.0/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">blocked</span>&gt;</span>true<span class="tag">&lt;/<span class="name">blocked</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mirrors</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">profiles</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">profile</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>jdk-1.4<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">activation</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">jdk</span>&gt;</span>1.4<span class="tag">&lt;/<span class="name">jdk</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">activation</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">repositories</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">id</span>&gt;</span>jdk14<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">name</span>&gt;</span>Repository for JDK 1.4 builds<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://www.myhost.com/maven/jdk14<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">layout</span>&gt;</span>default<span class="tag">&lt;/<span class="name">layout</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">snapshotPolicy</span>&gt;</span>always<span class="tag">&lt;/<span class="name">snapshotPolicy</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">profile</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- Another sample --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">profile</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>env-dev<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">activation</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">name</span>&gt;</span>target-env<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">value</span>&gt;</span>dev<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">activation</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">tomcatPath</span>&gt;</span>/path/to/tomcat/instance<span class="tag">&lt;/<span class="name">tomcatPath</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">profile</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">profiles</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">activeProfiles</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">activeProfile</span>&gt;</span>alwaysActiveProfile<span class="tag">&lt;/<span class="name">activeProfile</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">activeProfile</span>&gt;</span>anotherAlwaysActiveProfile<span class="tag">&lt;/<span class="name">activeProfile</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">activeProfiles</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">settings</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="1、localRepository"><a href="#1、localRepository" class="headerlink" title="1、localRepository"></a>1、localRepository</h2><p>配置本地仓库位置，默认位置为<code>$&#123;user.home&#125;/.m2/repository</code>，可以配置为</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">localRepository</span>&gt;</span>D:\Workslace\Maven\maven-repository<span class="tag">&lt;/<span class="name">localRepository</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="2、interactiveMode"><a href="#2、interactiveMode" class="headerlink" title="2、interactiveMode"></a>2、interactiveMode</h2><p>Maven是否需要和用户交互以获得输入，默认为true</p><h2 id="3、offline"><a href="#3、offline" class="headerlink" title="3、offline"></a>3、offline</h2><p>用来标识是否以离线模式运营Maven。当系统不能联网时，可以通过该配置来离线运行。</p><h2 id="4、pluginGroups"><a href="#4、pluginGroups" class="headerlink" title="4、pluginGroups"></a>4、pluginGroups</h2><p>pluginGroups当插件的组织id(groupId)没有显示提供时，供搜寻插件组织Id的列表。</p><h2 id="5、servers"><a href="#5、servers" class="headerlink" title="5、servers"></a>5、servers</h2><p>访问私服时，某些私服需要配置认证信息，在这里填写。之所以servers配置不写在pom.xml，是因为pom.xml会随着代码上传代码仓库，而settings.xml存储在本地，相对安全。因此，通常在settings.xml中配置servers</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">servers</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">server</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--这是server的id（注意不是用户登陆的id），该id与distributionManagement中repository元素的id相匹配。 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>server001<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--鉴权用户名。 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">username</span>&gt;</span>my_login<span class="tag">&lt;/<span class="name">username</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--鉴权密码。 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">password</span>&gt;</span>my_password<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--鉴权时使用的私钥位置。和前两个元素类似，私钥位置和私钥密码指定了一个私钥的路径（默认是$&#123;user.home&#125;/.ssh/id_dsa）以及如果需要的话，一个密语。将来passphrase和password元素可能会被提取到外部，但目前它们必须在settings.xml文件以纯文本的形式声明。 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">privateKey</span>&gt;</span>$&#123;usr.home&#125;/.ssh/id_dsa<span class="tag">&lt;/<span class="name">privateKey</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--鉴权时使用的私钥密码。 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">passphrase</span>&gt;</span>some_passphrase<span class="tag">&lt;/<span class="name">passphrase</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--文件被创建时的权限。如果在部署的时候会创建一个仓库文件或者目录，这时候就可以使用权限（permission）。 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filePermissions</span>&gt;</span>664<span class="tag">&lt;/<span class="name">filePermissions</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--目录被创建时的权限。 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">directoryPermissions</span>&gt;</span>775<span class="tag">&lt;/<span class="name">directoryPermissions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">server</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servers</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="6、proxies"><a href="#6、proxies" class="headerlink" title="6、proxies"></a>6、proxies</h2><p>用来配置代理。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">proxies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">proxy</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--代理id。用来区分不同的代理元素。 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>myproxy<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--该代理是否是激活的那个。true则激活代理。当我们声明了一组代理，而某个时候只需要激活一个代理的时候，该元素就可以派上用处。 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">active</span>&gt;</span>true<span class="tag">&lt;/<span class="name">active</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 格式：协议://主机名:端口 --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--代理的协议。 协议://主机名:端口 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">protocol</span>&gt;</span>http<span class="tag">&lt;/<span class="name">protocol</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--代理的主机名。 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">host</span>&gt;</span>proxy.somewhere.com<span class="tag">&lt;/<span class="name">host</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--代理的端口。 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">port</span>&gt;</span>8080<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--代理的用户名。用户名和密码表示代理服务器认证的登录名和密码。 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">username</span>&gt;</span>proxyuser<span class="tag">&lt;/<span class="name">username</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--代理的密码。用户名和密码表示代理服务器认证的登录名和密码。 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">password</span>&gt;</span>somepassword<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--不该被代理的主机名列表。该列表的分隔符由代理服务器指定；例子中使用了竖线分隔符，使用逗号分隔也很常见。 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">nonProxyHosts</span>&gt;</span>*.google.com|ibiblio.org<span class="tag">&lt;/<span class="name">nonProxyHosts</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">proxy</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">proxies</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="7、mirrors"><a href="#7、mirrors" class="headerlink" title="7、mirrors"></a>7、mirrors</h2><p>配置镜像仓库。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mirrors</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>alimaven<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>aliyun maven<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://maven.aliyun.com/repository/central<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>alimaven_public<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>aliyun maven public<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.aliyun.com/nexus/content/groups/public/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>*<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mirrors</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>当本地仓库没有需要的依赖时，根据<code>&lt;mirrorOf&gt;</code>匹配远程仓库请求，去对应的镜像仓库地址拉取依赖。</p><p>下面是一些常用的语法示例：</p><ul><li><code>&lt;mirrorOf&gt;*&lt;mirrorOf&gt;</code>：匹配所有远程仓库。</li><li><code>&lt;mirrorOf&gt;external:*&lt;mirrorOf&gt;</code>：匹配所有不在本机上的远程仓库。</li><li><code>&lt;mirrorOf&gt;repo1,repo2&lt;mirrorOf&gt;</code>：匹配仓库repo1和repo2，使用逗号分隔多个远程仓库。</li><li><code>&lt;mirrorOf&gt;*,!repo1&lt;mirrorOf&gt;</code>：匹配所有远程仓库，repo1除外，使用感叹号将仓库从匹配中排除。</li></ul><p><strong>注意</strong>：<br>镜像仓库完全屏蔽了被镜像仓库，当镜像仓库不稳定或者停止服务的时候，Maven仍将无法访问被镜像仓库，因而将无法下载jar包。</p><p>此外，maven读取mirror配置是从上往下读取的，因此谨慎配置<code>&lt;mirrorOf&gt;*&lt;mirrorOf&gt;</code>，因为如果第一个镜像仓库配置了如此标志，那么如果该仓库即使不存在对应依赖也不会向下游查询。</p><h2 id="8、profiles"><a href="#8、profiles" class="headerlink" title="8、profiles"></a>8、profiles</h2><p>根据环境参数来调整构建配置的列表。可以将settings.xml下的profile理解为pom.xml种profile的阉割版。<br>settings.xml中的profiles包含了id、activation、repositories、pluginRepositories和properties元素</p><p><strong>注意：</strong><br>如果一个settings.xml的profile被激活，那么它的值会覆盖任何其他定义在pom.xml种带有相同id的profile</p><p><strong>激活profile有三种方式</strong></p><ul><li>通过命令行编译构建时激活，最常用的方式。</li><li>通过activeProfiles直接激活，详细往下看。</li><li>通过activation激活，详细往下看。</li></ul><p><strong>通过命令行激活</strong></p><p>通常在pom.xml中定义不同环境的profile，在编译构建不同的包时，执行下面的命令即可激活对应的profile进行编译构建。</p><p>以开发环境为例：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">命令格式：mvn package -P [profile的ID]</span></span><br><span class="line">mvn package -P dev</span><br></pre></td></tr></table></figure><h3 id="repositories"><a href="#repositories" class="headerlink" title="repositories"></a>repositories</h3><p>定义了一组远程仓库的列表，当该属性对应的profile被激活时，会使用该远程仓库。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">repositories</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--包含需要连接到远程仓库的信息 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--远程仓库唯一标识 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>codehausSnapshots<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--远程仓库名称 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>Codehaus Snapshots<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--如何处理远程仓库里发布版本的下载 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">releases</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--true或者false表示该仓库是否为下载某种类型构件（发布版，快照版）开启。 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>false<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--该元素指定更新发生的频率。Maven会比较本地POM和远程POM的时间戳。这里的选项是：always（一直），daily（默认，每日），interval：X（这里X是以分钟为单位的时间间隔），或者never（从不）。 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">updatePolicy</span>&gt;</span>always<span class="tag">&lt;/<span class="name">updatePolicy</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--当Maven验证构件校验文件失败时该怎么做-ignore（忽略），fail（失败），或者warn（警告）。 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">checksumPolicy</span>&gt;</span>warn<span class="tag">&lt;/<span class="name">checksumPolicy</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">releases</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--如何处理远程仓库里快照版本的下载。有了releases和snapshots这两组配置，POM就可以在每个单独的仓库中，为每种类型的构件采取不同的策略。例如，可能有人会决定只为开发目的开启对快照版本下载的支持。参见repositories/repository/releases元素 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">enabled</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">updatePolicy</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">checksumPolicy</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--远程仓库URL，按protocol://hostname/path形式 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://snapshots.maven.codehaus.org/maven2<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--用于定位和排序构件的仓库布局类型-可以是default（默认）或者legacy（遗留）。 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">layout</span>&gt;</span>default<span class="tag">&lt;/<span class="name">layout</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="properties"><a href="#properties" class="headerlink" title="properties"></a>properties</h3><p>定义一组拓展属性，当对应的profile被激活时该属性才生效。<br>执行<code>mvn help:system</code>可以获取System Properties和Environment Variables，根据下面注释进行使用即可。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">  1. env.X: 在一个变量前加上&quot;env.&quot;的前缀，会返回一个shell环境变量。例如,&quot;env.PATH&quot;指代了$path环境变量（在Windows上是%PATH%）。</span></span><br><span class="line"><span class="comment">  2. project.x：指代了POM中对应的元素值。例如: &lt;project&gt;&lt;version&gt;1.0&lt;/version&gt;&lt;/project&gt;通过$&#123;project.version&#125;获得version的值。</span></span><br><span class="line"><span class="comment">  3. settings.x: 指代了settings.xml中对应元素的值。例如：&lt;settings&gt;&lt;offline&gt;false&lt;/offline&gt;&lt;/settings&gt;通过 $&#123;settings.offline&#125;获得offline的值。</span></span><br><span class="line"><span class="comment">  4. java System Properties: 所有可通过java.lang.System.getProperties()访问的属性都能在POM中使用该形式访问，例如 $&#123;java.home&#125;。可以实际运行获取查看</span></span><br><span class="line"><span class="comment">  5. x: 在&lt;properties/&gt;元素中，或者外部文件中设置，以$&#123;someVar&#125;的形式使用。</span></span><br><span class="line"><span class="comment"> --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">user.install</span>&gt;</span>$&#123;user.home&#125;/our-project<span class="tag">&lt;/<span class="name">user.install</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="id"><a href="#id" class="headerlink" title="id"></a>id</h3><p>全局唯一标识，如果一个settings.xml中的profile被激活，它的值会覆盖任何其它定义在pom.xml中带有相同id的profile。</p><h3 id="pluginRepositories"><a href="#pluginRepositories" class="headerlink" title="pluginRepositories"></a>pluginRepositories</h3><p>同repositories差不多，不过该标签定义的是插件的远程仓库。</p><h3 id="activation"><a href="#activation" class="headerlink" title="activation"></a>activation</h3><p>触发激活该profile的条件。注意在Maven 3.2.2之前，当满足一项指定条件时就会激活。从Maven 3.2.2开始，需要满足所有指定条件时才会激活。可以移步<a href="https://maven.apache.org/pom.html#Activation">官方文档</a>查阅。</p><blockquote><p>Before Maven 3.2.2 activation occurs when one or more of the specified criteria have been met. When the first positive result is encountered, processing stops and the profile is marked as active. Since Maven 3.2.2 activation occurs when all of the specified criteria have been met.</p></blockquote><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">activation</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--profile默认是否激活的标识 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">activeByDefault</span>&gt;</span>false<span class="tag">&lt;/<span class="name">activeByDefault</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--当匹配的jdk被检测到，profile被激活。例如，1.4激活JDK1.4，1.4.0_2，而!1.4激活所有版本不是以1.4开头的JDK。 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">jdk</span>&gt;</span>1.5<span class="tag">&lt;/<span class="name">jdk</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--当匹配的操作系统属性被检测到，profile被激活。os元素可以定义一些操作系统相关的属性。可以结合java.lang.System.getProperties()中的属性进行配置 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">os</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--激活profile的操作系统的名字 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>Windows XP<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--激活profile的操作系统所属家族(如 &#x27;windows&#x27;) --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">family</span>&gt;</span>Windows<span class="tag">&lt;/<span class="name">family</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--激活profile的操作系统体系结构 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">arch</span>&gt;</span>x86<span class="tag">&lt;/<span class="name">arch</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--激活profile的操作系统版本 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.2600<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">os</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--如果Maven检测到某一个属性（其值可以在POM中通过$&#123;name&#125;引用），其拥有对应的name = 值，Profile就会被激活。如果值字段是空的，那么存在属性名称字段就会激活profile，否则按区分大小写方式匹配属性值字段 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--激活profile的属性的名称 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>mavenVersion<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--激活profile的属性的值 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>2.0.3<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--提供一个文件名，通过检测该文件的存在或不存在来激活profile。missing检查文件是否存在，如果不存在则激活profile。另一方面，exists则会检查文件是否存在，如果存在则激活profile。 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">file</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--如果指定的文件存在，则激活profile。 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exists</span>&gt;</span>$&#123;basedir&#125;/file2.properties<span class="tag">&lt;/<span class="name">exists</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--如果指定的文件不存在，则激活profile。 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">missing</span>&gt;</span>$&#123;basedir&#125;/file1.properties<span class="tag">&lt;/<span class="name">missing</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">file</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">activation</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="9、activeProfiles"><a href="#9、activeProfiles" class="headerlink" title="9、activeProfiles"></a>9、activeProfiles</h2><p>指定激活的profile，不管profile的activation配置如何，都会激活对应的profile。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">activeProfiles</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 要激活的profile id --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">activeProfile</span>&gt;</span>test<span class="tag">&lt;/<span class="name">activeProfile</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">activeProfile</span>&gt;</span>dev<span class="tag">&lt;/<span class="name">activeProfile</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">activeProfiles</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="10、Settings-xml配置文件中mirrors和profile中repositories的关系"><a href="#10、Settings-xml配置文件中mirrors和profile中repositories的关系" class="headerlink" title="10、Settings.xml配置文件中mirrors和profile中repositories的关系"></a>10、Settings.xml配置文件中<code>mirrors</code>和<code>profile中repositories</code>的关系</h2><p>两个标签都定义了一个远程仓库的位置，如果一个依赖同时存在于这2个仓库，会先加载哪个依赖？</p><p>mirrors相当于拦截器，maven加载依赖时，如果mirror的mirrorOf配置的值与对应的repository的id相同，那么mirror的仓库地址替换掉repository的仓库地址。</p><p><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202307260222852.png" alt=""></p><h1 id="五、pom-xml配置详解"><a href="#五、pom-xml配置详解" class="headerlink" title="五、pom.xml配置详解"></a>五、pom.xml配置详解</h1><p>settings.xml定义的是全局或用户的配置，pom.xml定义的是一个项目的依赖配置。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span> = <span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:xsi</span> = <span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xsi:schemaLocation</span> = <span class="string">&quot;http://maven.apache.org/POM/4.0.0</span></span></span><br><span class="line"><span class="string"><span class="tag">    http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 模型版本 一般不用更改 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 公司或者组织的唯一标志，也是打包成jar包路径的依据 --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 例如com.companyname.project-group，maven打包jar包的路径：/com/companyname/project-group --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.companyname.project-group<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 项目的唯一ID，一个groupId下面可能多个项目，就是靠artifactId来区分的 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>projectid<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 项目当前版本，格式为:主版本.次版本.增量版本-限定版本号 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--项目产生的构件类型，</span></span><br><span class="line"><span class="comment">    jar、war主要用来标识项目打包出的服务是jar包还是war包 </span></span><br><span class="line"><span class="comment">    pom一般用作多moudle的项目中 顶层的pom用来指定子moudle中需要依赖的版本--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>jar<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--定义了本项目的名称与example的网址 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>blog project<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url</span>&gt;</span>blog.tsukasa.moe<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="1、dependencies"><a href="#1、dependencies" class="headerlink" title="1、dependencies"></a>1、dependencies</h2><p>定义了项目中所需要的相关依赖。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--  依赖坐标 --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--依赖项目的坐标三元素：groupId + artifactId + version --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-artifact<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.8.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 依赖传递 --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--依赖排除，即告诉maven只依赖指定的项目，不依赖该项目的这些依赖。此元素主要用于解决版本冲突问题 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 可选依赖，用于阻断依赖的传递性。如果在项目B中把C依赖声明为可选，那么依赖B的项目中无法使用C依赖，如使用到C依赖提供的服务，需要另外引入C依赖 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 依赖范围 --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--依赖范围。在项目发布过程中，帮助决定哪些构件被包括进来</span></span><br><span class="line"><span class="comment">            - compile：默认范围，适用于所有阶段，会随着项目一起发布;  </span></span><br><span class="line"><span class="comment">            - runtime: 在执行时需要使用，如JDBC驱动，适用运行和测试阶段，不同于例如fastjson，需要在编译时使用;   </span></span><br><span class="line"><span class="comment">            - test: 只在测试时使用，用于编译和运行测试代码，例如junit，不同于junit，在发布时并不需要;    </span></span><br><span class="line"><span class="comment">            - optional: 当项目自身被依赖时，标注依赖是否传递。用于连续依赖时使用 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="2、dependencyManagement"><a href="#2、dependencyManagement" class="headerlink" title="2、dependencyManagement"></a>2、dependencyManagement</h2><p>一个服务中存在多个module时，每个子module可能都引用了相同的jar包，此时可以通过maven继承，父级pom.xml统一管理依赖版本。需要使用到<code>&lt;dependencyManagement&gt;</code>标签。</p><p>示例：</p><p>父级pom.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--在父pom中定义子pom需要的相关依赖 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.aspectj<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>aspectjweaver<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br></pre></td></tr></table></figure><p>子module的pom.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--在子pom中  如下定义了父pom中相关依赖信息 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.5.10.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--因为引用了父pom 所以可以不指定版本 maven会自动去父pom中查找指定版本 此处为1.0.0 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.aspectj<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>aspectjweaver<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="3、properties"><a href="#3、properties" class="headerlink" title="3、properties"></a>3、properties</h2><p>properties主要用来定义常量，常见的有依赖版本、JDK版本、字节编码等，通过${value}来使用。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--配置依赖版本--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Environment Settings --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">project.reporting.outputEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.reporting.outputEncoding</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Spring cloud Settings   --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">spring-cloud.version</span>&gt;</span>Finchley.RELEASE<span class="tag">&lt;/<span class="name">spring-cloud.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">slf4j.version</span>&gt;</span>1.7.12<span class="tag">&lt;/<span class="name">slf4j.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--spring cloud--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-cloud.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- slf4j --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;slf4j.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>此外，Maven还通过约定大于配置的方式定义了一些常用的属性：</p><table><thead><tr><th>属性</th><th style="text-align:left">定义</th></tr></thead><tbody><tr><td><code>$&#123;basedir&#125;</code></td><td style="text-align:left">存放pom.xml和所有的子目录</td></tr><tr><td><code>$&#123;basedir&#125;/src/main/java</code></td><td style="text-align:left">项目的java源代码</td></tr><tr><td><code>$&#123;basedir&#125;/src/main/resources</code></td><td style="text-align:left">项目的资源，比如说property文件，springmvc.xml</td></tr><tr><td><code>$&#123;basedir&#125;/src/main/webapp/WEB-INF</code></td><td style="text-align:left">web应用文件目录，web项目的信息，比如web.xml</td></tr><tr><td><code>$&#123;basedir&#125;/target</code></td><td style="text-align:left">打包输出目录</td></tr><tr><td><code>$&#123;project.version&#125;</code></td><td style="text-align:left">项目版本</td></tr><tr><td><code>$&#123;project.groupId&#125;</code></td><td style="text-align:left">项目groupId</td></tr></tbody></table><h2 id="4、resources"><a href="#4、resources" class="headerlink" title="4、resources"></a>4、resources</h2><p><code>&lt;build&gt;</code>下面的<code>&lt;resources&gt;</code>标签用来标识项目在编译运行时需要额外编译的文件。例如手工引入jar包、不同运行环境对应不同的profile等等。</p><p><code>&lt;testResources&gt;</code>用法与<code>&lt;resources&gt;</code>类似。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">resources</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--首先将默认resources目录下的所有文件包含进来 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">resource</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">directory</span>&gt;</span>src/main/resources<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">filtering</span>&gt;</span>true<span class="tag">&lt;/<span class="name">filtering</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--只编译所有以.fxml结尾的文件 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">includes</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">include</span>&gt;</span>**/*.fxml<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">includes</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--排除掉所有的yaml文件 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">excludes</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclude</span>&gt;</span>**/*.yaml<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">excludes</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--将不同环境下对应的不同yaml或properties文件编译运行 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">resource</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">             &lt;directory&gt;src/main/profiles/dev&lt;/directory&gt;&lt;directory&gt;src/main/profiles/beta&lt;directory&gt;&lt;directory&gt;src/main/profiles/pre&lt;/directory&gt;</span></span><br><span class="line"><span class="comment">             --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">directory</span>&gt;</span>src/main/profiles/product<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">filtering</span>&gt;</span>true<span class="tag">&lt;/<span class="name">filtering</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">includes</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">include</span>&gt;</span>**/*.fxml<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">includes</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--将手工引入的jar包编译运行 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">resource</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">directory</span>&gt;</span>lib<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">targetPath</span>&gt;</span>BOOT-INF/lib/<span class="tag">&lt;/<span class="name">targetPath</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">includes</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">include</span>&gt;</span>**/*.jar<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">includes</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">resources</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="5、profile"><a href="#5、profile" class="headerlink" title="5、profile"></a>5、profile</h2><p>通常地，setting.xml用来标识不同的远程仓库，而pom中的profile一般用来标识当前profile的配置属于哪个环境，当然也可以用来指定远程仓库。</p><p>在编译打包时，通过<code>mvn package -P prod</code>命令来激活不同环境。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">profiles</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">profile</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>dev<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--激活条件 其中默认为该profile --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">activation</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">activeByDefault</span>&gt;</span>true<span class="tag">&lt;/<span class="name">activeByDefault</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">activation</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--当此profile被激活时，会将 project.active 的属性赋值为dev --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">project.active</span>&gt;</span>dev<span class="tag">&lt;/<span class="name">project.active</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">profile</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">profile</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>test<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--当此profile被激活时，会将 project.active 的属性赋值为test --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">project.active</span>&gt;</span>test<span class="tag">&lt;/<span class="name">project.active</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">profile</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">profiles</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">resources</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">resource</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--根据不同的环境 project.active 取得不同的值 从而会将不同的环境下的yaml或properties文件编译进项目中 达到只需要在编译时指定环境变量即可 不用每次都要修改配置文件 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">directory</span>&gt;</span>src/main/$&#123;project.active&#125;<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filtering</span>&gt;</span>true<span class="tag">&lt;/<span class="name">filtering</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">includes</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">include</span>&gt;</span>**/*.fxml<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">includes</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resources</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>在Intellij IDEA的Maven窗口中，profile作为一个个的可选项存在。</p><p><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/icons/202307261811603.png" alt=""></p><h2 id="6、modules"><a href="#6、modules" class="headerlink" title="6、modules"></a>6、modules</h2><p>项目中存在多个module时，如果需要单独打包需要在每一个module都执行maven命令，通过父级pom.xml添加的<code>&lt;modules&gt;</code>标签可以将自服务进行聚合，只需要打包该服务，也会将子module同时打包。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">modules</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 引入子模块所在的相对目录 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">module</span>&gt;</span>spring-sub-module<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 引入同级模块所在的相对目录 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">module</span>&gt;</span>../utils<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">modules</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="7、查找并添加依赖"><a href="#7、查找并添加依赖" class="headerlink" title="7、查找并添加依赖"></a>7、查找并添加依赖</h2><p>配置好Maven后，想要添加什么依赖，可以到<a href="https://mvnrepository.com/">仓库索引</a>搜索，然后选择对应的坐标，复制到pom.xml文件<code>&lt;dependencies&gt;</code>中即可。</p><p><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202307251628969.png" alt=""></p><h2 id="8、依赖范围管理"><a href="#8、依赖范围管理" class="headerlink" title="8、依赖范围管理"></a>8、依赖范围管理</h2><p>Maven项目构建生命周期包括clean清理项目，default构建项目，site生成项目文档和站点。重点关注default生命周期的各个阶段：</p><table><thead><tr><th style="text-align:left">阶段</th><th style="text-align:left">中文名称</th><th style="text-align:left">描述</th></tr></thead><tbody><tr><td style="text-align:left">validate</td><td style="text-align:left">校验</td><td style="text-align:left">验证项目是否正确，所有必需信息是否可用。</td></tr><tr><td style="text-align:left">initialize</td><td style="text-align:left">初始化</td><td style="text-align:left">初始化构建状态，例如设置属性或创建目录。</td></tr><tr><td style="text-align:left">generate-sources</td><td style="text-align:left">生成源代码</td><td style="text-align:left">生成项目的源代码。</td></tr><tr><td style="text-align:left">process-sources</td><td style="text-align:left">处理源代码</td><td style="text-align:left">处理项目的源代码，例如进行过滤等操作。</td></tr><tr><td style="text-align:left">generate-resources</td><td style="text-align:left">生成资源文件</td><td style="text-align:left">生成项目的资源文件。</td></tr><tr><td style="text-align:left">process-resources</td><td style="text-align:left">处理资源文件</td><td style="text-align:left">复制并处理资源文件，为打包做准备。</td></tr><tr><td style="text-align:left"><strong>compile</strong></td><td style="text-align:left">编译</td><td style="text-align:left">编译项目的源代码。</td></tr><tr><td style="text-align:left">process-classes</td><td style="text-align:left">处理类文件（字节码）</td><td style="text-align:left">对编译后的字节码进行处理。</td></tr><tr><td style="text-align:left">generate-test-sources</td><td style="text-align:left">生成测试源代码</td><td style="text-align:left">生成项目的测试源代码。</td></tr><tr><td style="text-align:left">process-test-sources</td><td style="text-align:left">处理测试源代码</td><td style="text-align:left">处理项目的测试源代码，例如进行过滤等操作。</td></tr><tr><td style="text-align:left">generate-test-resources</td><td style="text-align:left">生成测试资源文件</td><td style="text-align:left">生成项目的测试资源文件。</td></tr><tr><td style="text-align:left">process-test-resources</td><td style="text-align:left">处理测试资源文件</td><td style="text-align:left">复制并处理测试资源文件，为测试做准备。</td></tr><tr><td style="text-align:left"><strong>test-compile</strong></td><td style="text-align:left">编译测试源代码</td><td style="text-align:left">编译项目的测试源代码。</td></tr><tr><td style="text-align:left">process-test-classes</td><td style="text-align:left">处理测试类文件（字节码）</td><td style="text-align:left">对测试编译后的字节码进行处理。</td></tr><tr><td style="text-align:left"><strong>test</strong></td><td style="text-align:left">测试</td><td style="text-align:left">使用合适的测试框架运行测试（一般我们在idea种开发项目时，可以选择屏蔽掉test步骤）。</td></tr><tr><td style="text-align:left">prepare-package</td><td style="text-align:left">准备打包</td><td style="text-align:left">进行必要的操作，以便进行打包。</td></tr><tr><td style="text-align:left"><strong>package</strong></td><td style="text-align:left">打包</td><td style="text-align:left">将编译后的代码打包成可分发的格式，例如 JAR、WAR。</td></tr><tr><td style="text-align:left">pre-integration-test</td><td style="text-align:left">集成测试前</td><td style="text-align:left">在集成测试之前进行的操作。</td></tr><tr><td style="text-align:left">integration-test</td><td style="text-align:left">集成测试</td><td style="text-align:left">处理和部署项目，以便进行集成测试。</td></tr><tr><td style="text-align:left">post-integration-test</td><td style="text-align:left">集成测试后</td><td style="text-align:left">在集成测试之后进行的操作。</td></tr><tr><td style="text-align:left">verify</td><td style="text-align:left">验证</td><td style="text-align:left">检查包是否有效，符合质量标准。</td></tr><tr><td style="text-align:left"><strong>install</strong></td><td style="text-align:left">安装</td><td style="text-align:left">将包安装到本地仓库，以便其他项目依赖。</td></tr><tr><td style="text-align:left">deploy</td><td style="text-align:left">部署</td><td style="text-align:left">将最终的包复制到远程仓库，共享给其他开发人员和项目。</td></tr></tbody></table><p></br><br>在pom.xml文件的<code>&lt;dependency&gt;</code>标签中有一个子标签<code>&lt;scope&gt;</code>，默认值为compile，记录了依赖的jar包在哪些环境有效<br></br></p><table><thead><tr><th style="text-align:center">Scope</th><th style="text-align:center">编译环境</th><th style="text-align:center">测试环境</th><th style="text-align:center">运行环境</th><th style="text-align:left">例子</th><th style="text-align:left">描述</th></tr></thead><tbody><tr><td style="text-align:center">compile</td><td style="text-align:center">Y</td><td style="text-align:center">Y</td><td style="text-align:center">Y</td><td style="text-align:left">spring-core</td><td style="text-align:left">依赖对所有的classpath都有效</td></tr><tr><td style="text-align:center">provided</td><td style="text-align:center">Y</td><td style="text-align:center">Y</td><td style="text-align:center">-</td><td style="text-align:left">servlet-api</td><td style="text-align:left">执行打包<code>mvn package</code>时会移除，运行时由应用服务器提供</td></tr><tr><td style="text-align:center">system</td><td style="text-align:center">Y</td><td style="text-align:center">Y</td><td style="text-align:center">-</td><td style="text-align:left">本地的，Maven仓库之外的类库文件</td><td style="text-align:left">类似provided，但依赖项不会从maven仓库中查找，通过<code>&lt;systemPath&gt;</code>标签获取</td></tr><tr><td style="text-align:center">runtime</td><td style="text-align:center">-</td><td style="text-align:center">Y</td><td style="text-align:center">Y</td><td style="text-align:left">jdbc驱动包</td><td style="text-align:left">编译的时候不需要，只在运行和测试的时候需要用到</td></tr><tr><td style="text-align:center">test</td><td style="text-align:center">-</td><td style="text-align:center">Y</td><td style="text-align:center">-</td><td style="text-align:left">Junit/Mockito</td><td style="text-align:left">只在测试编译和测试运行阶段可用</td></tr></tbody></table><p>还有一个特殊的取值：<code>import</code>，仅在父级pom.xml的<code>&lt;dependencyManagement&gt;</code>的标签中可用，不做展开。</p><p>scope为system示例：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.open<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>open-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>system<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- package时会排除这个jar，运行时由应用服务器提供 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">systemPath</span>&gt;</span>$&#123;basedir&#125;/WebContent/WEB-INF/lib/open-core.jar<span class="tag">&lt;/<span class="name">systemPath</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>关于Dependency Scope的官方描述，请查阅：<a href="https://maven.apache.org/guides/introduction/introduction-to-dependency-mechanism.html">https://maven.apache.org/guides/introduction/introduction-to-dependency-mechanism.html</a></p><p><strong>总结</strong></p><p>通过maven引入的jar包，里面的类都是已经编译好的字节码，与scope参数没有什么联系。</p><p>compile、runtime和provided的区别，需要在执行打包<code>mvn package</code>命令，并且打包格式时war时才能看出来。<br>通过compile和runtime引入的jar包，执行打包命令后会出现在war包里，而provided引入的jar包则不会。</p><p>通过compile和provided引入的jar包，里面的类，在项目中直接import进来就可以使用了，编译也没有问题；<br>而通过runtime引入的jar包中的类，项目代码不能直接使用，用了无法通过编译，只能通过反射的方式来调用。</p><h2 id="9、解决依赖冲突"><a href="#9、解决依赖冲突" class="headerlink" title="9、解决依赖冲突"></a>9、解决依赖冲突</h2><p>依赖传递遵循三个原则：</p><ul><li>最短路径优先：项目中存在两级以上的不同依赖，引用同一个依赖时，层级越浅，优先级越高。举例：项目A -&gt; B -&gt; C1，A -&gt; D -&gt; E -&gt; C2，其中C1和C2是同一个依赖的不同版本，此时A项目以C1的版本为准。</li><li>声明优先：对于两级以上的同级依赖，先声明的依赖会覆盖后声明的依赖包。举例：项目A -&gt; B -&gt; C1，A -&gt; D -&gt; C2，以C1版本为准。</li><li>特殊优先：同级依赖中，后加载覆盖先加载原则。举例：项目A-&gt;C1，再次配置A-&gt;C2，那么以C1版本为准。</li></ul><p>Intellij IDEA解决依赖冲突思路：</p><ul><li>通过Maven Helper插件的Dependency Analyzer对pom文件进行依赖分析，找到冲突或重复的jar包，用<code>&lt;exclusions&gt;</code>标签排除不需要的版本，要注意是否存在兼容性问题。此外也可以通过命令行<code>mvn dependency:tree</code>查看项目的依赖树，观察实际加载的版本。</li><li>编译打包后打开查看实际打的jar包版本，进行核对</li></ul><p><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202307260245785.png" alt=""></p><p><strong>依赖分析相关的maven命令</strong></p><p><code>mvn dependency:list</code>：查看项目已解析的依赖。<br><code>mvn dependency:tree</code> 查看项目的依赖树。<br><code>mvn dependency:analyze</code>：分析项目的依赖信息，有2种，根据需要选择主动声明，或者移除不需要的依赖。</p><ul><li>Used undeclared dependencies，项目中已使用但未声明的依赖。</li><li>Unused declared dependencies，项目中未使用但已声明的依赖。</li></ul><h1 id="六、参考资料"><a href="#六、参考资料" class="headerlink" title="六、参考资料"></a>六、参考资料</h1><p><a href="https://juejin.cn/post/7248219648054739002?searchId=2023072515490122F2732AC2519B001AAA">Maven进阶学习指南 | 京东云技术团队</a><br><a href="https://juejin.cn/post/7257122036597669943?searchId=202307260227417A7D2F23A819C3475E0C">实际上手体验maven面对冲突Jar包的加载规则 | 京东云技术团队</a></p><blockquote><p>声明：本站所有文章均为原创或翻译，遵循<a href="https://creativecommons.org/licenses/by-nc-nd/4.0/deed.en">署名 - 非商业性使用 - 禁止演绎 4.0 国际许可协议</a>，如需转载请确保您对该协议有足够了解，并附上作者名 (Tsukasa) 及原文地址</p></blockquote>]]></content>
    
    
    <summary type="html">&lt;script src=&quot;&#92;assets&#92;js&#92;APlayer.min.js&quot;&gt; &lt;/script&gt;&lt;p&gt;本文详细分析了Maven的全局/用户级配置文件settings.xml和项目级配置文件pom.xml，便于查阅。&lt;/p&gt;</summary>
    
    
    
    <category term="构建工具" scheme="http://blog.tsukasa.moe/categories/%E6%9E%84%E5%BB%BA%E5%B7%A5%E5%85%B7/"/>
    
    
    <category term="Maven" scheme="http://blog.tsukasa.moe/tags/Maven/"/>
    
  </entry>
  
  <entry>
    <title>Windows下Maven安装配置</title>
    <link href="http://blog.tsukasa.moe/2023/07/25/Maven-configuration-for-windows/"/>
    <id>http://blog.tsukasa.moe/2023/07/25/Maven-configuration-for-windows/</id>
    <published>2023-07-25T07:55:34.000Z</published>
    <updated>2023-07-26T06:48:42.813Z</updated>
    
    <content type="html"><![CDATA[<!-- excerpt --><p>Windows开发环境下Maven配置，包括环境变量、设置中央仓库镜像。</p><!-- toc --><h1 id="Maven下载安装"><a href="#Maven下载安装" class="headerlink" title="Maven下载安装"></a>Maven下载安装</h1><p>官网下载Maven压缩包：<a href="https://maven.apache.org/download.cgi">https://maven.apache.org/download.cgi</a><br>下载完成后解压到需要安装的目录即可。</p><h1 id="环境变量配置"><a href="#环境变量配置" class="headerlink" title="环境变量配置"></a>环境变量配置</h1><p><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202307251600821.png" alt=""></p><p>配置完成后打开cmd命令行输入<code>mvn -v</code>验证配置结果</p><p><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202307251603354.png" alt=""></p><h1 id="仓库配置"><a href="#仓库配置" class="headerlink" title="仓库配置"></a>仓库配置</h1><p>Maven分为本地仓库和远程仓库，本地仓库即localRepository配置的路径。<br>远程仓库分为中央仓库、私服、其他公共库。</p><p>由于墙的存在，国内访问国外中央仓库不顺利，Maven拉取Jar包时会很慢甚至无法拉取，因此需要配置下国内的镜像仓库。镜像仓库在Maven下进行配置。</p><h2 id="配置镜像仓库"><a href="#配置镜像仓库" class="headerlink" title="配置镜像仓库"></a>配置镜像仓库</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mirror</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span>&gt;</span>alimaven<span class="tag">&lt;/<span class="name">id</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>aliyun maven<span class="tag">&lt;/<span class="name">name</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.aliyun.com/nexus/content/groups/public/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br></pre></td></tr></table></figure><p><code>&lt;mirrorOf&gt;</code>标签用来匹配当请求什么仓库依赖时使用该镜像去下载jar包。<br>下面是一些常用的语法示例：</p><ul><li><code>&lt;mirrorOf&gt;*&lt;mirrorOf&gt;</code>：匹配所有远程仓库。</li><li><code>&lt;mirrorOf&gt;external:*&lt;mirrorOf&gt;</code>：匹配所有不在本机上的远程仓库。</li><li><code>&lt;mirrorOf&gt;repo1,repo2&lt;mirrorOf&gt;</code>：匹配仓库repo1和repo2，使用逗号分隔多个远程仓库。</li><li><code>&lt;mirrorOf&gt;*,!repo1&lt;mirrorOf&gt;</code>：匹配所有远程仓库，repo1除外，使用感叹号将仓库从匹配中排除。</li></ul><p>注意：镜像仓库完全屏蔽了被镜像仓库，当镜像仓库不稳定或者停止服务的时候，Maven仍将无法访问被镜像仓库，因而将无法下载jar包。</p><p>此外，maven读取mirror配置是从上往下读取的，因此谨慎配置<code>&lt;mirrorOf&gt;*&lt;mirrorOf&gt;</code>，因为如果第一个镜像仓库配置了如此标志，那么如果该仓库即使不存在对应依赖也不会向下游查询。</p><h2 id="配置本地仓库"><a href="#配置本地仓库" class="headerlink" title="配置本地仓库"></a>配置本地仓库</h2><p>本地仓库即jar包下载的路径。默认jar包下载到<code>$&#123;user.home&#125;/.m2/repository</code></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">localRepository</span>&gt;</span>D:\Workslace\Maven\maven-repository<span class="tag">&lt;/<span class="name">localRepository</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>声明：本站所有文章均为原创或翻译，遵循<a href="https://creativecommons.org/licenses/by-nc-nd/4.0/deed.en">署名 - 非商业性使用 - 禁止演绎 4.0 国际许可协议</a>，如需转载请确保您对该协议有足够了解，并附上作者名 (Tsukasa) 及原文地址</p></blockquote>]]></content>
    
    
    <summary type="html">&lt;script src=&quot;&#92;assets&#92;js&#92;APlayer.min.js&quot;&gt; &lt;/script&gt;&lt;p&gt;Windows开发环境下Maven配置，包括环境变量、设置中央仓库镜像。&lt;/p&gt;</summary>
    
    
    
    <category term="构建工具" scheme="http://blog.tsukasa.moe/categories/%E6%9E%84%E5%BB%BA%E5%B7%A5%E5%85%B7/"/>
    
    
    <category term="Maven" scheme="http://blog.tsukasa.moe/tags/Maven/"/>
    
  </entry>
  
  <entry>
    <title>Java 8新特性Lambda表达式学习笔记</title>
    <link href="http://blog.tsukasa.moe/2023/07/23/Learning-notes-for-java-8-new-feature-lambda-expression/"/>
    <id>http://blog.tsukasa.moe/2023/07/23/Learning-notes-for-java-8-new-feature-lambda-expression/</id>
    <published>2023-07-23T15:36:36.000Z</published>
    <updated>2023-07-24T16:23:46.110Z</updated>
    
    <content type="html"><![CDATA[<!-- excerpt --><p>Java 8新特性lambda表达式，未完成。</p><h1 id="基本理解"><a href="#基本理解" class="headerlink" title="基本理解"></a>基本理解</h1><ul><li>lambda表达式的类型依赖于上下文，通过编译器编译阶段javac即可推断出来，程序依旧要经过类型检查保证运行的安全性。</li><li>lambda表达式可以传入外部既成事实上是final的变量，比如只赋值了一次。</li><li>函数接口是只有一个抽象方法的接口，用作lambda表达式的类型</li><li>Stream 是用函数式编程方式在集合类上进行复杂操作的工具</li><li>通常是一系列的惰性求值行成的链，然后通过一个早求值返回想要的结果，与Builder模式有共通之处。</li><li>及早求值函数执行之前，惰性函数求值不会真正参与运算。</li><li>Stream是一个接口，继承了AutoCloseable，一个流只能消费一次（调用及早求值方法一次）。</li><li>流可以嵌套使用，流的某个步骤需要某个值也可以通过流来获取。</li><li>掌握重要的函数接口，要融会贯通。</li></ul><p>基本函数接口：</p><table><thead><tr><th>接口</th><th>参数</th><th>返回类型</th><th>示例</th></tr></thead><tbody><tr><td>Predicate<T></td><td>T</td><td>boolean</td><td>这张唱片已经发行了吗</td></tr><tr><td>Consumer<T></td><td>T</td><td>void</td><td>输出一个值</td></tr><tr><td>Function<T,R></td><td>T</td><td>R</td><td>获得 Artist 对象的名字</td></tr><tr><td>Supplier<T></td><td>None</td><td>T</td><td>工厂方法</td></tr><tr><td>UnaryOperator<T></td><td>T</td><td>T</td><td>逻辑非（!）</td></tr><tr><td>BinaryOperator<T></td><td>(T, T)</td><td>T</td><td>求两个数的乘积（*）</td></tr></tbody></table><p>示例：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Predicate&lt;Integer&gt; predicate = x -&gt; x == <span class="number">1</span>;</span><br><span class="line">Consumer&lt;Integer&gt; consumer = x -&gt; System.out.println(x);</span><br><span class="line">Function&lt;Integer, Integer&gt; function = x -&gt; x = x + <span class="number">1</span>;</span><br><span class="line">Supplier&lt;Integer&gt; supplier = () -&gt; <span class="number">1</span>;</span><br><span class="line">UnaryOperator&lt;Integer&gt; unaryOperator = x -&gt; x + <span class="number">1</span>;</span><br><span class="line">BinaryOperator&lt;Integer&gt; binaryOperator = (x, y) -&gt; x * y;</span><br><span class="line"></span><br><span class="line">System.out.println(predicate.test(<span class="number">1</span>));</span><br><span class="line">consumer.accept(<span class="number">1</span>);</span><br><span class="line">System.out.println(function.apply(<span class="number">1</span>));</span><br><span class="line">System.out.println(supplier.get());</span><br><span class="line">System.out.println(unaryOperator.apply(<span class="number">1</span>));</span><br><span class="line">System.out.println(binaryOperator.apply(<span class="number">1</span>, <span class="number">2</span>));</span><br><span class="line"></span><br></pre></td></tr></table></figure><h1 id="基本特性"><a href="#基本特性" class="headerlink" title="基本特性"></a>基本特性</h1><ul><li>基本类型与包装类型：ToLongFunction, mapToInt</li><li>@FunctionalInterface注解：强制javac检查一个接口是否符合函数接口的标准，即只有一个抽象方法的接口，如Comparator接口的compare方法则是抽象方法，其他不是。</li><li>默认方法（default）：增加默认方法的目的是实现接口向后兼容，类中重写的方法优先级高于接口中定义的默认方法</li><li>接口多重继承默认方法相同，需要显示指定调用的父接口方法</li><li>Optional避免NullPointerException，消除if语句</li><li>方法引用、元素排序、收集器（转换为其他集合、转换成值、数据分块、数据分组、字符串）、并行处理</li><li>方法引用是一种更简短的语法，如artist -&gt; artist.getName()可以简写为Artist::getName，标准语法为Classname::methodName，分为三种:<ul><li>指向静态方法的引用，如Objects::nonNull</li><li>指向任意类型实例方法的引用，如String::length</li><li>指向现有对象的实例方法引用，如user::getName</li></ul></li><li>使用并行流时，forEach无法保证元素是按顺序处理，应该使用forEachOrdered。</li><li>peak可以查看流中的每个值，类似forEach操作但不是及早求值方法</li></ul><h1 id="常用场景"><a href="#常用场景" class="headerlink" title="常用场景"></a>常用场景</h1><h2 id="常用Java-8-API"><a href="#常用Java-8-API" class="headerlink" title="常用Java 8 API"></a>常用Java 8 API</h2><p>collect：将流转换为一个集合。<br>filter：过滤出流中符合条件的元素。<br>map：将流中的每个元素转化为另一个元素。<br>flatMap：将底层元素全部抽出来放到一个流中，将多个流合并为一个流进行操作。<br>reduce：将Stream流中的数据通过递归的方式，聚合成一个数据，</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Stream.of(nums1, nums2).flatMap(num -&gt; num.stream()).forEach(System.out::println);</span><br></pre></td></tr></table></figure><p>reduce：递归概念，归约成一个值。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reduce([p1,p2,p3,p4],fn) = reduce([fn(p2,p4),fn(p1,p3)])</span><br></pre></td></tr></table></figure><h2 id="集合的遍历（List-Set-Map）"><a href="#集合的遍历（List-Set-Map）" class="headerlink" title="集合的遍历（List, Set, Map）"></a>集合的遍历（List, Set, Map）</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 遍历map</span></span><br><span class="line">map.forEach((key, value) -&gt; System.out.println(key + <span class="string">&quot;=&quot;</span> + value));</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>## </p><h2 id="集合之间的转换"><a href="#集合之间的转换" class="headerlink" title="集合之间的转换"></a>集合之间的转换</h2><p>常用方法如下，可以查看源码获取重载方法：<br>Collectors.toList(), Collectors.toSet(), Collectors.toMap(), Collectors.toConcurrentMap(), Collectors.toArray()</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// list转map</span></span><br><span class="line">Map&lt;String, String&gt; map = channelParameters.stream()</span><br><span class="line">            .sorted(Comparator.comparing(ChannelParameter::getVersion).reversed())</span><br><span class="line">            .collect(Collectors.toMap(ChannelParameter::getName,</span><br><span class="line">                ChannelParameter::getValue, (v1, v2) -&gt; v1));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 对象数组转Map</span></span><br><span class="line">Map&lt;String, String&gt; studentMap = Arrays.stream(studentArray).collect(Collectors.toMap(Student::getName, Student::getScore));</span><br><span class="line"></span><br><span class="line"><span class="comment">// String[]转set</span></span><br><span class="line">Set&lt;String&gt; set = Arrays.stream(strArray).collect(Collectors.toSet());</span><br><span class="line"></span><br><span class="line"><span class="comment">// 多线程解密</span></span><br><span class="line">List&lt;Runnable&gt; jobs = getDecryptJobs(xxx);</span><br><span class="line">CompletableFuture&lt;?&gt;[] futures = jobs.stream()</span><br><span class="line">    .map(job -&gt; CompletableFuture.runAsync(job,</span><br><span class="line">        AsyncManager.getExecutor(<span class="string">&quot;decryptParam&quot;</span>, getSupportExecutorProvider())))</span><br><span class="line">    .toArray(CompletableFuture[]::<span class="keyword">new</span>);</span><br></pre></td></tr></table></figure><h2 id="排序"><a href="#排序" class="headerlink" title="排序"></a>排序</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 写法1</span></span><br><span class="line">Collections.sort(studentList);</span><br><span class="line"><span class="comment">// 写法2， Comparator也可以不采取匿名类的形式</span></span><br><span class="line">Collections.sort(studentList, <span class="keyword">new</span> <span class="title class_">Comparator</span>&lt;Student&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">compare</span><span class="params">(Student o1, Student o2)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> o1.getScore() - o2.getScore();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 写法3</span></span><br><span class="line">Collections.sort(studentList, (o1, o2) -&gt; o1.getScore() - o2.getScore());</span><br><span class="line"><span class="comment">// 写法4</span></span><br><span class="line">Collections.sort(studentList, Comparator.comparingInt(Student::getScore));</span><br><span class="line"><span class="comment">// 写法5，推荐</span></span><br><span class="line">studentList.sort(Comparator.comparingInt(Student::getScore));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 数组排序</span></span><br><span class="line">Arrays.sort(strArray);</span><br></pre></td></tr></table></figure><p><strong>list对象多字段排序</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 先按照score降序排列，再按照name升序排列</span></span><br><span class="line"><span class="comment">// 写法1</span></span><br><span class="line">list.stream().sorted(Comparator.comparing(Student::getScore).reversed().thenComparing(Student::getName));</span><br><span class="line"><span class="comment">// 写法2</span></span><br><span class="line">list.stream().sorted(Comparator.comparing(Student::getScore, Comparator.reverseOrder()).thenComparing(Student::getName));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 及早求值排序</span></span><br><span class="line">versionList.sort((a, b) -&gt; b.getUpdateTime().compareTo(a.getUpdateTime()));</span><br></pre></td></tr></table></figure><p><strong>字典排序拼接字符串用作签名</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">sortedContent</span> <span class="operator">=</span> data.entrySet().stream()</span><br><span class="line">        .filter(key -&gt; !Constants.FIELD_SIGN.equals(data.get(key)))</span><br><span class="line">        .filter(key -&gt; StringUtils.isNoneBlank(key.getValue()))</span><br><span class="line">        .sorted(Map.Entry.comparingByKey())</span><br><span class="line">        .map(entry -&gt; entry.getKey() + <span class="string">&quot;=&quot;</span> + StringUtils.trim(entry.getValue()))</span><br><span class="line">        .collect(Collectors.joining(<span class="string">&quot;&amp;&quot;</span>));</span><br></pre></td></tr></table></figure><h2 id="Optional处理空值"><a href="#Optional处理空值" class="headerlink" title="Optional处理空值"></a>Optional处理空值</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 避免if判空，空值返回orElse的值</span></span><br><span class="line">List&lt;ChannelResponse.ChannelParameter&gt; channelParameters = Optional.ofNullable(response)</span><br><span class="line">            .map(ChannelResponse::getChannelParameters)</span><br><span class="line">            .orElse(Collections.emptyList());</span><br><span class="line"></span><br><span class="line"><span class="comment">// 流中使用流，max函数</span></span><br><span class="line"><span class="type">String</span> <span class="variable">latestVal</span> <span class="operator">=</span> Optional.ofNullable(channelParameters)</span><br><span class="line">            .map(data -&gt; data.stream()</span><br><span class="line">                .filter(v -&gt; name.equals(v.getName()))</span><br><span class="line">                .max(Comparator.comparing(GetChannelParametersResponse.ChannelParameter::getVersion))</span><br><span class="line">                .map(GetChannelParametersResponse.ChannelParameter::getValue)</span><br><span class="line">                .get())</span><br><span class="line">            .orElse(<span class="literal">null</span>);</span><br></pre></td></tr></table></figure><p>Comparable与Java8的Comparator区别？<br>多层排序？<br>Arrays类使用<br>使用各套测试框架，每个框架都要实现一定的测试场景<br>Mockito测试框架</p><p>Runtime.getRuntime().availableProcessors()<br>Arrays.parallelSetAll(array, i -&gt; i);</p><p>数组上的并行化操作：parallelPrefix, parallelSetAll, parallelSort</p><p>javafx.util.Pair使用</p><blockquote><p>声明：本站所有文章均为原创或翻译，遵循<a href="https://creativecommons.org/licenses/by-nc-nd/4.0/deed.en">署名 - 非商业性使用 - 禁止演绎 4.0 国际许可协议</a>，如需转载请确保您对该协议有足够了解，并附上作者名 (Tsukasa) 及原文地址</p></blockquote>]]></content>
    
    
    <summary type="html">&lt;script src=&quot;&#92;assets&#92;js&#92;APlayer.min.js&quot;&gt; &lt;/script&gt;&lt;p&gt;Java 8新特性lambda表达式学习笔记，未完成。&lt;/p&gt;</summary>
    
    
    
    <category term="Java" scheme="http://blog.tsukasa.moe/categories/Java/"/>
    
    
    <category term="Java 8" scheme="http://blog.tsukasa.moe/tags/Java-8/"/>
    
  </entry>
  
  <entry>
    <title>《代码整洁之道》读书笔记</title>
    <link href="http://blog.tsukasa.moe/2023/07/23/Reading-notes-for-Clean-code/"/>
    <id>http://blog.tsukasa.moe/2023/07/23/Reading-notes-for-Clean-code/</id>
    <published>2023-07-23T15:32:36.000Z</published>
    <updated>2023-07-25T05:02:23.738Z</updated>
    
    <content type="html"><![CDATA[<!-- excerpt --><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>有时候业务交付压力使得开发人员只关注了交付本身，而忽略了质量，但作为一名研发人员，质量上是不能够作让步的。有些业务金融敏感，搞砸了很可能损害公司商业利益，自己也丢掉饭碗。因此，重申质量的重要性是很有必要的。</p><p>质量是上百万次全身心投入的结果，需要落实到每天，每小时之中。开发工作中，我们通常会遇到2种情形，一种是新特性开发，特点是与原有代码关联较少，另一种是特性增强，需要改大量原有代码。开发人员通常会想先把功能开发完成，再去重构、优化，虽然说出发点不错，但稍后等于永不(Later equals never)。</p><p>这里我提出自己的想法，抛砖引玉。</p><ul><li>对于自己编写和改动的部分，有重构思路可以直接着手修改，不然拖到转测了后只会不了了之。对于非特性开发范围的不合理的代码，需要认真评估。<br>对于有把握的重构、优化(必须能够评估影响)，不要害怕修改。重构其实不意味着重写，提取方法，修改参数命名等等利用IDE是比较安全便捷的。我们要胆大心细，谨慎地修改，修改后一定要自测通过，确保DevOps测试用例通过，最好申请重构单号，单独做一次commit，在代码评审时请大家评审自己的改动。</li><li>对于无法评估的影响范围和后果的修改，坚决不修改，要学会敬畏，否则一个配置的改动将引发大灾难。</li></ul><p>作为开发，要做到小处诚实，放下身段，谦虚审慎承认代码现状，做到不自欺，而后思改进。</p><p>写代码跟写文章一样，结构条理清晰，如白居易的诗一样通俗易懂，代码即注释，注释太多可能预示着功能的难以理解，代码含义应由自身表达，重构时直接以用代码代替文字描述列大纲，从上到下去编写。<br>此外重构的过程，遵循小步快跑，重构完一个独立的代码片段应该及时验证。</p><h1 id="整洁代码定义"><a href="#整洁代码定义" class="headerlink" title="整洁代码定义"></a>整洁代码定义</h1><p>衡量代码质量的唯一有效标准：WTF/minute in code review，意思是代码评审者每分钟骂出”WTF”的频率=w=</p><p>写整洁代码，要遵循大量小技巧。</p><p>把写代码当成故事来讲，让听故事的人能够清晰的了解整个故事情节。</p><p>破窗理论：一栋建筑的窗户破了，如果没人去修理，那将越来越多人的破坏其他窗户。意思是环境中的不良现象如果被放任存在，会诱使人们仿效，甚至变本加厉。<br>代码开发中深受破窗理论影响，想必每个开发都会遇到代码中一串长长的if else if条件代码块在不断膨胀，因为人们刚开始觉得不对劲，但是想了想应该有历史原因而效仿着前辈，继续写着shit code，却没有人想着用多态或者查表得方式重构下。</p><h2 id="什么是整洁代码"><a href="#什么是整洁代码" class="headerlink" title="什么是整洁代码"></a>什么是整洁代码</h2><p>几乎没有改进的余地的代码即好代码</p><ul><li>通过所有测试</li><li>没有重复代码</li><li>体现系统中的全部设计理念</li></ul><p>所有程序都由极为相似的元素构成，如“在集合中查找某物”，一旦出现这种情况，可以把实现手段封装到更抽象的方法中。</p><p>一个人写代码的过程，读与写花费时间的比例超过10:1，因此要先让代码易读。<br>让营地比你来时更干净，消除重复和提高表达力。</p><h1 id="命名"><a href="#命名" class="headerlink" title="命名"></a>命名</h1><p><strong>名副其实</strong></p><ul><li>一旦发现更好的名称，就换掉旧的。</li><li>上下文在代码中要被明确的体现出来，降低代码的模糊度。</li></ul><p><strong>避免误导</strong><br>举例：accountList的list有特殊含义，考虑accounts, accountGroup, bunchOfAccounts</p><p><strong>做有意义的区分</strong><br>xxxInfo，xxxData是废话</p><p><strong>一些准则</strong></p><ul><li>使用读得出来的名称</li><li>使用可搜索的名称</li><li>避免使用新的编码约定</li><li>类名应是名词或名词短语</li><li>避免使用Manager, Processor等？</li><li>方法名应当是动词或动词短语</li><li>使用解决方案领域名称</li><li>添加有意义的语境</li><li>前缀不要添加没有用的语境，短名称足够清楚就比长名称好</li></ul><h1 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h1><ul><li>短小、还要更短小。100行以内，20行最佳</li><li>只做一件事。判断一个函数是否只做了一件事，就看是否能再拆出一个函数</li><li>每个函数一个抽象层级，自上而下读代码</li><li>Switch语句可以考虑利用多态，移动到工厂底下</li><li>使用描述性的名称，长而具有描述性的名称，比短而令人费解的名称好，比描述性的注释好；命名方式保持一致</li><li>函数参数<ul><li>函数参数尽量少，超过3个参数可以考虑参数对象的方式。没有参数时需要注意是否大量运用上下文，大量运用上下文不是一个好的设计。</li><li>标识参数丑陋不堪，不要往参数传入布尔值（意味着true做一件事，false做另一件事）</li><li>遵循数学约定表示，如new Point(x, y)也是见参知义。</li><li>动词、动名词做为参数名称</li><li>无副作用，函数只承诺做一件事，但实际是谎言。</li><li>避免使用输出参数。</li></ul></li><li>分隔指令（做某件事）与询问（判断语句）</li><li>使用异常替代错误码，因为返回错误码意味着可能要马上进行处理</li><li>抽离try/catch块</li></ul><h1 id="注释"><a href="#注释" class="headerlink" title="注释"></a>注释</h1><ul><li>别给糟糕的代码加注释，重新写吧。</li><li>注释的恰当用法是弥补我们在用代码表达意图时遭遇的失败，注释总是一种失败。把力气用在写清楚代码上。</li></ul><h1 id="格式"><a href="#格式" class="headerlink" title="格式"></a>格式</h1><ul><li>关系密切的概念和代码应该互相靠近，便于阅读理解，如函数调用，调用者放在被调用者的上面。</li><li>变量声明应该靠近使用的位置</li><li>遵循一个编程规约，如阿里Java编程规约</li></ul><blockquote><p>声明：本站所有文章均为原创或翻译，遵循<a href="https://creativecommons.org/licenses/by-nc-nd/4.0/deed.en">署名 - 非商业性使用 - 禁止演绎 4.0 国际许可协议</a>，如需转载请确保您对该协议有足够了解，并附上作者名 (Tsukasa) 及原文地址</p></blockquote>]]></content>
    
    
    <summary type="html">&lt;script src=&quot;&#92;assets&#92;js&#92;APlayer.min.js&quot;&gt; &lt;/script&gt;&lt;p&gt;有时候业务交付压力使得开发人员只关注了交付本身，而忽略了质量，但作为一名研发人员，质量上是不能够作让步的。有些业务金融敏感，搞砸了很可能损害公司商业利益，自己也丢掉饭碗。因此，重申质量的重要性是很有必要的。&lt;/p&gt;</summary>
    
    
    
    <category term="编程开发" scheme="http://blog.tsukasa.moe/categories/%E7%BC%96%E7%A8%8B%E5%BC%80%E5%8F%91/"/>
    
    
    <category term="Clean Code" scheme="http://blog.tsukasa.moe/tags/Clean-Code/"/>
    
    <category term="重构" scheme="http://blog.tsukasa.moe/tags/%E9%87%8D%E6%9E%84/"/>
    
  </entry>
  
  <entry>
    <title>盘点Java项目中的线程池</title>
    <link href="http://blog.tsukasa.moe/2023/07/23/Anylysis-thread-pool-of-java-project/"/>
    <id>http://blog.tsukasa.moe/2023/07/23/Anylysis-thread-pool-of-java-project/</id>
    <published>2023-07-23T15:28:50.000Z</published>
    <updated>2023-07-24T16:34:44.983Z</updated>
    
    <content type="html"><![CDATA[<!-- excerpt --><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>这篇文章主要梳理下一个项目的各种线程池，以及这些线程池如何配合着完成工作，都实现了些什么功能。文章主要着眼于整体的线程池设计，可能涉及具体线程池的实现，但不会做太深入的讲解，目的是让自己对整体项目有个线程池视角的全局观。</p><h1 id="线程池基本概念"><a href="#线程池基本概念" class="headerlink" title="线程池基本概念"></a>线程池基本概念</h1><p><strong>线程池是什么</strong><br>进程是内存分配的基本单位，而线程是CPU调度的基本单位，线程池通过预先维护一定数量的线程，减少线程创建与销毁的开销，提升响应速度，便于管理系统资源。</p><p><strong>线程池解决的问题是什么</strong><br>线程池解决的核心问题是资源管理的问题。并发环境下，系统无法确定某个时刻，有多少任务需要执行，有多少资源需要投入，而系统的资源是有限的，这个不确定性会带来以下问题：</p><ul><li>频繁的创建、调度、销毁资源，会带来额外的消耗，降低响应速度；</li><li>资源无限制的申请可能导致系统资源被耗尽。</li></ul><p><strong>应用</strong></p><blockquote><ul><li>数据库连接池</li><li>Tomcat处理线程池</li></ul></blockquote><h1 id="项目线程池的视图和分类"><a href="#项目线程池的视图和分类" class="headerlink" title="项目线程池的视图和分类"></a>项目线程池的视图和分类</h1><p>项目</p><h2 id="Tomcat线程池"><a href="#Tomcat线程池" class="headerlink" title="Tomcat线程池"></a>Tomcat线程池</h2><h2 id="项目请求处理线程池"><a href="#项目请求处理线程池" class="headerlink" title="项目请求处理线程池"></a>项目请求处理线程池</h2><h2 id="定时任务线程池"><a href="#定时任务线程池" class="headerlink" title="定时任务线程池"></a>定时任务线程池</h2><h2 id="数据库客户端连接线程池"><a href="#数据库客户端连接线程池" class="headerlink" title="数据库客户端连接线程池"></a>数据库客户端连接线程池</h2><h2 id="数据库服务端连接池"><a href="#数据库服务端连接池" class="headerlink" title="数据库服务端连接池"></a>数据库服务端连接池</h2><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><blockquote><p>声明：本站所有文章均为原创或翻译，遵循<a href="https://creativecommons.org/licenses/by-nc-nd/4.0/deed.en">署名 - 非商业性使用 - 禁止演绎 4.0 国际许可协议</a>，如需转载请确保您对该协议有足够了解，并附上作者名 (Tsukasa) 及原文地址</p></blockquote>]]></content>
    
    
    <summary type="html">&lt;script src=&quot;&#92;assets&#92;js&#92;APlayer.min.js&quot;&gt; &lt;/script&gt;&lt;p&gt;这篇文章主要梳理下一个项目的各种线程池，以及这些线程池如何配合着完成工作，都实现了些什么功能。文章主要着眼于整体的线程池设计，可能涉及具体线程池的实现，但不会做太深入的讲解，目的是让自己对整体项目有个线程池视角的全局观。&lt;/p&gt;
&lt;p&gt;未完成。&lt;/p&gt;</summary>
    
    
    
    <category term="Java" scheme="http://blog.tsukasa.moe/categories/Java/"/>
    
    
    <category term="线程池" scheme="http://blog.tsukasa.moe/tags/%E7%BA%BF%E7%A8%8B%E6%B1%A0/"/>
    
  </entry>
  
  <entry>
    <title>Intellij IDEA个性化配置</title>
    <link href="http://blog.tsukasa.moe/2023/07/14/Intellij-IDEA-custom-configurations/"/>
    <id>http://blog.tsukasa.moe/2023/07/14/Intellij-IDEA-custom-configurations/</id>
    <published>2023-07-14T07:03:08.000Z</published>
    <updated>2023-10-11T17:08:50.778Z</updated>
    
    <content type="html"><![CDATA[<!-- excerpt --><p>文章记录我的Intellij IDEA配置，方便以后在新环境快速配置一个符合个人使用习惯的IDE</p><!-- toc --><h1 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h1><p>通常的IDEA的配置分为三种：当前项目的全局设置，项目或Module的单独设置，新建项目的设置。</p><ul><li>全局设置快捷键：<code>Ctrl+Alt+S</code></li><li>项目或者Module设置快捷键：<code>Ctrl+Shift+Alt+S</code></li><li>新建项目的设置：<code>File -&gt; New Project Setup -&gt; Setting for New Project...</code></li></ul><h1 id="JDK配置"><a href="#JDK配置" class="headerlink" title="JDK配置"></a>JDK配置</h1><p>通常Intellij IDEA也会内置有JDK或者JRE环境，为了便于管理，建议使用自己PC下载的JDK和JRE</p><h2 id="1、当前项目的全局设置"><a href="#1、当前项目的全局设置" class="headerlink" title="1、当前项目的全局设置"></a>1、当前项目的全局设置</h2><p>JDK Importer<br>配置Maven下载依赖默认的JDK，配置路径：<code>File | Settings | Build, Execution, Deployment | Build Tools | Maven | Importing</code></p><p><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202307142251679.png" alt=""></p><p>Java Compiler<br>Project bytecode version配置</p><p>配置路径：<code>File | Settings | Build, Execution, Deployment | Compiler | Java Compiler</code></p><p><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202307150206099.png" alt=""></p><p>Maven Runner<br>配置路径：<code>File | Settings | Build, Execution, Deployment | Build Tools | Maven | Runner</code></p><p><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202307142254340.png" alt=""></p><h2 id="2、项目或Module的单独设置"><a href="#2、项目或Module的单独设置" class="headerlink" title="2、项目或Module的单独设置"></a>2、项目或Module的单独设置</h2><p>Project</p><p><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202307150157308.png" alt=""></p><p>Modules：可以设置不同的Module使用不同的配置</p><p><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202307150158511.png" alt="Sources"><br><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202307150158870.png" alt="Dependencies"></p><p>SDKs：多版本JDK管理</p><p><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202307150201185.png" alt=""></p><h2 id="3、新建项目的设置"><a href="#3、新建项目的设置" class="headerlink" title="3、新建项目的设置"></a>3、新建项目的设置</h2><p>注意新建项目配置面板是通过<code>File -&gt; New Project Setup -&gt; Setting for New Project...</code>方式打开，下面的配置与全局的类似。</p><p>JDK Importer<br>配置路径：<code>File | Settings | Build, Execution, Deployment | Build Tools | Maven | Importing</code></p><p>Java Compiler<br>Project bytecode version配置</p><p>配置路径：<code>File | Settings | Build, Execution, Deployment | Compiler | Java Compiler</code></p><p>Maven Runner<br>配置路径：<code>File | Settings | Build, Execution, Deployment | Build Tools | Maven | Runner</code></p><h1 id="Maven配置"><a href="#Maven配置" class="headerlink" title="Maven配置"></a>Maven配置</h1><p>需要配置的地方：</p><ul><li>当前项目的全局设置</li><li>新建项目的设置</li></ul><p>配置路径：<code>File | Settings | Build, Execution, Deployment | Build Tools | Maven</code><br>设置Maven的home地址，修改Setting文件，以及Maven进行Jar包依赖下载时，可以设置<code>Thread Count</code>多线程方式加快下载速度.</p><p>可以输入CPU核心数2C或者线程数 8，根据PC性能设置即可。</p><p><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202307142253846.png" alt=""></p><h1 id="Gradle配置"><a href="#Gradle配置" class="headerlink" title="Gradle配置"></a>Gradle配置</h1><p>需要配置的地方：</p><ul><li>当前项目的全局设置</li><li>新建项目的设置</li></ul><p><code>File | Settings | Build, Execution, Deployment | Build Tools | Gradle</code>下配置Gradle的根目录</p><p><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202307150133582.png" alt=""></p><h1 id="设置字体"><a href="#设置字体" class="headerlink" title="设置字体"></a>设置字体</h1><p>需要配置的地方：</p><ul><li>当前项目的全局设置</li></ul><h2 id="1、软件界面字体设置"><a href="#1、软件界面字体设置" class="headerlink" title="1、软件界面字体设置"></a>1、软件界面字体设置</h2><p>设置界面字体大小<code>File | Settings | Appearance &amp; Behavior | Appearance</code>，勾选<code>Use custom font</code>，仅修改字体大小：16或14。</p><p><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202307142233356.png" alt=""></p><h2 id="2、代码文件字体设置"><a href="#2、代码文件字体设置" class="headerlink" title="2、代码文件字体设置"></a>2、代码文件字体设置</h2><p><code>File | Settings | Editor | Font</code>可以设置代码的字体类型、大小。</p><ul><li>字体类型：Consolas</li><li>字体大小：16，18均可</li></ul><p><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202307142218703.png" alt=""></p><p>通过鼠标滚动调节字体大小开关，根据需要打开。</p><p><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202307142245046.png" alt=""></p><h2 id="3、控制台字体设置"><a href="#3、控制台字体设置" class="headerlink" title="3、控制台字体设置"></a>3、控制台字体设置</h2><p><code>File | Settings | Editor | Color Scheme | Console Font</code>下设置，默认配置挺合适，根据需要调整。</p><p><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202307142242889.png" alt=""></p><h1 id="全局统一编码"><a href="#全局统一编码" class="headerlink" title="全局统一编码"></a>全局统一编码</h1><h2 id="1、项目文件编码配置"><a href="#1、项目文件编码配置" class="headerlink" title="1、项目文件编码配置"></a>1、项目文件编码配置</h2><p>需要配置的地方：</p><ul><li>当前项目的全局设置</li></ul><p>统一编码可以避免不必要的麻烦，将所有文件编码格式为UTF-8。<br>建议整个开发团队都勾选<code>Transparent-native-to-ascii</code>，否则properties文件中的中文将使用unicode编码进行展示。</p><p><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202307142103136.png" alt=""></p><h2 id="2、设置控制台文字编码"><a href="#2、设置控制台文字编码" class="headerlink" title="2、设置控制台文字编码"></a>2、设置控制台文字编码</h2><p><code>File | Settings | Editor | General | Console</code>设置控制台日志的字体编码，尽管这个设置非必须，但是建议保持统一。</p><p><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202307142239386.png" alt=""></p><h2 id="3、设置VM-Options编码"><a href="#3、设置VM-Options编码" class="headerlink" title="3、设置VM Options编码"></a>3、设置VM Options编码</h2><p>点击顶部菜单栏<code>Help-&gt;Edit Custom VM Options</code>，会打开下面的配置文件idea64.exe.vmoption<br><code>C:\Users\Tsukasa\AppData\Roaming\JetBrains\IdeaIC2023.1\idea64.exe.vmoptions</code></p><p>设置file.encoding为UTF-8：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-Dfile.encoding=UTF-8</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202307142127194.png" alt=""></p><h2 id="4、IDEA安装目录下的idea64-exe-vmoptions也要设置文件编码"><a href="#4、IDEA安装目录下的idea64-exe-vmoptions也要设置文件编码" class="headerlink" title="4、IDEA安装目录下的idea64.exe.vmoptions也要设置文件编码"></a>4、IDEA安装目录下的idea64.exe.vmoptions也要设置文件编码</h2><p>配置文件：<code>C:\Program Files\JetBrains\IntelliJ IDEA Community Edition 2023.1.4\bin</code>，添加编码配置：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-Dfile.encoding=UTF-8</span><br></pre></td></tr></table></figure><h2 id="5、设置Tomcat-VM-Options"><a href="#5、设置Tomcat-VM-Options" class="headerlink" title="5、设置Tomcat VM Options"></a>5、设置Tomcat VM Options</h2><p>如果用Tomcat方式启动项目，也需要设置编码。</p><p><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202307142208797.png" alt=""></p><h2 id="6、项目的-idea-encodings-xml文件中设置编码"><a href="#6、项目的-idea-encodings-xml文件中设置编码" class="headerlink" title="6、项目的.idea/encodings.xml文件中设置编码"></a>6、项目的.idea/encodings.xml文件中设置编码</h2><p>可以检查下文件是否有其他编码格式，结合实际项目情况再进行配置。<br><a href="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202307151024244.png">https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202307151024244.png</a><br><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202307150043883.png" alt=""></p><p>TIPS：IDEA中，在软件页面的右下角处，可以查看和设置当前打开文件的编码格式。</p><p><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202307150033237.png" alt=""></p><p>文件编码设置完成后，重启IDEA。</p><h1 id="其他配置"><a href="#其他配置" class="headerlink" title="其他配置"></a>其他配置</h1><h2 id="1、配置显示内存使用情况"><a href="#1、配置显示内存使用情况" class="headerlink" title="1、配置显示内存使用情况"></a>1、配置显示内存使用情况</h2><p><code>Shift+Shift</code>按键直接输入<code>Show memory indicator</code>，打开开关即可。</p><h2 id="2、设置背景图片"><a href="#2、设置背景图片" class="headerlink" title="2、设置背景图片"></a>2、设置背景图片</h2><p><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202307150138213.png" alt=""></p><h2 id="3、控制台shell更换为git-bash"><a href="#3、控制台shell更换为git-bash" class="headerlink" title="3、控制台shell更换为git bash"></a>3、控制台shell更换为git bash</h2><p>配置位置：<code>File | Settings | Tools | Terminal</code>，更换shell path。可以设置</p><p><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202307141513510.png" alt=""></p><h2 id="4、文件标签多行显示"><a href="#4、文件标签多行显示" class="headerlink" title="4、文件标签多行显示"></a>4、文件标签多行显示</h2><p>一般项目比较大，需要打开很多个标签，可以设置最多允许打开的TAB数，以及分行显示。如下图，取消勾选<code>Show tabs in one raw</code></p><p><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202307150019838.png" alt=""></p><h2 id="5、代码补全大小写不敏感"><a href="#5、代码补全大小写不敏感" class="headerlink" title="5、代码补全大小写不敏感"></a>5、代码补全大小写不敏感</h2><p><code>File | Settings | Editor | General | Code Completion</code>，设置代码补全大小写不敏感</p><p><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202307142052496.png" alt=""></p><h2 id="6、统一设置Copyright"><a href="#6、统一设置Copyright" class="headerlink" title="6、统一设置Copyright"></a>6、统一设置Copyright</h2><p>公司项目，统一在设置CopyRight，配置路径：<code>File | Settings | Editor | Copyright</code></p><h2 id="7-代码模板"><a href="#7-代码模板" class="headerlink" title="7.代码模板"></a>7.代码模板</h2><p>配置路径：<code>File | Settings | Editor | File and Code Templates</code></p><p><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202307151529295.png" alt=""></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@package</span>: $&#123;PACKAGE_NAME&#125;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>: Description message</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: $&#123;USER&#125;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span>: Created in $&#123;DATE&#125; $&#123;TIME&#125;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@copyright</span>: Copyright (c) $&#123;YEAR&#125;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span>: V1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@modified</span>: $&#123;USER&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure><h1 id="内存配置"><a href="#内存配置" class="headerlink" title="内存配置"></a>内存配置</h1><p>通常地，IDEA内存需要根据计算机配置、项目占用内存情况来调整JVM参数，达到性能最优的效果。一般打开项目时可以现在VisualVM中查看项目内存占用状况，适当做出调整。</p><p>VisualVM：用于Java应用的性能分析和调优，可以到<a href="https://visualvm.github.io/download.html">官网</a>下载。</p><p><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202307151545761.jpg" alt=""></p><p>配置文件：<br>32位系统，配置文件为IDEA安装目录的bin\idea.exe.vmoptions<br>64位系统，配置文件为IDEA安装目录的bin\idea64.exe.vmoptions</p><p>配置入口：</p><p>Maven的Runner配置</p><p><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202307151549498.png" alt=""></p><p>当前项目Run/Debug配置</p><p><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202307151551310.png" alt=""></p><p>涉及的JVM参数：</p><table><thead><tr><th>JVM参数</th><th style="text-align:left">说明</th></tr></thead><tbody><tr><td>Xms</td><td style="text-align:left">最小堆容量，初始化堆内存值</td></tr><tr><td>Xmx</td><td style="text-align:left">最大堆容量</td></tr><tr><td>XX:PermSize</td><td style="text-align:left">初始化的非堆内存</td></tr><tr><td>XX:MaxPermSize</td><td style="text-align:left">最大的非堆内存</td></tr></tbody></table><p>配置示例：</p><p>32位计算机的idea.exe.vmoptions配置示例：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-Xms200m</span><br><span class="line">-Xmx500m</span><br><span class="line">-XX:MaxPermSize=120m</span><br></pre></td></tr></table></figure><p>64位计算机的idea64.exe.vmoptions配置示例：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">-Xms128m</span><br><span class="line">-Xmx750m</span><br><span class="line">-XX:ReservedCodeCacheSize=240m</span><br><span class="line">-XX:+UseConcMarkSweepGC</span><br><span class="line">-XX:SoftRefLRUPolicyMSPerMB=<span class="number">50</span></span><br><span class="line">-ea</span><br><span class="line">-Dsun.io.useCanonCaches=<span class="literal">false</span></span><br><span class="line">-Djava.net.preferIPv4Stack=<span class="literal">true</span></span><br><span class="line">-XX:+HeapDumpOnOutOfMemoryError</span><br><span class="line">-XX:-OmitStackTraceInFastThrow</span><br></pre></td></tr></table></figure><h1 id="WGesture手势配置"><a href="#WGesture手势配置" class="headerlink" title="WGesture手势配置"></a>WGesture手势配置</h1><p><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202307142308902.png" alt=""></p><h1 id="常用插件"><a href="#常用插件" class="headerlink" title="常用插件"></a>常用插件</h1><p>安装插件路径：<code>File | Settings | Plugins</code></p><h2 id="常用插件列表"><a href="#常用插件列表" class="headerlink" title="常用插件列表"></a>常用插件列表</h2><table><thead><tr><th>名称</th><th style="text-align:left">描述</th><th style="text-align:left">地址</th></tr></thead><tbody><tr><td>MyBatisX</td><td style="text-align:left">Mybatis 增强工具包 - 只做增强不做改变，简化CRUD操作</td><td style="text-align:left"><a href="https://plugins.jetbrains.com/plugin/10119-mybatisx">https://plugins.jetbrains.com/plugin/10119-mybatisx</a></td></tr><tr><td>Maven Helper</td><td style="text-align:left">开源认证，做Jar包依赖分析很有用，右键项目集成一些Maven的快捷命令操作</td><td style="text-align:left"><a href="https://github.com/krasa/MavenHelper">https://github.com/krasa/MavenHelper</a></td></tr><tr><td>Key Promoter X</td><td style="text-align:left">快捷键学习神器</td><td style="text-align:left"><a href="https://github.com/halirutan/IntelliJ-Key-Promoter-X/blob/master/README.md">https://github.com/halirutan/IntelliJ-Key-Promoter-X/blob/master/README.md</a></td></tr><tr><td>Arthas</td><td style="text-align:left">帮助开发人员解决基于 Java 的应用程序生产环境中的问题，而无需修改代码或重新启动服务器</td><td style="text-align:left"><a href="https://www.yuque.com/arthas-idea-plugin">https://www.yuque.com/arthas-idea-plugin</a></td></tr><tr><td>Sequence Diagram</td><td style="text-align:left">生成序列图</td><td style="text-align:left"><a href="http://vanco.github.io/SequencePlugin/">http://vanco.github.io/SequencePlugin/</a></td></tr><tr><td>GenerateSerialVersionUID</td><td style="text-align:left">自动生成随机serialVersionUUD</td><td style="text-align:left"><a href="https://plugins.jetbrains.com/plugin/185-generateserialversionuid">https://plugins.jetbrains.com/plugin/185-generateserialversionuid</a></td></tr><tr><td>Translation</td><td style="text-align:left">集成了谷歌翻译、微软翻译、DeepL 翻译、有道翻译、百度翻译等众多翻译引擎，在你的 IDE 内随时对想要翻译的文本、代码注释、代码文档等进行翻译</td><td style="text-align:left"><a href="https://yiiguxing.github.io/TranslationPlugin/#/docs">https://yiiguxing.github.io/TranslationPlugin/#/docs</a></td></tr><tr><td>Rainbow Brackets</td><td style="text-align:left">括号和双标签上色</td><td style="text-align:left"><a href="https://plugins.jetbrains.com/plugin/10080-rainbow-brackets">https://plugins.jetbrains.com/plugin/10080-rainbow-brackets</a></td></tr><tr><td>Presentation Assistant</td><td style="text-align:left">演示必备插件，在屏幕上显示按下的快捷键</td><td style="text-align:left"><a href="https://plugins.jetbrains.com/plugin/7345-presentation-assistant">https://plugins.jetbrains.com/plugin/7345-presentation-assistant</a></td></tr><tr><td>Grep Console</td><td style="text-align:left">Grep、tail、过滤器、突出显示</td><td style="text-align:left"><a href="https://plugins.jetbrains.com/plugin/7125-grep-console">https://plugins.jetbrains.com/plugin/7125-grep-console</a></td></tr><tr><td>jclasslib Bytecode Viewer</td><td style="text-align:left">Java 类文件的字节码查看工具</td><td style="text-align:left"><a href="https://plugins.jetbrains.com/plugin/9248-jclasslib-bytecode-viewer">https://plugins.jetbrains.com/plugin/9248-jclasslib-bytecode-viewer</a></td></tr><tr><td>RestfulTool</td><td style="text-align:left">Restful服务开发的一套辅助工具</td><td style="text-align:left"><a href="https://plugins.jetbrains.com/plugin/14280-restfultool">https://plugins.jetbrains.com/plugin/14280-restfultool</a></td></tr><tr><td>LeetCode with labuladong</td><td style="text-align:left">刷题必备，基于LeetCode Editor开发的labuladong 的刷题全家桶</td><td style="text-align:left"><a href="https://plugins.jetbrains.com/plugin/19317-leetcode-with-labuladong">https://plugins.jetbrains.com/plugin/19317-leetcode-with-labuladong</a></td></tr><tr><td>String Manipulation</td><td style="text-align:left">大小写切换、排序、过滤、递增、对齐列、grepping、转义、编码等</td><td style="text-align:left"><a href="https://plugins.jetbrains.com/plugin/2162-string-manipulation">https://plugins.jetbrains.com/plugin/2162-string-manipulation</a></td></tr><tr><td>IDEA Mind Map</td><td style="text-align:left">阅读和编写思维导图</td><td style="text-align:left"><a href="https://plugins.jetbrains.com/plugin/8045-idea-mind-map">https://plugins.jetbrains.com/plugin/8045-idea-mind-map</a></td></tr><tr><td>CheckStyle-IDEA</td><td style="text-align:left">CheckStyle，统一代码风格</td><td style="text-align:left"><a href="https://plugins.jetbrains.com/plugin/1065-checkstyle-idea">https://plugins.jetbrains.com/plugin/1065-checkstyle-idea</a></td></tr><tr><td>CodeGlance Pro</td><td style="text-align:left">支持滚动条预览，方便找到代码片段</td><td style="text-align:left"><a href="https://plugins.jetbrains.com/plugin/18824-codeglance-pro">https://plugins.jetbrains.com/plugin/18824-codeglance-pro</a></td></tr><tr><td>JPA Buddy</td><td style="text-align:left">帮助开发人员在 Java 和 Kotlin 中高效地使用 Hibernate、EclipseLink、Spring Data JPA、Flyway、Liquibase、Lombok、MapStruct 以及其他相关技术</td><td style="text-align:left"><a href="https://plugins.jetbrains.com/plugin/15075-jpa-buddy">https://plugins.jetbrains.com/plugin/15075-jpa-buddy</a></td></tr><tr><td>One Dark</td><td style="text-align:left">一款暗黑主题</td><td style="text-align:left"><a href="https://github.com/atom/one-dark-syntax">https://github.com/atom/one-dark-syntax</a></td></tr><tr><td>Gerry Themes</td><td style="text-align:left">一款高分的主题，免费版提供10种配色方案</td><td style="text-align:left"><a href="https://plugins.jetbrains.com/plugin/18922-gerry-themes">https://plugins.jetbrains.com/plugin/18922-gerry-themes</a></td></tr><tr><td>.ignore</td><td style="text-align:left">提供.gitignore等等模板，推荐</td><td style="text-align:left"><a href="https://plugins.jetbrains.com/plugin/7495--ignore">https://plugins.jetbrains.com/plugin/7495--ignore</a></td></tr></tbody></table><p>上面插件根据需要安装和开启，避免过多占用内存和CPU，降低IDE响应效率。</p><h1 id="快捷键"><a href="#快捷键" class="headerlink" title="快捷键"></a>快捷键</h1><p>快捷键查找和设置路径：<code>File | Settings | Keymap</code></p><p><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202307150229472.png" alt=""></p><h2 id="自定义快捷键"><a href="#自定义快捷键" class="headerlink" title="自定义快捷键"></a>自定义快捷键</h2><table><thead><tr><th>快捷键</th><th style="text-align:left">功能</th><th style="text-align:left">功能描述</th></tr></thead><tbody><tr><td><code>Ctrl+Shift+\</code></td><td style="text-align:left">Select File in Project View</td><td style="text-align:left">在Project中快速定位到当前打开文件的所在路径</td></tr><tr><td><code>Ctrl+Shift+Alt+O</code></td><td style="text-align:left">Show in Explorer</td><td style="text-align:left">选中的文件在Windows文件浏览器中打开</td></tr></tbody></table><h2 id="查找与定位"><a href="#查找与定位" class="headerlink" title="查找与定位"></a>查找与定位</h2><table><thead><tr><th>快捷键</th><th style="text-align:left">描述</th></tr></thead><tbody><tr><td><code>Ctrl+Shift+F</code></td><td style="text-align:left">全局搜索</td></tr><tr><td><code>双击SHIFT</code></td><td style="text-align:left">在项目的所有目录查找文件，Search Everywhere</td></tr><tr><td><code>Ctrl+E</code></td><td style="text-align:left">最近打开的文件，结合输入可以很方便搜索类，配置文件等</td></tr><tr><td><code>Ctrl+G</code></td><td style="text-align:left">跳到自定义的行列位置</td></tr><tr><td><code>Ctrl+Alt+B</code></td><td style="text-align:left">跳转到实现类或实现方法</td></tr><tr><td><code>Ctrl+B</code></td><td style="text-align:left">跳转到接口类或者接口方法</td></tr><tr><td><code>Ctrl+N</code></td><td style="text-align:left">查找Class</td></tr><tr><td><code>Ctrl+Shift+Alt+N</code></td><td style="text-align:left">查找Symbol，如当前类下的方法、变量、常量等</td></tr><tr><td><code>Ctrl+Shift+A</code></td><td style="text-align:left">查找Action</td></tr><tr><td><code>F3</code></td><td style="text-align:left">Ctrl+F搜索时按F3为下一个，Shift+F3为向上一个</td></tr><tr><td><code>Ctrl+F12</code></td><td style="text-align:left">查看文件结构，在Class文件中输入快捷键则弹窗展示当前类的结构</td></tr><tr><td><code>Alt+F7</code></td><td style="text-align:left">查找代码中哪里有使用，Find Usage，选中查找结果F4进入源码</td></tr><tr><td><code>Ctrl+Shift+R</code></td><td style="text-align:left">项目所有文件的查找并替换，replace in path</td></tr><tr><td><code>Ctrl+R</code></td><td style="text-align:left">当前打开文件下查找并替换</td></tr><tr><td><code>Ctrl+H</code></td><td style="text-align:left">显示类结构图</td></tr><tr><td><code>Ctrl+Shift+N</code></td><td style="text-align:left">查找文件名</td></tr><tr><td><code>F11</code></td><td style="text-align:left">添加/删除书签</td></tr></tbody></table><h2 id="打开窗口"><a href="#打开窗口" class="headerlink" title="打开窗口"></a>打开窗口</h2><table><thead><tr><th>快捷键</th><th style="text-align:left">描述</th></tr></thead><tbody><tr><td><code>Shift+F11</code></td><td style="text-align:left">弹出bookmarks</td></tr><tr><td><code>Alt+F12</code></td><td style="text-align:left">打开Terminal控制台</td></tr><tr><td><code>Alt+1</code></td><td style="text-align:left">打开Project视图</td></tr><tr><td><code>Alt+2</code></td><td style="text-align:left">打开favorite</td></tr><tr><td><code>Alt+6</code></td><td style="text-align:left">打开Problem视图，可以查看Todo</td></tr><tr><td><code>Alt+7</code></td><td style="text-align:left">打开Structure视图</td></tr><tr><td><code>Alt+9</code></td><td style="text-align:left">打开版本控制视图Version Control</td></tr><tr><td><code>F4</code></td><td style="text-align:left">在Project窗口F4，即打开项目或者Module设置</td></tr><tr><td><code>Ctrl+Alt+S</code></td><td style="text-align:left">打开IDEA全局设置</td></tr><tr><td><code>Ctrl+Alt+Shift+S</code></td><td style="text-align:left">打开IDEA项目设置</td></tr></tbody></table><h2 id="重构"><a href="#重构" class="headerlink" title="重构"></a>重构</h2><table><thead><tr><th>快捷键</th><th style="text-align:left">描述</th></tr></thead><tbody><tr><td><code>Ctrl+Shift+T</code></td><td style="text-align:left">创建或者打开Test类或者方法</td></tr><tr><td><code>Ctrl+O</code></td><td style="text-align:left">重写方法</td></tr><tr><td><code>Ctrl+Alt+V</code></td><td style="text-align:left">提取变量，Introduce Variable</td></tr><tr><td><code>Ctrl+Alt+C</code></td><td style="text-align:left">提取常量，Introduce Constant</td></tr><tr><td><code>Ctrl+Alt+F</code></td><td style="text-align:left">提取属性，Introduce Field</td></tr><tr><td><code>Ctrl+F6</code></td><td style="text-align:left">修改方法签名（名称，参数，返回值，异常等）</td></tr><tr><td><code>Ctrl+Alt+Shift+P</code></td><td style="text-align:left">引入函数参数，Introduce Functional Parameter</td></tr><tr><td><code>Ctrl+Alt+M</code></td><td style="text-align:left">提取方法，Extract Method</td></tr><tr><td><code>Alt+Delete</code></td><td style="text-align:left">安全删除</td></tr><tr><td><code>Ctrl+Alt+N</code></td><td style="text-align:left">内联方法，Inline Method</td></tr></tbody></table><h2 id="编辑"><a href="#编辑" class="headerlink" title="编辑"></a>编辑</h2><table><thead><tr><th>快捷键</th><th style="text-align:left">描述</th></tr></thead><tbody><tr><td><code>Alt+Insert</code></td><td style="text-align:left">创建构造方法、Getter/Setter等</td></tr><tr><td><code>Ctrl+Y</code></td><td style="text-align:left">删除行</td></tr><tr><td><code>Ctrl+D</code></td><td style="text-align:left">duplicate line or Selection，往下复制一行</td></tr><tr><td><code>Ctrl+W</code></td><td style="text-align:left">逐渐扩大选择范围，加上Shift是逐渐扩小选择范围</td></tr><tr><td><code>Ctrl+P</code></td><td style="text-align:left">在调用的方法上面执行，显示方法参数</td></tr><tr><td><code>Ctrl+Enter</code></td><td style="text-align:left">当前位置右边另起一行</td></tr><tr><td><code>Shift+Enter</code></td><td style="text-align:left">另起一行</td></tr><tr><td><code>Alt+左/右</code></td><td style="text-align:left">左右切换TAB标签</td></tr><tr><td><code>Alt+上/下</code></td><td style="text-align:left">切换上一个/下一个方法</td></tr><tr><td><code>Alt+上/下</code></td><td style="text-align:left">切换上一个/下一个方法</td></tr><tr><td><code>Ctrl+上/下</code></td><td style="text-align:left">相当于鼠标滚轮</td></tr><tr><td><code>Ctrl+左/右</code></td><td style="text-align:left">往左/往右跳一个单词</td></tr><tr><td><code>Ctrl+Delete</code></td><td style="text-align:left">删除光标后面一个单词</td></tr><tr><td><code>Ctrl+Backspace</code></td><td style="text-align:left">删除光标前面一个单词</td></tr><tr><td><code>Shift+Home/End</code></td><td style="text-align:left">选中当前行光标左边的部分/右边的内容</td></tr><tr><td><code>Ctrl+/</code></td><td style="text-align:left">注释</td></tr><tr><td><code>Ctrl+Alt+左/右</code></td><td style="text-align:left">光标位置的前进与后退，阅读代码经常用到</td></tr><tr><td><code>Ctrl+Shift+E</code></td><td style="text-align:left">显示编辑过位置</td></tr><tr><td><code>Ctrl+Shift+V</code></td><td style="text-align:left">打开剪切板历史记录</td></tr><tr><td><code>Ctrl+Shift+Enter</code></td><td style="text-align:left">自动补全当前行，然后光标移动到最后</td></tr><tr><td><code>Ctrl+Alt+Enter</code></td><td style="text-align:left">向上空出一行</td></tr><tr><td><code>Ctrl+Shift+U</code></td><td style="text-align:left">大小写转换</td></tr><tr><td><code>Ctrl+Alt+T</code></td><td style="text-align:left">用if/while/try catch等代码块包裹，Surround with …</td></tr><tr><td><code>Shift+F6</code></td><td style="text-align:left">重命名文件/文件夹</td></tr><tr><td><code>Shift+TAB</code></td><td style="text-align:left">取消缩进</td></tr><tr><td><code>Ctrl+Shift+C</code></td><td style="text-align:left">复制文件/目录磁盘路径到剪贴板</td></tr><tr><td><code>Ctrl+Shift+V</code></td><td style="text-align:left">弹出剪贴板</td></tr><tr><td><code>Ctrl+Alt+Shift+左/右</code></td><td style="text-align:left">交换方法参数位置</td></tr><tr><td><code>Ctrl+[或]</code></td><td style="text-align:left">定位括号开始和结束</td></tr></tbody></table><h2 id="格式化代码"><a href="#格式化代码" class="headerlink" title="格式化代码"></a>格式化代码</h2><table><thead><tr><th>快捷键</th><th style="text-align:left">描述</th></tr></thead><tbody><tr><td><code>Ctrl+Alt+L</code></td><td style="text-align:left">格式化代码，可以在当前文件或包目录上执行</td></tr><tr><td><code>Ctrl+Alt+O</code></td><td style="text-align:left">优化导包</td></tr><tr><td><code>Ctrl+Alt+I</code></td><td style="text-align:left">光标所在行代码自动缩进</td></tr><tr><td><code>Ctrl+Alt+H</code></td><td style="text-align:left">调用层次，类内部使用</td></tr></tbody></table><h2 id="版本控制"><a href="#版本控制" class="headerlink" title="版本控制"></a>版本控制</h2><table><thead><tr><th>快捷键</th><th style="text-align:left">描述</th></tr></thead><tbody><tr><td><code>Shift+Alt+N</code></td><td style="text-align:left">新建一个task，比如当前打开了10个文件在做订单支付，我不想关闭这些文件，新建一个任务就好，下次切换到这个任务时10个文件也可以打开</td></tr><tr><td><code>Ctrl+K</code></td><td style="text-align:left">提交代码，打开Commit窗口</td></tr></tbody></table><h2 id="代码调试Debug"><a href="#代码调试Debug" class="headerlink" title="代码调试Debug"></a>代码调试Debug</h2><table><thead><tr><th>快捷键</th><th style="text-align:left">描述</th></tr></thead><tbody><tr><td><code>F7</code></td><td style="text-align:left">步进，当前断点行如果为方法，则进入方法体内，但不会进入该方法体内的方法</td></tr><tr><td><code>F8</code></td><td style="text-align:left">步进，当前断点行如果为方法，不会进入方法内</td></tr><tr><td><code>F9</code></td><td style="text-align:left">跳转到下一个断点</td></tr><tr><td><code>Shift+F7</code></td><td style="text-align:left">步入，断点所在行有多个方法调用，会弹出进入哪个方法</td></tr><tr><td><code>Shift+F8</code></td><td style="text-align:left">跳出，与F9效果相同</td></tr><tr><td><code>Shift+F9</code></td><td style="text-align:left">等效于工具栏的Debug按钮</td></tr><tr><td><code>Shift+F10</code></td><td style="text-align:left">等效于工具栏的Run按钮</td></tr><tr><td><code>Ctrl+Shift+F8</code></td><td style="text-align:left">打开所有断点设置窗口</td></tr></tbody></table><h2 id="其他快捷键"><a href="#其他快捷键" class="headerlink" title="其他快捷键"></a>其他快捷键</h2><table><thead><tr><th>快捷键</th><th style="text-align:left">描述</th></tr></thead><tbody><tr><td><code>Ctrl+Shift+F9</code></td><td style="text-align:left">编译选中的文件/包/Module</td></tr><tr><td><code>Ctrl+Shift+F12</code></td><td style="text-align:left">编辑器最大化</td></tr></tbody></table><h1 id="配置迁移"><a href="#配置迁移" class="headerlink" title="配置迁移"></a>配置迁移</h1><p>IDEA的配置文件idea.properties默认的config如下</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">idea.config.path=$&#123;user.home&#125;/.IntelliJIdea/config</span><br><span class="line">idea.plugins.path=$&#123;idea.config.path&#125;/plugins</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>方法一：直接拷贝</p><p>拷贝原来的Config和Plugin文件，重新指定下路径可以快速完成迁移。<br>本人的Intellij IDEA配置路径：<code>C:\Users\Tsukasa\AppData\Roaming\JetBrains\IdeaIC2023.1</code></p><p>方法二：通过<code>Export Settings...</code>功能导出配置</p><p><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202307262350302.png" alt=""></p><h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p><a href="https://shortcutworld.com/IntelliJ-IDEA/win/IntelliJ_Shortcuts">Intellij IDEA快捷键</a></p><blockquote><p>声明：本站所有文章均为原创或翻译，遵循<a href="https://creativecommons.org/licenses/by-nc-nd/4.0/deed.en">署名 - 非商业性使用 - 禁止演绎 4.0 国际许可协议</a>，如需转载请确保您对该协议有足够了解，并附上作者名 (Tsukasa) 及原文地址</p></blockquote>]]></content>
    
    
    <summary type="html">&lt;script src=&quot;&#92;assets&#92;js&#92;APlayer.min.js&quot;&gt; &lt;/script&gt;&lt;p&gt;文章记录我的Intellij IDEA配置，方便在新环境快速配置一个符合个人使用习惯的IDE&lt;/p&gt;</summary>
    
    
    
    <category term="编程开发" scheme="http://blog.tsukasa.moe/categories/%E7%BC%96%E7%A8%8B%E5%BC%80%E5%8F%91/"/>
    
    
    <category term="Intellij IDEA" scheme="http://blog.tsukasa.moe/tags/Intellij-IDEA/"/>
    
    <category term="环境配置" scheme="http://blog.tsukasa.moe/tags/%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/"/>
    
  </entry>
  
  <entry>
    <title>使用Github和PicGo搭建图床</title>
    <link href="http://blog.tsukasa.moe/2023/07/14/Use-Github-and-PicGo-to-integrate-picture-bed/"/>
    <id>http://blog.tsukasa.moe/2023/07/14/Use-Github-and-PicGo-to-integrate-picture-bed/</id>
    <published>2023-07-14T04:59:05.000Z</published>
    <updated>2023-07-24T16:07:47.935Z</updated>
    
    <content type="html"><![CDATA[<!-- excerpt --><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>本文记录自己使用Github和PicGo搭建图床，手机使用，以及一些个性化配置，方便在新环境重新搭建。</p><p>使用到的几个工具：</p><p>PicGo: 一个用于快速上传图片并获取图片 URL 链接的工具。<br>Github：在这里作为图床，用于存储图片<br>Flutter-PicGo: 一个用于快速上传图片并获取图片URL链接的手机版工具，这里用于手机<del>涩图</del>图片的保存<br>JSDeliver：一个用于开源项目的免费CDN，这里用于GitHub图床加速，非必须。</p><h1 id="搭建步骤"><a href="#搭建步骤" class="headerlink" title="搭建步骤"></a>搭建步骤</h1><p>大致分为3个步骤，具体可以参考官方文档和别人写的博客，很详细了不加赘述。</p><ul><li>Github创建图床仓库，生成并记录Access token</li><li>PicGo上配置GitHub的图床仓库，配置access token用于图床仓库的访问</li><li>Flutter-PicGo安装到手机上，扫描PicGo PC端生成的配置二维码完成手机端配置</li></ul><p>教程参考：</p><p><a href="https://picgo.github.io/PicGo-Doc/zh/guide/config.html#github%E5%9B%BE%E5%BA%8A">官方教程搭建GitHub图床</a><br><a href="https://zhuanlan.zhihu.com/p/347342082">如何利用 Github 搭建自己的免费图床？</a></p><p>搭建过程中如果不熟悉，可以不用一步到位，可以先默认，配置成功后在自定义，配置CDN加速。</p><h1 id="个性化配置"><a href="#个性化配置" class="headerlink" title="个性化配置"></a>个性化配置</h1><h2 id="PC端"><a href="#PC端" class="headerlink" title="PC端"></a>PC端</h2><h3 id="GitHub图床配置"><a href="#GitHub图床配置" class="headerlink" title="GitHub图床配置"></a>GitHub图床配置</h3><p>Gihub配置示例：</p><p><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/erocutewifes/202307141357926.png" alt=""></p><p>CDN加速地址：<code>https://cdn.jsdelivr.net/gh/&#123;GitHub帐户&#125;/&#123;图床仓库名&#125;</code><br><code>https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe</code></p><p>GitHub个人图床：<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/TsukasaMoe/PicturesOfTsukasaMoe.git</span><br><span class="line">git@github.com:TsukasaMoe/PicturesOfTsukasaMoe.git</span><br></pre></td></tr></table></figure></p><p>下面的是个人的配置，在上传图片之前选定对应的配置，这样就能够传到对应的目录下了。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;github&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">     <span class="attr">&quot;configList&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">       <span class="punctuation">&#123;</span></span><br><span class="line">         <span class="attr">&quot;_configName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;色气可爱的老婆们&quot;</span><span class="punctuation">,</span></span><br><span class="line">         <span class="attr">&quot;repo&quot;</span><span class="punctuation">:</span> <span class="string">&quot;TsukasaMoe/PicturesOfTsukasaMoe&quot;</span><span class="punctuation">,</span></span><br><span class="line">         <span class="attr">&quot;branch&quot;</span><span class="punctuation">:</span> <span class="string">&quot;main&quot;</span><span class="punctuation">,</span></span><br><span class="line">         <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Github生成的Access token，请替换&quot;</span><span class="punctuation">,</span></span><br><span class="line">         <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;erocutewifes/&quot;</span><span class="punctuation">,</span></span><br><span class="line">         <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;c3778d30-bc65-4836-8bf6-418b3eeea128&quot;</span><span class="punctuation">,</span></span><br><span class="line">         <span class="attr">&quot;_createdAt&quot;</span><span class="punctuation">:</span> <span class="number">1689265763160</span><span class="punctuation">,</span></span><br><span class="line">         <span class="attr">&quot;_updatedAt&quot;</span><span class="punctuation">:</span> <span class="number">1689266184223</span><span class="punctuation">,</span></span><br><span class="line">         <span class="attr">&quot;customUrl&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe&quot;</span></span><br><span class="line">       <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">       <span class="punctuation">&#123;</span></span><br><span class="line">         <span class="attr">&quot;_configName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;headers&quot;</span><span class="punctuation">,</span></span><br><span class="line">         <span class="attr">&quot;repo&quot;</span><span class="punctuation">:</span> <span class="string">&quot;TsukasaMoe/PicturesOfTsukasaMoe&quot;</span><span class="punctuation">,</span></span><br><span class="line">         <span class="attr">&quot;branch&quot;</span><span class="punctuation">:</span> <span class="string">&quot;main&quot;</span><span class="punctuation">,</span></span><br><span class="line">         <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Github生成的Access token，请替换&quot;</span><span class="punctuation">,</span></span><br><span class="line">         <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;headers/&quot;</span><span class="punctuation">,</span></span><br><span class="line">         <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ed98bed1-a665-45d9-a352-7c53d4b854f1&quot;</span><span class="punctuation">,</span></span><br><span class="line">         <span class="attr">&quot;_createdAt&quot;</span><span class="punctuation">:</span> <span class="number">1689268245274</span><span class="punctuation">,</span></span><br><span class="line">         <span class="attr">&quot;_updatedAt&quot;</span><span class="punctuation">:</span> <span class="number">1689268260929</span><span class="punctuation">,</span></span><br><span class="line">         <span class="attr">&quot;customUrl&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe&quot;</span></span><br><span class="line">       <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">       <span class="punctuation">&#123;</span></span><br><span class="line">         <span class="attr">&quot;_configName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;others&quot;</span><span class="punctuation">,</span></span><br><span class="line">         <span class="attr">&quot;repo&quot;</span><span class="punctuation">:</span> <span class="string">&quot;TsukasaMoe/PicturesOfTsukasaMoe&quot;</span><span class="punctuation">,</span></span><br><span class="line">         <span class="attr">&quot;branch&quot;</span><span class="punctuation">:</span> <span class="string">&quot;main&quot;</span><span class="punctuation">,</span></span><br><span class="line">         <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Github生成的Access token，请替换&quot;</span><span class="punctuation">,</span></span><br><span class="line">         <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/others&quot;</span><span class="punctuation">,</span></span><br><span class="line">         <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;a9181327-92e2-4d2a-b16f-89c5a216e87f&quot;</span><span class="punctuation">,</span></span><br><span class="line">         <span class="attr">&quot;_createdAt&quot;</span><span class="punctuation">:</span> <span class="number">1689268305137</span><span class="punctuation">,</span></span><br><span class="line">         <span class="attr">&quot;_updatedAt&quot;</span><span class="punctuation">:</span> <span class="number">1689268315947</span><span class="punctuation">,</span></span><br><span class="line">         <span class="attr">&quot;customUrl&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe&quot;</span></span><br><span class="line">       <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">       <span class="punctuation">&#123;</span></span><br><span class="line">         <span class="attr">&quot;_configName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;icons&quot;</span><span class="punctuation">,</span></span><br><span class="line">         <span class="attr">&quot;repo&quot;</span><span class="punctuation">:</span> <span class="string">&quot;TsukasaMoe/PicturesOfTsukasaMoe&quot;</span><span class="punctuation">,</span></span><br><span class="line">         <span class="attr">&quot;branch&quot;</span><span class="punctuation">:</span> <span class="string">&quot;main&quot;</span><span class="punctuation">,</span></span><br><span class="line">         <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Github生成的Access token，请替换&quot;</span><span class="punctuation">,</span></span><br><span class="line">         <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;icons/&quot;</span><span class="punctuation">,</span></span><br><span class="line">         <span class="attr">&quot;customUrl&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe&quot;</span><span class="punctuation">,</span></span><br><span class="line">         <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;648c75e8-020f-40c5-ac38-565e94eaa9bc&quot;</span><span class="punctuation">,</span></span><br><span class="line">         <span class="attr">&quot;_createdAt&quot;</span><span class="punctuation">:</span> <span class="number">1689268367750</span><span class="punctuation">,</span></span><br><span class="line">         <span class="attr">&quot;_updatedAt&quot;</span><span class="punctuation">:</span> <span class="number">1689268367750</span></span><br><span class="line">       <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">       <span class="punctuation">&#123;</span></span><br><span class="line">         <span class="attr">&quot;_configName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;tech&quot;</span><span class="punctuation">,</span></span><br><span class="line">         <span class="attr">&quot;customUrl&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe&quot;</span><span class="punctuation">,</span></span><br><span class="line">         <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;tech/&quot;</span><span class="punctuation">,</span></span><br><span class="line">         <span class="attr">&quot;repo&quot;</span><span class="punctuation">:</span> <span class="string">&quot;TsukasaMoe/PicturesOfTsukasaMoe&quot;</span><span class="punctuation">,</span></span><br><span class="line">         <span class="attr">&quot;branch&quot;</span><span class="punctuation">:</span> <span class="string">&quot;main&quot;</span><span class="punctuation">,</span></span><br><span class="line">         <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Github生成的Access token，请替换&quot;</span><span class="punctuation">,</span></span><br><span class="line">         <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;b39774a6-1015-4f88-8f51-102877a5282e&quot;</span><span class="punctuation">,</span></span><br><span class="line">         <span class="attr">&quot;_createdAt&quot;</span><span class="punctuation">:</span> <span class="number">1689303337162</span><span class="punctuation">,</span></span><br><span class="line">         <span class="attr">&quot;_updatedAt&quot;</span><span class="punctuation">:</span> <span class="number">1689303337162</span></span><br><span class="line">       <span class="punctuation">&#125;</span></span><br><span class="line">     <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">     <span class="attr">&quot;defaultId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;c3778d30-bc65-4836-8bf6-418b3eeea128&quot;</span></span><br><span class="line">   <span class="punctuation">&#125;</span></span><br><span class="line">   </span><br></pre></td></tr></table></figure><h3 id="PicGo配置"><a href="#PicGo配置" class="headerlink" title="PicGo配置"></a>PicGo配置</h3><p>PicGo配置文件地址：<code>%APPDATA%\picgo\data.json</code></p><p>PicGo客户端个性化配置：</p><ul><li>开机自启</li><li>时间戳重命名</li><li>Mini窗口置顶：悬浮球置顶，上传图片可以直接拖拽进去</li><li>上传后自动复制URL</li><li>选择显示图床只勾选使用的</li></ul><p><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202307141350496.png" alt="PicGo客户端个性化配置"></p><p>热键默认为Ctrl+Shift+P，可以重新设置</p><p><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202307141400277.png" alt="热键默认为Ctrl+Shift+P，可以重新设置"></p><h2 id="Android端"><a href="#Android端" class="headerlink" title="Android端"></a>Android端</h2><h3 id="图床设置-GitHub"><a href="#图床设置-GitHub" class="headerlink" title="图床设置 - GitHub"></a>图床设置 - GitHub</h3><p>打开图床配置二维码，或者将github图床配置信息导出填写好，通过<a href="https://cli.im/">草料</a>转换成二维码，APP中扫码配置即可。</p><p><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202307141412478.png" alt=""></p><h3 id="App内进行PicGo设置"><a href="#App内进行PicGo设置" class="headerlink" title="App内进行PicGo设置"></a>App内进行PicGo设置</h3><ul><li>设置时间戳重命名</li><li>仅删除本地图片：即删除图片时不会删除图床的照片。</li></ul><p>接下来就可以愉快的上传你喜欢的涩图啦w</p><p><img src="https://cdn.jsdelivr.net/gh/TsukasaMoe/PicturesOfTsukasaMoe/tech/202307141418757.jpg" alt=""></p><h1 id="使用心得"><a href="#使用心得" class="headerlink" title="使用心得"></a>使用心得</h1><p>快捷的上传方式</p><ul><li>做好个性化设置后，只要选中图片，或者剪切板复制了图片，又或者是复制了网上的图片链接，选好图床配置（上传到的图床目录），直接执行热键即可马上传输，传输完成后会自动复制上传好的图片地址到剪切板。</li><li>拖拽到图标、拖拽到图片上传区，或者传统的打开文件系统选择图片，都可以实现上传。</li></ul><p>相册管理页面：可以实现上传图片的预览，以及复制从PicGo PC端上传的图片，删除是仅将预览删除，不会删除远端图床的图片，如果想要删除，需要手动执行git命令删除，然后推送到远端。</p><p>手机端使用：通常手机内存有限，如果发现有好的涩图，需要保存起来可以暂时把GitHub图传作为一个中转站，当然建议定期复制图片到硬盘或同步到网盘更好。</p><p>注意：GitHub图床设置为公开，所以尽量不要上传带有个人隐私、安全等相关图片，避免泄露。</p><h1 id="References"><a href="#References" class="headerlink" title="References"></a>References</h1><p><a href="https://github.com/PicGo/PicGo-Core">PicGo项目的GitHub仓库</a><br><a href="https://github.com/PicGo/flutter-picgo">Flutter-PicGo手机app</a><br><a href="https://picgo.github.io/PicGo-Core-Doc/">PicGo插件开发指南</a><br><a href="https://github.com/PicGo/Awesome-PicGo">PicGo插件列表合集</a><br><a href="https://www.jsdelivr.com/?docs=gh">JSDeliver官网</a></p><blockquote><p>声明：本站所有文章均为原创或翻译，遵循<a href="https://creativecommons.org/licenses/by-nc-nd/4.0/deed.en">署名 - 非商业性使用 - 禁止演绎 4.0 国际许可协议</a>，如需转载请确保您对该协议有足够了解，并附上作者名 (Tsukasa) 及原文地址</p></blockquote>]]></content>
    
    
    <summary type="html">&lt;script src=&quot;&#92;assets&#92;js&#92;APlayer.min.js&quot;&gt; &lt;/script&gt;&lt;p&gt;本文记录自己使用Github和PicGo搭建图床，手机使用，以及一些个性化配置，方便在新环境重新搭建。&lt;/p&gt;</summary>
    
    
    
    <category term="图床" scheme="http://blog.tsukasa.moe/categories/%E5%9B%BE%E5%BA%8A/"/>
    
    
    <category term="GitHub" scheme="http://blog.tsukasa.moe/tags/GitHub/"/>
    
    <category term="PicGo" scheme="http://blog.tsukasa.moe/tags/PicGo/"/>
    
  </entry>
  
</feed>
